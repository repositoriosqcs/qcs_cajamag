
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.42">
    
    
      
        <title>cola_documentacion - Optimización CAJAMAG - Gobierno de Datos</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="#d89717" data-md-color-accent="light-blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cola_documentacion" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../.." title="Optimización CAJAMAG - Gobierno de Datos" class="md-header__button md-logo" aria-label="Optimización CAJAMAG - Gobierno de Datos" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Optimización CAJAMAG - Gobierno de Datos
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              cola_documentacion
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Buscar">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpiar" aria-label="Limpiar" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Optimización CAJAMAG - Gobierno de Datos" class="md-nav__button md-logo" aria-label="Optimización CAJAMAG - Gobierno de Datos" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Optimización CAJAMAG - Gobierno de Datos
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    INTRODUCCIÓN
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../instalacion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    INSTALACIÓN Y CONFIGURACIÓN
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../buenaspracticas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BUENAS PRACTICAS
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../codigo/funciones/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FUNCIONES
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    BODEGAS
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            BODEGAS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    1. Bodega 1
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            1. Bodega 1
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Bloque1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intoduccion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.1-DimDatosFijos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.1 DimDatosFijos
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.2-DimCalendarioMensual/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.2 DimCalendarioMensual
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.3-Dimensiones/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.3 Dimensiones
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.4-Dimensiones_xml/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.4 Dimensiones xml
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.5-FactDatosContacto/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.5 FactDatosContacto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.6-Fact_Historico_Afiliacion_Empresas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.6 Fact Historico Afiliacion Empresas
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.7-Fact_Historico_Trabajadores1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.7 Fact Historico Trabajadores1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.7-Fact_Historico_Trabajadores2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.7 Fact Historico Trabajadores2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.8-Fact_HistoricoBeneficiarios/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.8 Fact HistoricoBeneficiarios
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.9-Dim_Parametricas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.9 Dim Parametricas
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    2. Bodega 2
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            2. Bodega 2
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Bloque2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intoduccion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.1-FactAportesEmpAfiliadas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.1 FactAportesEmpAfiliadas
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.1-FactHistoricoAportesTotales/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.1 FactHistoricoAportesTotales
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.2-FactHistoricoCuota/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.2 FactHistoricoCuota
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.3-FactSubsidioVivienda/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.3 FactSubsidioVivienda
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.4-FactFosfec/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.4 FactFosfec
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.2-FactEstadoGiroCuota/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.2 FactEstadoGiroCuota
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.5-Fact_HistoricoMoraEmp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.5 Fact HistoricoMoraEmp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.6-FactHistoricoANS/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.6 FactHistoricoANS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.7-FactHistoricoSubPrescrito/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.7 FactHistoricoSubPrescrito
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.8-FactHistoricoRecobro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.8 FactHistoricoRecobro
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.9-FactHistoricoRecuperado/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.9 FactHistoricoRecuperado
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.10-FactIgestion_Mercurio/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.10 FactIgestion Mercurio
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    3. Bodega 3
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            3. Bodega 3
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Bloque3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intoduccion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3.1-FactTransaccionesVentas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3.1 FactTransaccionesVentas
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    4. Bodega 4
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            4. Bodega 4
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Bloque4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intoduccion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4.1-FactColegio_fijos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4.1 FactColegio fijos
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4.2-FactColegio/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4.2 FactColegio
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    5. Bodega 5
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            5. Bodega 5
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Bloque5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intoduccion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../5.1-FactServicioSocial_Fijos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5.1 FactServicioSocial Fijos
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../5.2-FactServicioSocial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5.2 FactServicioSocial
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    6. Bodega 6
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            6. Bodega 6
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Bloque6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intoduccion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../6.1-FactEncuestas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6.1 FactEncuestas
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../6.2-Fact_Encuesta_afil_empleador/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6.2 Fact Encuesta afil empleador
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="cola_documentacion">cola_documentacion<a class="headerlink" href="#cola_documentacion" title="Permanent link">&para;</a></h1>
<h1 id="13-dimensiones">1.3-Dimensiones<a class="headerlink" href="#13-dimensiones" title="Permanent link">&para;</a></h1>
<h1 id="13-dimensiones_1">1.3-Dimensiones<a class="headerlink" href="#13-dimensiones_1" title="Permanent link">&para;</a></h1>
<h1 id="13-dimensiones_2">1.3 Dimensiones<a class="headerlink" href="#13-dimensiones_2" title="Permanent link">&para;</a></h1>
<h2 id="intoduccion">Intoducción<a class="headerlink" href="#intoduccion" title="Permanent link">&para;</a></h2>
<p>Este proceso ETL (Extract, Transform, Load) tiene como objetivo consolidar y estructurar datos de diversas fuentes en tablas dimensionales para su almacenamiento en un Data Warehouse (DWH), facilitando el análisis y reporte posterior. Utilizando Python y SQL, el flujo ETL extrae datos de múltiples tablas de entrada provenientes de bases de datos como <code>subsidio</code>, <code>schoolkits</code>, <code>empresa</code>, y <code>xml4</code>, realizando transformaciones para estandarizar y mejorar la calidad de los datos. Cada tabla de entrada aporta información clave sobre personas, actividades económicas, zonas, sucursales y otros atributos necesarios para el análisis.</p>
<p>Las tablas de entrada incluyen <code>sat25</code>, que define el tipo de persona; <code>subsi04</code>, que contiene información de actividades económicas; y <code>subsi36</code>, que proporciona estados de inactivación y códigos de afiliación. También se usan <code>SK13</code> para zonas geográficas, <code>gener18</code> para códigos de documentos, <code>xml4c085</code> con información de sucursales de empresas, y <code>gener08</code> que ofrece datos de ciudades. Además, se utilizan tablas en el DWH, como <code>DimAuxEstadoAfiliacion</code> y <code>DimTipoVinculacion</code>, que proveen datos sobre estados de afiliación y tipos de calidad del aportante.</p>
<p>Las tablas resultantes se almacenan en el DWH bajo nombres descriptivos, tales como <code>BD_Dim_Tipo_Persona</code> para la estructura de tipos de personas, <code>BD_Dim_Actividad</code> para actividades económicas, <code>BD_Dim_Zona</code> para zonas geográficas, <code>BD_Dim_Empresas_Sucursales</code> para detalles de sucursales, y <code>BD_Dim_Ciudades</code> para la estandarización de datos de ciudades. Estas dimensiones permiten un análisis organizado de datos estructurados y categorizados para facilitar los reportes y métricas clave.</p>
<h2 id="etl">ETL<a class="headerlink" href="#etl" title="Permanent link">&para;</a></h2>
<h3 id="diagrama-de-secuencia-del-proceso-etl">Diagrama de Secuencia del Proceso ETL<a class="headerlink" href="#diagrama-de-secuencia-del-proceso-etl" title="Permanent link">&para;</a></h3>
<pre class="mermaid"><code>sequenceDiagram
  title Diagrama de Secuencia del Proceso ETL de Dimensiones
  autonumber
  participant 👤 Usuario
  participant Script as Script ETL
  participant DB as Bases de Datos
  participant DWH as Data Warehouse

  👤 Usuario-&gt;&gt;Script: Solicitar construcción de dimensiones
  Script-&gt;&gt;DB: Conectar y extraer datos de tablas de entrada &lt;br&gt; (e.g., sat25, subsi04, xml4c085, gener08)
  DB--&gt;&gt;Script: Retornar datos extraídos
  Script-&gt;&gt;Script: Transformar datos (limpieza, estandarización)
  Script-&gt;&gt;DWH: Cargar tablas de salida en DWH &lt;br&gt; (e.g., BD_Dim_Tipo_Persona, BD_Dim_Actividad, BD_Dim_Ciudades)
  DWH--&gt;&gt;Script: Confirmación de carga exitosa
  Script--&gt;&gt;👤 Usuario: Proceso ETL completado con éxito</code></pre>
<h3 id="importacion-de-librerias-y-funciones">Importación de librerías y funciones<a class="headerlink" href="#importacion-de-librerias-y-funciones" title="Permanent link">&para;</a></h3>
<p>Este bloque de código inicializa el entorno para la conexión y manipulación de datos con SQLAlchemy y Pandas, junto con <code>numpy</code> para el manejo de datos numéricos y <code>logging</code> para la generación de registros. Se configura el <code>sys.path</code> para importar funciones personalizadas desde un archivo externo (<code>Funciones.py</code>). Entre las funciones importadas se encuentran herramientas específicas para el flujo de datos como <code>log_tiempo</code>, <code>guardar_en_dwh</code>, <code>cargar_tablas</code>, y <code>StoreDuplicated</code>, así como utilidades para el procesamiento y estandarización de direcciones (<code>estandarizar_direccion</code>, <code>marcar_direcciones_estandarizadas</code>). El script ejecuta <code>testfunciones()</code> para verificar que las funciones importadas están listas para su uso, asegurando un flujo controlado y adecuado para el procesamiento y almacenamiento de datos.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="nn">sa</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="c1">#from datetime import date</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="c1">#from dateutil.relativedelta import relativedelta</span>

<span class="c1">#Import de modulo funciones</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Agrega el directorio al sys.path</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;../funciones&#39;</span><span class="p">))</span>
<span class="c1"># Importa las funciones desde el archivo Funciones.py</span>
<span class="kn">from</span> <span class="nn">Funciones</span> <span class="kn">import</span> <span class="n">log_tiempo</span><span class="p">,</span> <span class="n">guardar_en_dwh</span><span class="p">,</span> <span class="n">cargar_tablas</span><span class="p">,</span> <span class="n">StoreDuplicated</span><span class="p">,</span> <span class="n">obtener_conexion</span><span class="p">,</span> <span class="n">testfunciones</span><span class="p">,</span> <span class="n">setup_logger</span><span class="p">,</span><span class="n">estandarizar_direccion</span><span class="p">,</span><span class="n">marcar_direcciones_estandarizadas</span>
<span class="nb">print</span><span class="p">(</span><span class="n">testfunciones</span><span class="p">())</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>Importacion de funciones correcta, 30-10-2024 14:32
</code></pre></div>

<h3 id="configuracion-del-logger">Configuración del logger<a class="headerlink" href="#configuracion-del-logger" title="Permanent link">&para;</a></h3>
<p>Se configura el logger para registrar los eventos del proceso ETL en el archivo <code>Dimensiones.log</code> con el nivel de detalle <code>INFO</code>, e inicia el registro indicando el comienzo del proceso.</p>
<div class="highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="n">log_filename</span><span class="o">=</span><span class="s1">&#39;Dimensiones.log&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;COMIENZO ETL&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 14:32:29,302 - INFO - COMIENZO ETL
</code></pre></div>

<h3 id="consultas-sql-para-carga-de-datos-dimensionales-en-data-warehouse">Consultas SQL para Carga de Datos Dimensionales en Data Warehouse<a class="headerlink" href="#consultas-sql-para-carga-de-datos-dimensionales-en-data-warehouse" title="Permanent link">&para;</a></h3>
<p>Este código define una serie de consultas SQL en <code>qr_structure</code> que extraen datos desde diversas tablas relacionadas con subsidios y empresas. Cada consulta selecciona columnas relevantes y realiza uniones con otras tablas para enriquecer los datos:</p>
<ul>
<li><code>sat25</code>, <code>subsi04</code>, y <code>subsi36</code> extraen detalles de tipo de persona, actividad económica, y estados de inactivación de afiliados, respectivamente.</li>
<li><code>SK13</code> y <code>gener18</code> seleccionan información de zonas y códigos de documentos.</li>
<li><code>xml4c085</code> y <code>gener08</code> consolidan información sobre sucursales empresariales y ciudades.</li>
</ul>
<p>El diccionario <code>dim_names</code> asigna un nombre de tabla para cada consulta en el Data Warehouse, lo que facilita la organización y carga de estas tablas en <code>df_structure</code>.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Lista de querys</span>
<span class="n">qr_structure</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;sat25&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;select tipper as TIPPER, detalle as TIPO_PERSONA from subsidio.sat25&#39;&#39;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;subsi04&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;select codact as COD_ACTIVIDAD, detalle as ACTIVIDAD_ECONOMICA from subsidio.subsi04&#39;&#39;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;subsi36&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;select codest as COD_EST_INAC, detalle as ESTADO_INACTIVACION, tipo as ID_TIPO_AFILIADO, codsat as COD_SAT from subsidio.subsi36&#39;&#39;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;SK13&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;select CODIGOZONA as COD_ZONA, NOMBREZONA as ZONA from schoolkits.SK13&#39;&#39;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;gener18&quot;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;select coddoc as CODDOC, detdoc as TIPO_DOCUMENTO, codssf as COD_SUPERSUBSIDIO,codgia as COD_GIASS from empresa.gener18&#39;&#39;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;subsi02&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;select </span>
<span class="s1">        &#39;nit&#39; as &#39;NIT&#39;,</span>
<span class="s1">        &#39;digver&#39; as &#39;DIGITODEVERIFICACIONDENITDELAEMPRESA&#39;,</span>
<span class="s1">        &#39;tipper&#39; as &#39;INDICAELTIPODEPERSONA.N=NATURAL,J=JURÍDICA&#39;,</span>
<span class="s1">        &#39;coddoc&#39; as &#39;TIPODEDOCUMENTO&#39;,</span>
<span class="s1">        &#39;razsoc&#39; as &#39;RAZÓNSOCIALDELAEMPRESA&#39;,</span>
<span class="s1">        &#39;priape&#39; as &#39;PRIMERAPELLIDO.PARAPERSONASNATURALES.&#39;,</span>
<span class="s1">        &#39;segape&#39; as &#39;SEGUNDOAPELLIDO.PARAPERSONASNATURALES.&#39;,</span>
<span class="s1">        &#39;prinom&#39; as &#39;PRIMERNOMBRE.PARAPERSONASNATURALES.&#39;,</span>
<span class="s1">        &#39;segnom&#39; as &#39;SEGUNDONOMBRE.PARAPERSONASNATURALES.&#39;,</span>
<span class="s1">        &#39;sigla&#39; as &#39;SIGLAEMPRESA&#39;,</span>
<span class="s1">        &#39;nomcom&#39; as &#39;NOMBRECOMERCIAL&#39;,</span>
<span class="s1">        &#39;coddocreppri&#39; as &#39;CÓDIGODELDOCUMENTODELREPRESENTANTELEGALPRINCIPAL&#39;,</span>
<span class="s1">        &#39;cedrep&#39; as &#39;NÚMERODEDOCUMENTODEREPRESENTANTELEGALPRINCIPAL&#39;,</span>
<span class="s1">        &#39;repleg&#39; as &#39;NOMBREDELREPRESENTANTELEGALPRINCIPAL&#39;,</span>
<span class="s1">        &#39;coddocrepsup&#39; as &#39;CÓDIGODELDOCUMENTODELREPRESENTANTELEGALSUPLENTE&#39;,</span>
<span class="s1">        &#39;cedrepsup&#39; as &#39;NÚMERODEDOCUMENTODEREPRESENTANTELEGALSUPLENTE&#39;,</span>
<span class="s1">        &#39;replegsup&#39; as &#39;NOMBREDELREPRESENTANTELEGALSUPLENTE&#39;,</span>
<span class="s1">        &#39;jefper&#39; as &#39;NOMBREDELJEFEDEPERSONAL&#39;,</span>
<span class="s1">        &#39;direccion&#39; as &#39;DIRECCIONDEDELAEMPRESAENELFORMULARIODEREGISTRO&#39;,</span>
<span class="s1">        &#39;codciu&#39; as &#39;CÓDIGOCIIUDANE&#39;,</span>
<span class="s1">        &#39;codbar&#39; as &#39;CÓDIGODELBARRIO&#39;,</span>
<span class="s1">        &#39;celular&#39; as &#39;NÚMERODECELULARDECONTACTO&#39;,</span>
<span class="s1">        &#39;telefono&#39; as &#39;NÚMERODETELÉFONODECONTACTO&#39;,</span>
<span class="s1">        &#39;fax&#39; as &#39;NÚMERODEFAXDECONTACTO&#39;,</span>
<span class="s1">        &#39;email&#39; as &#39;CORREOELECTRÓNICODECONTACTO&#39;,</span>
<span class="s1">        &#39;codzon&#39; as &#39;CÓDIGODELAZONADELAEMPRESA&#39;        </span>
<span class="s1">        from subsidio.subsi02&#39;&#39;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;subsi15&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;select * from subsidio.subsi15&#39;&#39;&#39;</span><span class="p">,</span>    
    <span class="s2">&quot;xml4c085&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;select CONCAT(ID_AFILIADO, &quot;_&quot;, COD_SUCURSAL) as ID_SUCURSAL,</span>
<span class="s1">                    bf.*</span>
<span class="s1">                    from</span>
<span class="s1">                    (select </span>
<span class="s1">                    CONCAT(</span>
<span class="s1">                    CAST(</span>
<span class="s1">                    CASE </span>
<span class="s1">                    WHEN b.tipide = 1 THEN &#39;CC&#39;</span>
<span class="s1">                    WHEN b.tipide = 3 THEN &#39;RC&#39;</span>
<span class="s1">                    WHEN b.tipide = 4 THEN &#39;CE&#39;</span>
<span class="s1">                    WHEN b.tipide = 6 THEN &#39;PA&#39;</span>
<span class="s1">                    WHEN b.tipide = 7 THEN &#39;NI&#39;            </span>
<span class="s1">                    ELSE b.tipide</span>
<span class="s1">                    END AS CHAR</span>
<span class="s1">                    ),</span>
<span class="s1">                    b.nit</span>
<span class="s1">                    ) AS ID_AFILIADO,</span>
<span class="s1">                    b.nit as NIT_SUCURSAL,</span>
<span class="s1">                    c4.codsuc as COD_SUCURSAL,</span>
<span class="s1">                    c4.detalle as NOMBRE_SUCURSAL,</span>
<span class="s1">                    c4.direccion as DIRECCION_SUCURSAL,</span>
<span class="s1">                    c1.codciu as CODIGO_CIUDAD,</span>
<span class="s1">                    c4.telefono as TELEFONO_SUCURSAL,</span>
<span class="s1">                    c4.fax as FAX_SUCURSAL,</span>
<span class="s1">                    b.divpol as CODZON_SUCURSAL,</span>
<span class="s1">                    c4.ofiafi  as COD_OFICINA,</span>
<span class="s1">                    c4.nomcon as NOMBRE_CONTACTO,</span>
<span class="s1">                    c4.email as EMAIL_SUCURSAL,</span>
<span class="s1">                    c2.calsuc as COD_CALIDAD_SUCURSAL,</span>
<span class="s1">                    b.codact as COD_ACTIVIDAD,</span>
<span class="s1">                    c4.codind as COD_INDEPENDIENTES,</span>
<span class="s1">                    c4.traapo as TRABAJADORES_APORTANTES,</span>
<span class="s1">                    c4.valapo as VALOR_APORTES,</span>
<span class="s1">                    c4.actapr as ACTA_APROBACION,</span>
<span class="s1">                    c3.perafi as PERIODO_AFILIACION,</span>
<span class="s1">                    c4.fecmod as ULT_FECHA_AFILIACION,</span>
<span class="s1">                    IF(b.estado = 1, &quot;A&quot;, &quot;I&quot;) AS ESTADO_SUCURSAL,</span>
<span class="s1">                    c4.resest as FECHA_RESP_ESTADO,</span>
<span class="s1">                    c1.codest COD_ESTADO,</span>
<span class="s1">                    c1.fecest as FECHA_ESTADO,</span>
<span class="s1">                    c4.totapo as TOTAL_APORTES,</span>
<span class="s1">                    c4.observacion as OBSERVACIONES</span>
<span class="s1">                from xml4.xml4c085 as b</span>
<span class="s1">                left join </span>
<span class="s1">                    (select CONCAT(</span>
<span class="s1">                            CAST(</span>
<span class="s1">                            CASE </span>
<span class="s1">                            WHEN coddoc = &#39;CC&#39; THEN 1 </span>
<span class="s1">                            WHEN coddoc = &#39;CE&#39; THEN 4 </span>
<span class="s1">                            WHEN coddoc = &#39;NI&#39; THEN 7 </span>
<span class="s1">                            WHEN coddoc = &#39;PA&#39; THEN 6 </span>
<span class="s1">                            WHEN coddoc = &#39;RC&#39; THEN 3 </span>
<span class="s1">                            ELSE coddoc </span>
<span class="s1">                            END AS CHAR</span>
<span class="s1">                            ),</span>
<span class="s1">                            nit</span>
<span class="s1">                            ) AS cod, </span>
<span class="s1">                            codciu, </span>
<span class="s1">                            codest, </span>
<span class="s1">                            fecest</span>
<span class="s1">                    from subsidio.subsi02 group by cod) as c1</span>
<span class="s1">                on CONCAT(b.tipide, b.nit) = c1.cod </span>
<span class="s1">                left join subsidio.subsi48 as c2</span>
<span class="s1">                on b.nit = c2.nit</span>
<span class="s1">                left join </span>
<span class="s1">                    (select CONCAT( tipide , nit ) as cod, </span>
<span class="s1">                    MIN(periodo) as perafi</span>
<span class="s1">                    from xml4.xml4c085 </span>
<span class="s1">                    where estado=1 </span>
<span class="s1">                    group by tipide , nit) as c3</span>
<span class="s1">                on CONCAT(b.tipide, b.nit) = c3.cod</span>
<span class="s1">                left join subsidio.subsi48 as c4</span>
<span class="s1">                on b.nit = c4.nit</span>
<span class="s1">                group by b.tipide, b.nit) as bf&#39;&#39;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;gener08&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;SELECT * </span>
<span class="s1">                FROM empresa.gener08 as GER08</span>
<span class="s1">                INNER JOIN empresa.gener07 AS GER07 </span>
<span class="s1">                ON substring(GER08.codciu,1,2) COLLATE latin1_spanish_ci = GER07.coddep</span>
<span class="s1">                GROUP BY substring(GER08.codciu,1,2);        </span>
<span class="s1">                &#39;&#39;&#39;</span>
            <span class="p">}</span>
<span class="n">dim_names</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;sat25&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Dim_Tipo_Persona&#39;</span><span class="p">,</span>
    <span class="s2">&quot;subsi04&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Dim_Actividad&#39;</span><span class="p">,</span>
    <span class="s2">&quot;subsi36&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Dim_Estados_Inactivacion&#39;</span><span class="p">,</span>
    <span class="s2">&quot;SK13&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Dim_Zona&#39;</span><span class="p">,</span>
    <span class="s2">&quot;gener18&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Dim_Codigo_Documento&#39;</span><span class="p">,</span>
    <span class="s2">&quot;xml4c085&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Dim_Empresas_Sucursales&#39;</span><span class="p">,</span>
    <span class="s2">&quot;BD_Dim_Tipo_Afiliado&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Dim_Tipo_Afiliado&#39;</span><span class="p">,</span>
    <span class="s2">&quot;gener08&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Dim_Ciudades&#39;</span>
            <span class="p">}</span>
<span class="n">df_structure</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;LECTURA DE QUERYS&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 14:32:29,312 - INFO - LECTURA DE QUERYS
</code></pre></div>

<h3 id="conexion-y-carga-de-tablas-desde-sql">Conexión y carga de tablas desde SQL<a class="headerlink" href="#conexion-y-carga-de-tablas-desde-sql" title="Permanent link">&para;</a></h3>
<p>Este código se conecta a la base de datos Minerva y carga las tablas especificadas en <code>qr_structure</code> utilizando SQL. Para cada tabla, el proceso de carga es registrado en el <code>logger</code>, y al final se registra el tiempo total que tomó cargar todas las tablas desde MySQL. Esto permite monitorear la ejecución y duración del proceso de carga de datos.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Conexion a base Minerva</span>
<span class="n">motor</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">obtener_conexion</span><span class="p">(</span><span class="s1">&#39;minerva&#39;</span><span class="p">))</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CONEXION A BASE MINERVA&#39;</span><span class="p">)</span>
<span class="n">cargar_tablas</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="n">qr_structure</span><span class="p">,</span> <span class="n">df_structure</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 14:32:29,387 - INFO - CONEXION A BASE MINERVA
2024-10-30 14:32:29,722 - INFO - Cargando sat25 
2024-10-30 14:32:29,753 - INFO - Cargada sat25, 2 registros finales obtenidos. --- 0.03 seconds ---
2024-10-30 14:32:29,754 - INFO - Cargando subsi04 
2024-10-30 14:32:29,855 - INFO - Cargada subsi04, 526 registros finales obtenidos. --- 0.10 seconds ---
2024-10-30 14:32:29,855 - INFO - Cargando subsi36 
2024-10-30 14:32:29,883 - INFO - Cargada subsi36, 113 registros finales obtenidos. --- 0.03 seconds ---
2024-10-30 14:32:29,884 - INFO - Cargando SK13 
2024-10-30 14:32:29,913 - INFO - Cargada SK13, 31 registros finales obtenidos. --- 0.03 seconds ---
2024-10-30 14:32:29,914 - INFO - Cargando gener18 
2024-10-30 14:32:29,946 - INFO - Cargada gener18, 10 registros finales obtenidos. --- 0.03 seconds ---
2024-10-30 14:32:29,947 - INFO - Cargando subsi02 
2024-10-30 14:32:35,023 - INFO - Cargada subsi02, 33,088 registros finales obtenidos. --- 5.08 seconds ---
2024-10-30 14:32:35,024 - INFO - Cargando subsi15 
2024-10-30 14:34:11,558 - INFO - Cargada subsi15, 433,375 registros finales obtenidos. --- 1.61 minutes ---
2024-10-30 14:34:11,559 - INFO - Cargando xml4c085 
2024-10-30 14:34:30,461 - INFO - Cargada xml4c085, 20,638 registros finales obtenidos. --- 18.90 seconds ---
2024-10-30 14:34:30,462 - INFO - Cargando gener08 
2024-10-30 14:34:30,496 - INFO - Cargada gener08, 33 registros finales obtenidos. --- 0.03 seconds ---
2024-10-30 14:34:30,554 - INFO - CARGUE TABLAS DESDE MYSQL --- gener08 --- 2.02 minutes ---
</code></pre></div>

<h3 id="validador-de-campos-repetidos">Validador de campos repetidos<a class="headerlink" href="#validador-de-campos-repetidos" title="Permanent link">&para;</a></h3>
<p>Se valida la existencia de registros duplicados en cada una de las tablas cargadas en <code>df_structure</code>. Para ello, se excluye la columna <code>id</code> y se comparan las demás columnas. Los registros duplicados se almacenan usando la función <code>StoreDuplicated</code>, y posteriormente se eliminan los duplicados del dataframe. El proceso se registra en el log para cada tabla, junto con el tiempo total de ejecución del validador.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Validador de campos repetidos </span>
<span class="n">validador_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">ky</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_structure</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>   
    <span class="n">ColumnsToCompare</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;id&#39;</span> <span class="p">]</span> <span class="p">]</span>
    <span class="n">StoreDuplicated</span><span class="p">(</span><span class="s1">&#39;N/A&#39;</span> <span class="p">,</span> <span class="n">ColumnsToCompare</span><span class="p">,</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">],</span> <span class="sa">r</span><span class="s1">&#39;trazaDuplicados_&#39;</span> <span class="o">+</span> <span class="n">ky</span> <span class="p">)</span>
    <span class="c1">#Limpieza inicial quitar duplicados</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;VALIDADOR TABLA: &#39;</span><span class="o">+</span> <span class="n">ky</span><span class="p">)</span>
<span class="n">log_tiempo</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;VALIDADOR DUPLICADOS &#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">validador_time</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 14:34:30,576 - INFO - VALIDADOR TABLA: sat25
2024-10-30 14:34:30,585 - INFO - VALIDADOR TABLA: subsi04
2024-10-30 14:34:30,598 - INFO - VALIDADOR TABLA: subsi36
2024-10-30 14:34:30,609 - INFO - VALIDADOR TABLA: SK13
2024-10-30 14:34:30,620 - INFO - VALIDADOR TABLA: gener18
2024-10-30 14:34:31,274 - INFO - VALIDADOR TABLA: subsi02
2024-10-30 14:34:44,150 - INFO - VALIDADOR TABLA: subsi15
2024-10-30 14:34:44,416 - INFO - VALIDADOR TABLA: xml4c085
2024-10-30 14:34:44,427 - INFO - VALIDADOR TABLA: gener08
2024-10-30 14:34:44,428 - INFO - VALIDADOR DUPLICADOS  --- 13.87 seconds ---
</code></pre></div>

<h3 id="transformacion-de-datos">Transformación de datos<a class="headerlink" href="#transformacion-de-datos" title="Permanent link">&para;</a></h3>
<p>En esta fase, se realiza una limpieza de los datos en cada tabla de <code>df_structure</code>. Se transforman todas las columnas de tipo texto a mayúsculas, se eliminan los espacios en blanco al inicio y al final de los valores, y se reemplazan los valores <code>"NAN"</code> y <code>"NONE"</code> por valores nulos (<code>NaN</code>). El tiempo total del proceso de limpieza se registra en el log.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Transformación 2</span>
<span class="n">limpieza_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">ky</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_structure</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="c1">#print(ky)</span>
    <span class="c1">#Pasar las columnas tipo texto a UPPER</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="c1">#En las columnas tipo texto, eliminar espacios al comienzo y al final</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="c1">#Reemplazar los &quot;NAN&quot; o &quot;NONE&quot; por NaN</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;NAN&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;NONE&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;LIMPIEZA --- </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">limpieza_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> seconds ---&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 14:35:42,956 - INFO - LIMPIEZA --- 58.51 seconds ---
</code></pre></div>

<h3 id="creacion-de-tabla-de-dimension-de-tipos-de-afiliados">Creación de Tabla de Dimensión de Tipos de Afiliados<a class="headerlink" href="#creacion-de-tabla-de-dimension-de-tipos-de-afiliados" title="Permanent link">&para;</a></h3>
<p>Este código crea una tabla de dimensión en <code>df_structure</code> llamada <code>BD_Dim_Tipo_Afiliado</code>, que contiene los tipos únicos de afiliados obtenidos de la columna <code>ID_TIPO_AFILIADO</code> en <code>subsi36</code>. Para cada tipo de afiliado único, asigna un <code>ID_REGISTRO</code> numerado y mapea el valor a una descripción (<code>Trabajadores</code>, <code>Beneficiarios</code>, <code>Empresas</code>) mediante un diccionario.</p>
<p>Las columnas se ordenan como <code>ID_REGISTRO</code>, <code>ID_TIPO_AFILIADO</code> y <code>TIPO_AFILIADO</code> para mejorar la organización. Esta tabla de dimensión proporciona una referencia estandarizada de los tipos de afiliados para el Data Warehouse.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Obtener la tabla original desde df_structure</span>
<span class="n">tabla</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="s1">&#39;subsi36&#39;</span><span class="p">]</span>

<span class="c1"># Obtener los valores únicos de la columna &#39;TIPO&#39;</span>
<span class="n">valores_unicos</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tabla</span><span class="p">[</span><span class="s1">&#39;ID_TIPO_AFILIADO&#39;</span><span class="p">])</span>

<span class="c1"># Crear un DataFrame a partir de los valores únicos con la columna renombrada</span>
<span class="n">df_valores_unicos</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">valores_unicos</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ID_TIPO_AFILIADO&#39;</span><span class="p">])</span>

<span class="c1"># Agregar manualmente una columna numerada como &#39;index&#39;</span>
<span class="n">df_valores_unicos</span><span class="p">[</span><span class="s1">&#39;ID_REGISTRO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_valores_unicos</span><span class="p">))</span>

<span class="c1"># Agregar manualmente el tipo de afiliado</span>
<span class="n">tipo_afiliado</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span><span class="s1">&#39;Trabajadores&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="s1">&#39;Beneficiarios&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span><span class="s1">&#39;Empresas&#39;</span><span class="p">}</span>
<span class="n">df_valores_unicos</span><span class="p">[</span><span class="s1">&#39;TIPO_AFILIADO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_valores_unicos</span><span class="p">[</span><span class="s1">&#39;ID_TIPO_AFILIADO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">tipo_afiliado</span><span class="p">)</span>

<span class="c1"># Ordenar columnas</span>
<span class="n">columnas_orden</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ID_REGISTRO&#39;</span><span class="p">,</span><span class="s1">&#39;ID_TIPO_AFILIADO&#39;</span><span class="p">,</span> <span class="s1">&#39;TIPO_AFILIADO&#39;</span><span class="p">]</span>
<span class="n">df_valores_unicos</span> <span class="o">=</span> <span class="n">df_valores_unicos</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columnas_orden</span><span class="p">)</span>

<span class="c1"># Agregar el DataFrame &#39;df_valores_unicos&#39; a &#39;df_structure&#39; con una nueva clave</span>
<span class="n">df_structure</span><span class="p">[</span><span class="s1">&#39;BD_Dim_Tipo_Afiliado&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_valores_unicos</span>
<span class="n">df_structure</span><span class="p">[</span><span class="s1">&#39;BD_Dim_Tipo_Afiliado&#39;</span><span class="p">]</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID_REGISTRO</th>
      <th>ID_TIPO_AFILIADO</th>
      <th>TIPO_AFILIADO</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>T</td>
      <td>Trabajadores</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>B</td>
      <td>Beneficiarios</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>E</td>
      <td>Empresas</td>
    </tr>
  </tbody>
</table>
</div>

<h3 id="renombrado-de-columnas-en-la-tabla-gener08">Renombrado de Columnas en la Tabla <code>gener08</code><a class="headerlink" href="#renombrado-de-columnas-en-la-tabla-gener08" title="Permanent link">&para;</a></h3>
<p>Este código actualiza los nombres de columnas en el DataFrame <code>gener08</code> dentro de <code>df_structure</code> para mejorar la claridad y consistencia de los datos. Las columnas <code>codciu</code>, <code>detciu</code>, y <code>clarur</code> se renombraron a <code>CODIGO_CIUDAD</code>, <code>NOMBRE_CIUDAD</code>, y <code>TIPO_ZONA</code>, respectivamente. Esto facilita la identificación de cada campo en <code>gener08</code>, estandarizando su nomenclatura antes de realizar análisis o cargar los datos en el Data Warehouse.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Cambiar nombre de la columna</span>
<span class="n">df_structure</span><span class="p">[</span><span class="s1">&#39;gener08&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&#39;codciu&#39;</span><span class="p">:</span> <span class="s1">&#39;CODIGO_CIUDAD&#39;</span><span class="p">,</span>
    <span class="s1">&#39;detciu&#39;</span><span class="p">:</span> <span class="s1">&#39;NOMBRE_CIUDAD&#39;</span><span class="p">,</span>
    <span class="s1">&#39;clarur&#39;</span><span class="p">:</span> <span class="s1">&#39;TIPO_ZONA&#39;</span>
    <span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<h3 id="consultas-para-dimensiones-de-estado-de-afiliacion-y-calidad-de-aportante-en-dwh">Consultas para Dimensiones de Estado de Afiliación y Calidad de Aportante en DWH<a class="headerlink" href="#consultas-para-dimensiones-de-estado-de-afiliacion-y-calidad-de-aportante-en-dwh" title="Permanent link">&para;</a></h3>
<p>Este código define consultas en <code>qr_structure_dwh</code> para cargar datos de dos dimensiones en el Data Warehouse: <code>DimAuxEstadoAfiliacion</code> y <code>DimTipoVinculacion</code>. Estas consultas extraen los estados de afiliación (<code>COD_EST_AFIL</code> y <code>ESTADO_AFILIACION</code>) y las categorías de calidad del aportante (<code>COD_CALIDAD_SUCURSAL</code>, <code>CALIDAD_APORTANTE_1</code>, <code>CALIDAD_APORTANTE_2</code>, <code>CALIDAD_APORTANTE_SUBSI15</code>). Cada consulta se guarda en <code>df_structure_dwh</code> bajo nombres específicos definidos en <code>dim_names_dwh</code>, que facilita su identificación en el DWH.</p>
<p>La conexión a la base de datos DWH se establece usando <code>motor_dwh</code>, y las tablas se cargan mediante <code>cargar_tablas</code>, permitiendo integrar estas dimensiones clave para análisis posteriores.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Lista de querys DWH</span>
<span class="n">qr_structure_dwh</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;DimAuxEstadoAfiliacion&quot;</span> <span class="p">:</span> <span class="s1">&#39;&#39;&#39;select </span>
<span class="s1">        estado_old as COD_EST_AFIL, </span>
<span class="s1">        estado_new as ESTADO_AFILIACION</span>
<span class="s1">        from dwh.gb_DimAuxEstadoAfiliacion&#39;&#39;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;DimTipoVinculacion&quot;</span> <span class="p">:</span> <span class="s1">&#39;&#39;&#39;select </span>
<span class="s1">        Tipo as COD_CALIDAD_SUCURSAL,</span>
<span class="s1">        Agrupador1 as CALIDAD_APORTANTE_1,</span>
<span class="s1">        Agrupador2 as CALIDAD_APORTANTE_2,</span>
<span class="s1">        AgrupadorSubsi15 as CALIDAD_APORTANTE_SUBSI15</span>
<span class="s1">        from dwh.gb_DimTipoVinculacion&#39;&#39;&#39;</span>
<span class="p">}</span>

<span class="n">dim_names_dwh</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;DimAuxEstadoAfiliacion&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Dim_Estados_Afiliacion&#39;</span><span class="p">,</span>
    <span class="s2">&quot;DimTipoVinculacion&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Dim_Calidad_Aportante&#39;</span>
<span class="p">}</span>
<span class="n">df_structure_dwh</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;LECTURA DE QUERYS DWH&#39;</span><span class="p">)</span>

<span class="c1">#Conexion a base DWH</span>
<span class="n">motor_dwh</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">obtener_conexion</span><span class="p">(</span><span class="s1">&#39;dwh&#39;</span><span class="p">))</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CONEXION A BASE DWH&#39;</span><span class="p">)</span>
<span class="n">cargar_tablas</span><span class="p">(</span><span class="n">motor_dwh</span><span class="p">,</span> <span class="n">qr_structure_dwh</span><span class="p">,</span> <span class="n">df_structure_dwh</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 14:35:43,014 - INFO - LECTURA DE QUERYS DWH
2024-10-30 14:35:43,017 - INFO - CONEXION A BASE DWH
2024-10-30 14:35:43,319 - INFO - Cargando DimAuxEstadoAfiliacion 
2024-10-30 14:35:43,346 - INFO - Cargada DimAuxEstadoAfiliacion, 4 registros finales obtenidos. --- 0.03 seconds ---
2024-10-30 14:35:43,348 - INFO - Cargando DimTipoVinculacion 
2024-10-30 14:35:43,378 - INFO - Cargada DimTipoVinculacion, 11 registros finales obtenidos. --- 0.03 seconds ---
2024-10-30 14:35:43,429 - INFO - CARGUE TABLAS DESDE MYSQL --- DimTipoVinculacion --- 0.41 seconds ---
</code></pre></div>

<h3 id="estandarizacion-y-reorganizacion-de-direcciones-en-sucursales">Estandarización y Reorganización de Direcciones en Sucursales<a class="headerlink" href="#estandarizacion-y-reorganizacion-de-direcciones-en-sucursales" title="Permanent link">&para;</a></h3>
<p>Este código realiza una limpieza y estandarización de las direcciones en <code>df_sucursales</code> (cargado desde <code>df_structure['xml4c085']</code>), que contiene datos de sucursales de empresas. Primero, renombra <code>DIRECCION_SUCURSAL</code> a <code>DIRECCION_ORIGINAL</code> y asegura que sea de tipo texto. Luego, aplica <code>estandarizar_direccion</code> para generar una columna <code>DIRECCION_LIMPIA</code> con una versión normalizada de las direcciones.</p>
<p>La función <code>marcar_direcciones_estandarizadas</code> verifica si <code>DIRECCION_LIMPIA</code> comienza con ciertas abreviaturas estandarizadas, añadiendo una columna <code>DIRECCION_ESTANDARIZADA</code> donde esto se cumple. Después, se reorganizan las columnas en el orden especificado para mejorar la organización del DataFrame.</p>
<p>Finalmente, se eliminan los registros donde <code>ID_SUCURSAL</code> es nulo, manteniendo solo las filas con un identificador de sucursal válido. La tabla <code>df_structure['xml4c085']</code> se actualiza con el DataFrame modificado.</p>
<div class="highlight"><pre><span></span><code><span class="n">df_sucursales</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="s1">&#39;xml4c085&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Asegurarse de que la columna DIRECCION_ORIGINAL es de tipo texto</span>
<span class="n">df_sucursales</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;DIRECCION_SUCURSAL&#39;</span><span class="p">:</span><span class="s1">&#39;DIRECCION_ORIGINAL&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_sucursales</span><span class="p">[</span><span class="s1">&#39;DIRECCION_ORIGINAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_sucursales</span><span class="p">[</span><span class="s1">&#39;DIRECCION_ORIGINAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="c1"># Aplicamos la estandarización a todas las direcciones y creamos una nueva columna con las direcciones estandarizadas</span>

<span class="n">df_sucursales</span><span class="p">[</span><span class="s1">&#39;DIRECCION_LIMPIA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_sucursales</span><span class="p">[</span><span class="s1">&#39;DIRECCION_ORIGINAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">estandarizar_direccion</span><span class="p">)</span>

<span class="c1"># Agregar columna &#39;DIRECCION_ESTANDARIZADA&#39; si la direccion empieza con algunas de las abreviaturas estandarizadas</span>
<span class="n">marcar_direcciones_estandarizadas</span><span class="p">(</span><span class="n">df_sucursales</span><span class="p">,</span> <span class="s1">&#39;DIRECCION_LIMPIA&#39;</span><span class="p">)</span>

<span class="c1"># Reordenamos las columnas</span>

<span class="n">columnas_sucursales</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ID_SUCURSAL&#39;</span><span class="p">,</span> <span class="s1">&#39;ID_AFILIADO&#39;</span><span class="p">,</span> <span class="s1">&#39;NIT_SUCURSAL&#39;</span><span class="p">,</span> <span class="s1">&#39;COD_SUCURSAL&#39;</span><span class="p">,</span>
       <span class="s1">&#39;NOMBRE_SUCURSAL&#39;</span><span class="p">,</span> <span class="s1">&#39;DIRECCION_ORIGINAL&#39;</span><span class="p">,</span> <span class="s1">&#39;DIRECCION_LIMPIA&#39;</span><span class="p">,</span><span class="s1">&#39;DIRECCION_ESTANDARIZADA&#39;</span><span class="p">,</span> <span class="s1">&#39;COD_CIU&#39;</span><span class="p">,</span> <span class="s1">&#39;TELEFONO_SUCURSAL&#39;</span><span class="p">,</span>
       <span class="s1">&#39;FAX_SUCURSAL&#39;</span><span class="p">,</span> <span class="s1">&#39;CODZON_SUCURSAL&#39;</span><span class="p">,</span> <span class="s1">&#39;COD_OFICINA&#39;</span><span class="p">,</span> <span class="s1">&#39;NOMBRE_CONTACTO&#39;</span><span class="p">,</span><span class="s1">&#39;EMAIL_SUCURSAL&#39;</span><span class="p">,</span> <span class="s1">&#39;COD_CALIDAD_SUCURSAL&#39;</span><span class="p">,</span> <span class="s1">&#39;COD_ACTIVIDAD&#39;</span><span class="p">,</span>
       <span class="s1">&#39;COD_INDEPENDIENTES&#39;</span><span class="p">,</span> <span class="s1">&#39;TRABAJADORES_APORTANTES&#39;</span><span class="p">,</span> <span class="s1">&#39;VALOR_APORTES&#39;</span><span class="p">,</span><span class="s1">&#39;ACTA_APROBACION&#39;</span><span class="p">,</span> <span class="s1">&#39;PERIODO_AFILIACION&#39;</span><span class="p">,</span> <span class="s1">&#39;ULT_FECHA_AFILIACION&#39;</span><span class="p">,</span>
       <span class="s1">&#39;ESTADO_SUCURSAL&#39;</span><span class="p">,</span> <span class="s1">&#39;FECHA_RESP_ESTADO&#39;</span><span class="p">,</span> <span class="s1">&#39;COD_ESTADO&#39;</span><span class="p">,</span> <span class="s1">&#39;FECHA_ESTADO&#39;</span><span class="p">,</span><span class="s1">&#39;TOTAL_APORTES&#39;</span><span class="p">,</span> <span class="s1">&#39;OBSERVACIONES&#39;</span><span class="p">]</span>
<span class="n">df_sucursales</span> <span class="o">=</span> <span class="n">df_sucursales</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columnas_sucursales</span><span class="p">)</span>

<span class="c1"># Eliminar registros donde ID_SUCURSAL es nulo</span>
<span class="n">df_sucursales</span> <span class="o">=</span> <span class="n">df_sucursales</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ID_SUCURSAL&#39;</span><span class="p">])</span>

<span class="n">df_structure</span><span class="p">[</span><span class="s1">&#39;xml4c085&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_sucursales</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_structure</span><span class="p">[</span><span class="s1">&#39;xml4c085&#39;</span><span class="p">]</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID_SUCURSAL</th>
      <th>ID_AFILIADO</th>
      <th>NIT_SUCURSAL</th>
      <th>COD_SUCURSAL</th>
      <th>NOMBRE_SUCURSAL</th>
      <th>DIRECCION_ORIGINAL</th>
      <th>DIRECCION_LIMPIA</th>
      <th>DIRECCION_ESTANDARIZADA</th>
      <th>COD_CIU</th>
      <th>TELEFONO_SUCURSAL</th>
      <th>...</th>
      <th>VALOR_APORTES</th>
      <th>ACTA_APROBACION</th>
      <th>PERIODO_AFILIACION</th>
      <th>ULT_FECHA_AFILIACION</th>
      <th>ESTADO_SUCURSAL</th>
      <th>FECHA_RESP_ESTADO</th>
      <th>COD_ESTADO</th>
      <th>FECHA_ESTADO</th>
      <th>TOTAL_APORTES</th>
      <th>OBSERVACIONES</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>CC1000063770_001</td>
      <td>CC1000063770</td>
      <td>1000063770</td>
      <td>001</td>
      <td>PALOMO JIMENEZ DANIEL DAVID</td>
      <td>MZ K1 CS 14  CONCEPCION</td>
      <td>MZ K1 CS 14 CONCEPCION</td>
      <td>Si</td>
      <td>NaN</td>
      <td>6054333300</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>202310</td>
      <td>NaN</td>
      <td>A</td>
      <td>NaN</td>
      <td>53</td>
      <td>2023-11-30</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>CC1000521027_001</td>
      <td>CC1000521027</td>
      <td>1000521027</td>
      <td>001</td>
      <td>CARDONA BIJALBA JESUS ALFONSO</td>
      <td>KM 38 LT 4  VRDA EMNDIHUACA  CARRERA TRONCAL D...</td>
      <td>KM 38 LT 4 VRDA EMNDIHUACA CR TRONCAL DEL CARIBE</td>
      <td>Si</td>
      <td>NaN</td>
      <td>3165233112</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>202309</td>
      <td>NaN</td>
      <td>A</td>
      <td>NaN</td>
      <td>53</td>
      <td>2024-01-30</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>CC1000697509_001</td>
      <td>CC1000697509</td>
      <td>1000697509</td>
      <td>001</td>
      <td>VELEZ HERNANDEZ NICOLAS</td>
      <td>CARR MINCA CR 1 367</td>
      <td>CA MINCA CR 1 367</td>
      <td>Si</td>
      <td>NaN</td>
      <td>3232274086</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>202407</td>
      <td>NaN</td>
      <td>A</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>CC1001832447_001</td>
      <td>CC1001832447</td>
      <td>1001832447</td>
      <td>001</td>
      <td>DE HORTA SANCHEZ JEAN CARLOS</td>
      <td>CL 31 B  #54   -77      BARRIO OLAYA HERRERA</td>
      <td>CL 31 B 54 77 BR OLAYA HERRERA</td>
      <td>Si</td>
      <td>NaN</td>
      <td>3123030265</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>202408</td>
      <td>NaN</td>
      <td>A</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>CC1001875363_001</td>
      <td>CC1001875363</td>
      <td>1001875363</td>
      <td>001</td>
      <td>ANAYA JIMENEZ EDWIN</td>
      <td>CR 59 B  #6 A  -105</td>
      <td>CR 59 B 6 A 105</td>
      <td>Si</td>
      <td>NaN</td>
      <td>3016527856</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>202302</td>
      <td>NaN</td>
      <td>A</td>
      <td>NaN</td>
      <td>14</td>
      <td>2024-05-15</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>20633</th>
      <td>CC9877093_001</td>
      <td>CC9877093</td>
      <td>9877093</td>
      <td>001</td>
      <td>PAYARES ARIZA JAIRO LUIS</td>
      <td>CL 30   #26   -56      SAN PEDRO</td>
      <td>CL 30 26 56 SAN PEDRO</td>
      <td>Si</td>
      <td>NaN</td>
      <td>3102934954</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>202310</td>
      <td>NaN</td>
      <td>A</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>20634</th>
      <td>CC98772638_001</td>
      <td>CC98772638</td>
      <td>98772638</td>
      <td>001</td>
      <td>URE?A VESGA DIEGO ANDRES</td>
      <td>CALLE 17A N? 9-80 BRR PUEBLITO</td>
      <td>CL 17A 9 80 BR PUEBLITO</td>
      <td>Si</td>
      <td>NaN</td>
      <td>4215294</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>201812</td>
      <td>NaN</td>
      <td>A</td>
      <td>NaN</td>
      <td>53</td>
      <td>2024-04-03</td>
      <td>0.0</td>
      <td>MIGRACION</td>
    </tr>
    <tr>
      <th>20635</th>
      <td>CC9877977_001</td>
      <td>CC9877977</td>
      <td>9877977</td>
      <td>001</td>
      <td>VASQUEZ CANTILLO WDEYMER CRISTOBAL</td>
      <td>CLL 3 N° 11 -75</td>
      <td>CLL 3 11 75</td>
      <td>No</td>
      <td>NaN</td>
      <td>4158431</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2019-07-01</td>
      <td>I</td>
      <td>NaN</td>
      <td>53</td>
      <td>2019-07-31</td>
      <td>0.0</td>
      <td>MIGRACION</td>
    </tr>
    <tr>
      <th>20636</th>
      <td>CC9878088_001</td>
      <td>CC9878088</td>
      <td>9878088</td>
      <td>001</td>
      <td>CANDANOZA VALENCIA YEISON ENRIQUE</td>
      <td>CR 5 #15 -25 PRADERA</td>
      <td>CR 5 15 25 PRADERA</td>
      <td>Si</td>
      <td>NaN</td>
      <td>3022035444</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>202209</td>
      <td>2023-04-20</td>
      <td>A</td>
      <td>NaN</td>
      <td>98</td>
      <td>2022-09-30</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>20637</th>
      <td>CC9878126_001</td>
      <td>CC9878126</td>
      <td>9878126</td>
      <td>001</td>
      <td>DE LA CRUZ OROZCO JULIO CESAR</td>
      <td>MANZANA B CASA 4</td>
      <td>MZ B CS 4</td>
      <td>Si</td>
      <td>NaN</td>
      <td>5555555</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2014-09-26</td>
      <td>I</td>
      <td>NaN</td>
      <td>110</td>
      <td>2019-09-10</td>
      <td>0.0</td>
      <td>MIGRACION</td>
    </tr>
  </tbody>
</table>
<p>20615 rows × 29 columns</p>
</div>

<h3 id="guardar-en-base-de-datos-dwh">Guardar en base de datos DWH<a class="headerlink" href="#guardar-en-base-de-datos-dwh" title="Permanent link">&para;</a></h3>
<p>Se guarda cada tabla del diccionario <code>df_structure</code> en su respectiva tabla en la base de datos DWH, utilizando los nombres definidos en <code>dim_names</code>. El contenido de cada tabla se reemplaza si ya existe en la base de datos. El tiempo total de almacenamiento se registra en el log.</p>
<div class="highlight"><pre><span></span><code><span class="n">guardar_en_dwh</span><span class="p">(</span><span class="n">df_structure</span><span class="p">,</span> <span class="n">dim_names</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 14:35:44,416 - INFO - Intentando conexión a la base DWH...
2024-10-30 14:35:44,418 - INFO - Conexión a la base DWH establecida con éxito.
2024-10-30 14:35:44,724 - INFO - Almacenando tabla sat25 en DWH como BD_Dim_Tipo_Persona
2024-10-30 14:35:45,488 - INFO - Tabla sat25 almacenada correctamente como BD_Dim_Tipo_Persona.
2024-10-30 14:35:45,489 - INFO - Almacenando tabla subsi04 en DWH como BD_Dim_Actividad
2024-10-30 14:35:46,154 - INFO - Tabla subsi04 almacenada correctamente como BD_Dim_Actividad.
2024-10-30 14:35:46,156 - INFO - Almacenando tabla subsi36 en DWH como BD_Dim_Estados_Inactivacion
2024-10-30 14:35:46,703 - INFO - Tabla subsi36 almacenada correctamente como BD_Dim_Estados_Inactivacion.
2024-10-30 14:35:46,704 - INFO - Almacenando tabla SK13 en DWH como BD_Dim_Zona
2024-10-30 14:35:47,243 - INFO - Tabla SK13 almacenada correctamente como BD_Dim_Zona.
2024-10-30 14:35:47,244 - INFO - Almacenando tabla gener18 en DWH como BD_Dim_Codigo_Documento
2024-10-30 14:35:47,856 - INFO - Tabla gener18 almacenada correctamente como BD_Dim_Codigo_Documento.
2024-10-30 14:35:47,857 - WARNING - La clave subsi02 no está presente en table_names, no se guardó en la base de datos.
2024-10-30 14:35:47,858 - WARNING - La clave subsi15 no está presente en table_names, no se guardó en la base de datos.
2024-10-30 14:35:47,859 - INFO - Almacenando tabla xml4c085 en DWH como BD_Dim_Empresas_Sucursales
2024-10-30 14:35:53,588 - INFO - Tabla xml4c085 almacenada correctamente como BD_Dim_Empresas_Sucursales.
2024-10-30 14:35:53,589 - INFO - Almacenando tabla gener08 en DWH como BD_Dim_Ciudades
2024-10-30 14:35:54,155 - INFO - Tabla gener08 almacenada correctamente como BD_Dim_Ciudades.
2024-10-30 14:35:54,156 - INFO - Almacenando tabla BD_Dim_Tipo_Afiliado en DWH como BD_Dim_Tipo_Afiliado
2024-10-30 14:35:54,848 - INFO - Tabla BD_Dim_Tipo_Afiliado almacenada correctamente como BD_Dim_Tipo_Afiliado.
2024-10-30 14:35:54,912 - INFO - ALMACENAMIENTO ---  --- 10.50 seconds ---
2024-10-30 14:35:54,913 - INFO - Finalizando proceso de almacenamiento en DWH.
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">guardar_en_dwh</span><span class="p">(</span><span class="n">df_structure_dwh</span><span class="p">,</span> <span class="n">dim_names_dwh</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 14:35:54,921 - INFO - Intentando conexión a la base DWH...
2024-10-30 14:35:54,922 - INFO - Conexión a la base DWH establecida con éxito.
2024-10-30 14:35:55,214 - INFO - Almacenando tabla DimAuxEstadoAfiliacion en DWH como BD_Dim_Estados_Afiliacion
2024-10-30 14:35:55,756 - INFO - Tabla DimAuxEstadoAfiliacion almacenada correctamente como BD_Dim_Estados_Afiliacion.
2024-10-30 14:35:55,757 - INFO - Almacenando tabla DimTipoVinculacion en DWH como BD_Dim_Calidad_Aportante
2024-10-30 14:35:56,482 - INFO - Tabla DimTipoVinculacion almacenada correctamente como BD_Dim_Calidad_Aportante.
2024-10-30 14:35:56,540 - INFO - ALMACENAMIENTO ---  --- 1.62 seconds ---
2024-10-30 14:35:56,542 - INFO - Finalizando proceso de almacenamiento en DWH.
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;FINAL ETL --- </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> seconds ---&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 14:35:56,554 - INFO - FINAL ETL --- 207.26 seconds ---
</code></pre></div>

<h1 id="16-fact_historico_afiliacion_empresas">1.6-Fact_Historico_Afiliacion_Empresas<a class="headerlink" href="#16-fact_historico_afiliacion_empresas" title="Permanent link">&para;</a></h1>
<h1 id="16-fact_historico_afiliacion_empresas_1">1.6-Fact_Historico_Afiliacion_Empresas<a class="headerlink" href="#16-fact_historico_afiliacion_empresas_1" title="Permanent link">&para;</a></h1>
<h1 id="16-fact-historico-afiliacion-empresas">1.6 Fact Historico Afiliacion Empresas<a class="headerlink" href="#16-fact-historico-afiliacion-empresas" title="Permanent link">&para;</a></h1>
<h2 id="introduccion">Introducción<a class="headerlink" href="#introduccion" title="Permanent link">&para;</a></h2>
<p>En este proceso ETL se consolidan y transforman datos relacionados con la afiliación de empresas y sus empleados, para ser almacenados en una tabla de hechos dentro del Data Warehouse (DWH), denominada <code>BD_Fact_Historico_Afiliacion_Empresas</code>. Se extrajeron datos desde las tablas <code>xml4c085</code> y <code>op_EmpresasSubsi02_v2</code>, que incluyen información detallada sobre el estado de afiliación de las empresas, así como la cantidad de trabajadores, su distribución por género, y otros detalles relacionados con el código de documento y zonas geográficas. Estos datos permitieron analizar el comportamiento histórico de afiliación, identificar periodos de ingreso y retiro, y consolidar información demográfica clave de las empresas afiliadas.</p>
<p>La salida final, <code>BD_Fact_Historico_Afiliacion_Empresas</code>, almacena estos datos, permitiendo analizar el estado de las empresas afiliadas en diferentes periodos, el número de empleados y la distribución por género. El proceso incluyó la limpieza de datos, la estandarización de nombres de columnas, y la creación de identificadores únicos para los registros de empresas y sus empleados.</p>
<hr />
<h3 id="diagrama-de-secuencia-del-proceso-etl_1">Diagrama de Secuencia del Proceso ETL<a class="headerlink" href="#diagrama-de-secuencia-del-proceso-etl_1" title="Permanent link">&para;</a></h3>
<pre class="mermaid"><code>sequenceDiagram
title Diagrama de Secuencia del Proceso ETL para Afiliación de Empresas
autonumber
participant 👤 Usuario
participant Script as Script ETL
participant DB as Bases de Datos
participant DWH as Data Warehouse

Usuario-&gt;&gt;Script: Solicitar ETL de Histórico de Afiliación
Script-&gt;&gt;DB: Conectar y extraer datos de &lt;br&gt; xml4c085, op_EmpresasSubsi02_v2
DB--&gt;&gt;Script: Retornar datos extraídos
Script-&gt;&gt;Script: Limpiar, estandarizar y transformar los datos
Script-&gt;&gt;DWH: Cargar datos en BD_Fact_Historico_Afiliacion_Empresas
DWH--&gt;&gt;Script: Confirmación de carga exitosa
Script--&gt;&gt;Usuario: Proceso ETL completado con éxito</code></pre>
<p>Este diagrama muestra las diferentes etapas del proceso ETL, desde la extracción de los datos de las bases hasta la consolidación de la información en el DWH, lo cual facilita el análisis del comportamiento de afiliación de las empresas y sus empleados.</p>
<h2 id="etl_1">ETL<a class="headerlink" href="#etl_1" title="Permanent link">&para;</a></h2>
<h3 id="importacion-de-librerias-y-funciones_1">Importación de librerías y funciones<a class="headerlink" href="#importacion-de-librerias-y-funciones_1" title="Permanent link">&para;</a></h3>
<p>Este script facilita el manejo y la transformación de datos en una base de datos usando SQLAlchemy y Pandas, complementado con funciones personalizadas que optimizan el flujo de trabajo. Con SQLAlchemy, se gestiona la conexión a bases de datos mediante <code>create_engine</code>, y Pandas permite la manipulación de datos en formato tabular, incluyendo transformaciones y almacenamiento. La biblioteca <code>time</code> mide la duración de la ejecución para monitoreo de rendimiento, mientras que <code>logging</code> permite la captura de eventos importantes y posibles errores. Desde el módulo <code>Funciones.py</code>, se importan funciones clave como <code>convertir_columnas_mayusculas</code> (posiblemente para estandarizar los nombres de las columnas), <code>guardar_en_dwh</code> (para almacenar datos en un Data Warehouse), <code>cargar_tablas</code> (para cargar datos desde diversas fuentes), <code>obtener_conexion</code> (para establecer una conexión), <code>testfunciones</code> (posiblemente para pruebas), y <code>setup_logger</code> (para configurar el sistema de logging). Este enfoque modular asegura un procesamiento de datos flexible y escalable para flujos ETL o análisis.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="nn">sa</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1">#Import de modulo funciones</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Agrega el directorio al sys.path</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;../funciones&#39;</span><span class="p">))</span>

<span class="c1"># Importa las funciones desde el archivo Funciones.py</span>

<span class="kn">from</span> <span class="nn">Funciones</span> <span class="kn">import</span> <span class="n">convertir_columnas_mayusculas</span><span class="p">,</span> <span class="n">guardar_en_dwh</span><span class="p">,</span> <span class="n">cargar_tablas</span><span class="p">,</span> <span class="n">obtener_conexion</span><span class="p">,</span> <span class="n">testfunciones</span><span class="p">,</span> <span class="n">setup_logger</span>
</code></pre></div>
<h3 id="configuracion-del-logger-y-comienzo-del-proceso-etl">Configuración del logger y comienzo del proceso ETL<a class="headerlink" href="#configuracion-del-logger-y-comienzo-del-proceso-etl" title="Permanent link">&para;</a></h3>
<p>En esta celda se configura el logger, que se utiliza para registrar mensajes de información (logging). El logger está configurado para guardar un archivo log con el nombre <code>Empresas.log</code>, y en esta etapa, se inicia el proceso ETL, registrando el comienzo del mismo.</p>
<hr />
<div class="highlight"><pre><span></span><code><span class="c1">#---------------------------------------------</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="n">log_filename</span><span class="o">=</span><span class="s1">&#39;Empresas.log&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>  <span class="c1"># Cambiado a logging.INFO</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">testfunciones</span><span class="p">())</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;COMIENZO ETL&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 11:48:51,409 - INFO - Importacion de funciones correcta, 30-10-2024 11:48
2024-10-30 11:48:51,411 - INFO - COMIENZO ETL
</code></pre></div>

<h3 id="consulta-sql-para-consolidacion-de-datos-de-empresas-y-trabajadores">Consulta SQL para Consolidación de Datos de Empresas y Trabajadores<a class="headerlink" href="#consulta-sql-para-consolidacion-de-datos-de-empresas-y-trabajadores" title="Permanent link">&para;</a></h3>
<p>Esta consulta SQL extrae y combina información de empresas y sus trabajadores a partir de múltiples tablas en la base <code>xml4</code>. La consulta principal (<code>p1</code>) selecciona datos como <code>NIT</code>, <code>PERIODO</code>, <code>TIPIDE</code>, <code>ESTADO</code>, <code>CODZON</code>, <code>NOMBRE_EMPRESA</code>, y <code>CODCIU</code>, entre otros. La subconsulta interna (<code>p</code>) extrae información relacionada con el período de afiliación y retiro (<code>perafi</code>, <code>perret</code>) y atributos de la empresa (<code>tipemp</code>, <code>tipsoc</code>, <code>nomcom</code>). La subconsulta secundaria (<code>p2</code>) agrega datos sobre el número de trabajadores (<code>NumTrab</code>) y el desglose por género (<code>NumFem</code>, <code>NumMas</code>), permitiendo una vista completa de las características y composición de los trabajadores en cada período.</p>
<p>La consulta final une <code>p1</code> con <code>p2</code> en <code>nit</code> y <code>periodo</code>, creando un conjunto de datos consolidado que permite el análisis detallado de empresas y sus trabajadores en períodos específicos, con un enfoque en la segmentación por género y afiliación.</p>
<div class="highlight"><pre><span></span><code><span class="n">qr_structure</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    SELECT</span>
<span class="s1">        p1.nit, p1.periodo, p1.tipide, p1.tipper, p1.estado, p1.divpol as codzon, p1.cod,</span>
<span class="s1">        p1.nombre as calemp, p1.tipapo, p1.perafi, p1.perret, p2.NumTrab, p1.codciu, </span>
<span class="s1">        p2.NumFem, p2.NumMas, p1.tipemp, p1.tipsoc, p1.nomcom, p1.razsoc, p1.codact, </span>
<span class="s1">        p1.fecsis, p1.persis, p1.codest</span>
<span class="s1">    FROM (</span>
<span class="s1">        SELECT</span>
<span class="s1">            p.nit, p.periodo, p.tipide, p.cod, p.tipper, p.estado, p.divpol,</span>
<span class="s1">            p.nombre, p.tipapo, p.codciu, p.tipemp, p.tipsoc, p.nomcom, p.razsoc, </span>
<span class="s1">            p.codact, p.perafi, p.perret, p.fecsis, p.persis, p.codest</span>
<span class="s1">        FROM (</span>
<span class="s1">            SELECT</span>
<span class="s1">                b.nit, b.periodo, b.tipide, b.cod, b.tipper, b.estado, b.divpol,</span>
<span class="s1">                c.perafi, a.nombre, b.tipapo, b.fecret as perret, s.codciu, </span>
<span class="s1">                d.nombre as tipemp, s.tipsoc, s.nomcom, b.razsoc, b.codact, </span>
<span class="s1">                s.fecsis, s.persis, s.codest</span>
<span class="s1">            FROM (</span>
<span class="s1">                SELECT</span>
<span class="s1">                    nit, tipide, CONCAT(tipide, nit) as cod,</span>
<span class="s1">                    periodo, estado, divpol, IF(tipide=7, &#39;J&#39;, &#39;N&#39;) as tipper,</span>
<span class="s1">                    tipapo, razsoc, codact, tipsec,</span>
<span class="s1">                    IF(estado = 2 OR estado = 4, periodo, NULL) as fecret</span>
<span class="s1">                FROM xml4.xml4c085</span>
<span class="s1">                #WHERE nit=&#39;891780093&#39;</span>

<span class="s1">                GROUP BY cod, periodo</span>
<span class="s1">            ) as b</span>
<span class="s1">            LEFT JOIN xml4.xml4b072 as a ON b.tipapo = a.tipapo</span>
<span class="s1">            LEFT JOIN xml4.xml4b001 as d ON b.tipsec = d.tipsec</span>
<span class="s1">            LEFT JOIN (</span>
<span class="s1">                SELECT </span>
<span class="s1">                    CONCAT(</span>
<span class="s1">                        CAST(</span>
<span class="s1">                            CASE</span>
<span class="s1">                                WHEN coddoc = &#39;CC&#39; THEN 1</span>
<span class="s1">                                WHEN coddoc = &#39;CE&#39; THEN 4</span>
<span class="s1">                                WHEN coddoc = &#39;NI&#39; THEN 7</span>
<span class="s1">                                WHEN coddoc = &#39;PA&#39; THEN 6</span>
<span class="s1">                                WHEN coddoc = &#39;RC&#39; THEN 3</span>
<span class="s1">                                ELSE coddoc</span>
<span class="s1">                            END AS CHAR</span>
<span class="s1">                        ),</span>
<span class="s1">                        nit</span>
<span class="s1">                    ) AS cod, codciu, tipsoc, nomcom, fecsis, </span>
<span class="s1">                    CONCAT(SUBSTRING(fecsis, 1, 4), SUBSTRING(fecsis, 6, 2)) as persis, </span>
<span class="s1">                    codest</span>
<span class="s1">                FROM subsidio.subsi02</span>
<span class="s1">                GROUP BY cod</span>
<span class="s1">            ) as s ON b.cod = s.cod</span>
<span class="s1">            LEFT JOIN (</span>
<span class="s1">                SELECT CONCAT(tipide, nit) as cod, MIN(periodo) as perafi </span>
<span class="s1">                FROM xml4.xml4c085 </span>
<span class="s1">                WHERE estado=1 </span>
<span class="s1">                GROUP BY CONCAT(tipide, nit)</span>
<span class="s1">            ) as c ON b.cod = c.cod</span>
<span class="s1">        ) as p</span>
<span class="s1">        WHERE  </span>
<span class="s1">            (</span>
<span class="s1">                CONCAT(SUBSTRING(periodo, 1, 4), &#39;-&#39;, SUBSTRING(periodo, 5, 2), &#39;-01&#39;) &lt;= DATE_FORMAT(CURDATE(), &#39;%Y-%m-01&#39;)</span>
<span class="s1">                AND CONCAT(SUBSTRING(perret, 1, 4), &#39;-&#39;, SUBSTRING(perret, 5, 2), &#39;-01&#39;) &gt;= DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 18 MONTH), &#39;%Y-%m-01&#39;)</span>
<span class="s1">            ) OR (</span>
<span class="s1">                CONCAT(SUBSTRING(periodo, 1, 4), &#39;-&#39;, SUBSTRING(periodo, 5, 2), &#39;-01&#39;) &lt;= DATE_FORMAT(CURDATE(), &#39;%Y-%m-01&#39;)</span>
<span class="s1">                AND perret IS NULL</span>
<span class="s1">            )</span>
<span class="s1">    ) as p1</span>
<span class="s1">    LEFT JOIN (</span>
<span class="s1">        SELECT </span>
<span class="s1">            periodo, nit, COUNT(DISTINCT(CONCAT(coddoc, cedtra))) as NumTrab, </span>
<span class="s1">            SUM(sexfem) as NumFem, SUM(sexmas) as NumMas</span>
<span class="s1">        FROM (</span>
<span class="s1">            SELECT </span>
<span class="s1">                periodo, nit, coddoc, cedtra, </span>
<span class="s1">                IF(tipgen = 2, 1, 0) as sexfem, </span>
<span class="s1">                IF(tipgen = 1, 1, 0) as sexmas </span>
<span class="s1">            FROM xml4.xml4c086 </span>
<span class="s1">            GROUP BY coddoc, cedtra, nit, periodo</span>
<span class="s1">        ) as tra</span>
<span class="s1">        GROUP BY nit, periodo</span>
<span class="s1">    ) as p2 ON p1.nit = p2.nit AND p1.periodo = p2.periodo;</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">}</span>

<span class="n">df_structure</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;LECTURA DE QUERYS&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 11:48:51,419 - INFO - LECTURA DE QUERYS
</code></pre></div>

<h3 id="consulta-sql-para-consolidacion-de-datos-de-empresas-con-segmentacion-por-periodo">Consulta SQL para Consolidación de Datos de Empresas con Segmentación por Periodo<a class="headerlink" href="#consulta-sql-para-consolidacion-de-datos-de-empresas-con-segmentacion-por-periodo" title="Permanent link">&para;</a></h3>
<p>Esta consulta en <code>qr_structure2</code> selecciona y agrupa información de empresas en diferentes períodos, consolidando datos de estado de afiliación y características adicionales. La consulta selecciona campos como <code>periodo</code>, <code>tipide</code>, <code>tipper</code>, <code>codzon</code>, <code>codest</code>, y <code>estado</code>, además de columnas derivadas como <code>seRetiro</code>, <code>seAfilio</code>, y <code>nuevo</code> que indican cambios de afiliación por período.</p>
<p>La subconsulta (<code>hh</code>) filtra los registros en un rango de 18 meses desde la fecha actual, generando indicadores sobre si la empresa se retiró o afilió en un período específico. La consulta final agrupa estos datos por <code>periodo</code>, <code>Tipo</code>, <code>cod</code>, y <code>estado</code>, creando una estructura resumida para análisis y segmentación de empresas en función de su estado y afiliación en el Data Warehouse.</p>
<div class="highlight"><pre><span></span><code><span class="n">qr_structure2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;query&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    SELECT</span>
<span class="s1">        periodo, nit as id, tipide, tipper, MAX(codzon) as codzon,</span>
<span class="s1">        MAX(codest) as codest, Tipo, cod, estado,</span>
<span class="s1">        MAX(seRetiro) as seRetiro, MAX(seAfilio) as seAfilio,  MAX(nuevo) as nuevo,</span>
<span class="s1">        MAX(calsuc) as calsuc, MAX(tipapo) as tipapo,</span>
<span class="s1">        MAX(NumTrab), MAX(codciu) as codciu, MAX(tipemp) as tipemp , MAX(tipsoc) as tipsoc , </span>
<span class="s1">        MAX(nomcom) as nomcom, MAX(razsoc) as razsoc,</span>
<span class="s1">        MAX(NumFem) as NumFem, MAX(NumMas) as NumMas, MAX(codact) as codact, MIN(fecsis) as fecsis</span>
<span class="s1">    FROM (</span>
<span class="s1">        SELECT nit, tipide, tipper, estado, periodo, codzon, codest, cod, &#39;Empresa&#39; as Tipo,</span>
<span class="s1">            calemp as calsuc, tipapo, fecsis, perafi, persis, NumTrab, codciu, NumFem, NumMas, </span>
<span class="s1">            tipemp, tipsoc, nomcom, razsoc, codact,</span>
<span class="s1">            IF(perret = periodo, 1, 0) as seRetiro,</span>
<span class="s1">            IF(perafi = periodo, 1, 0) as seAfilio,</span>
<span class="s1">            IF(periodo = persis, 1, 0) as nuevo</span>
<span class="s1">        FROM dwh.op_EmpresasSubsi02_v2 as p</span>
<span class="s1">        WHERE</span>
<span class="s1">            CONCAT(SUBSTRING(periodo, 1, 4), &#39;-&#39;, SUBSTRING(periodo, 5, 2), &#39;-01&#39;) &lt;= DATE_FORMAT(CURDATE(), &#39;%Y-%m-01&#39;)</span>
<span class="s1">            AND CONCAT(SUBSTRING(periodo, 1, 4), &#39;-&#39;, SUBSTRING(periodo, 5, 2), &#39;-01&#39;) &gt;= DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 18 MONTH), &#39;%Y-%m-01&#39;)</span>
<span class="s1">    ) as hh</span>
<span class="s1">    GROUP BY periodo, Tipo, cod, estado;</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">}</span>

<span class="n">df_structure2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;LECTURA DE QUERYS&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 11:48:51,428 - INFO - LECTURA DE QUERYS
</code></pre></div>

<h3 id="conexion-a-bases-de-datos-y-carga-de-tablas">Conexión a Bases de Datos y Carga de Tablas<a class="headerlink" href="#conexion-a-bases-de-datos-y-carga-de-tablas" title="Permanent link">&para;</a></h3>
<p>Este código establece conexiones con dos bases de datos distintas, <em>Minerva</em> y <em>DWH</em>, usando SQLAlchemy para manejar las conexiones y un <code>logger</code> para registrar eventos importantes, como el inicio de las conexiones. Primero, se conecta a la base <em>Minerva</em> utilizando <code>obtener_conexion</code>, y luego carga las consultas definidas en <code>qr_structure</code> en el DataFrame <code>df_structure</code> mediante la función <code>cargar_tablas</code>. Posteriormente, se realiza una conexión similar con la base de datos <em>DWH</em>, donde se ejecutan las consultas definidas en <code>qr_structure2</code> para cargar los datos en <code>df_structure2</code>. Este proceso asegura que los datos de ambas bases se procesen correctamente y permite el registro eficiente de eventos durante las operaciones.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Conexion a base Minerva</span>
<span class="n">motor</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">obtener_conexion</span><span class="p">(</span><span class="s1">&#39;minerva&#39;</span><span class="p">))</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CONEXION A BASE MINERVA&#39;</span><span class="p">)</span>

<span class="n">cargar_tablas</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="n">qr_structure</span><span class="p">,</span> <span class="n">df_structure</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>

<span class="c1">#Conexion a base Minerva</span>
<span class="n">motor2</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">obtener_conexion</span><span class="p">(</span><span class="s1">&#39;dwh&#39;</span><span class="p">))</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CONEXION A BASE DWH&#39;</span><span class="p">)</span>
<span class="n">cargar_tablas</span><span class="p">(</span><span class="n">motor2</span><span class="p">,</span> <span class="n">qr_structure2</span><span class="p">,</span> <span class="n">df_structure2</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 11:48:51,616 - INFO - CONEXION A BASE MINERVA
2024-10-30 11:48:51,966 - INFO - Cargando query 
2024-10-30 11:49:49,195 - INFO - Cargada query, 565,159 registros finales obtenidos. --- 57.23 seconds ---
2024-10-30 11:49:49,323 - INFO - CARGUE TABLAS DESDE MYSQL --- query --- 57.70 seconds ---
2024-10-30 11:49:49,325 - INFO - CONEXION A BASE DWH
2024-10-30 11:49:49,641 - INFO - Cargando query 
2024-10-30 11:50:02,441 - INFO - Cargada query, 199,034 registros finales obtenidos. --- 12.80 seconds ---
2024-10-30 11:50:02,533 - INFO - CARGUE TABLAS DESDE MYSQL --- query --- 13.21 seconds ---
</code></pre></div>

<h3 id="estandarizacion-y-creacion-de-identificadores-unicos-en-datos-de-empresas">Estandarización y Creación de Identificadores Únicos en Datos de Empresas<a class="headerlink" href="#estandarizacion-y-creacion-de-identificadores-unicos-en-datos-de-empresas" title="Permanent link">&para;</a></h3>
<p>Este código realiza la estandarización de nombres de columnas y la creación de un identificador único <code>ID_AFILIADO</code> en el DataFrame <code>op_sec_EmpresasSubsi02_v2</code>. Primero, utiliza un diccionario (<code>_names</code>) para renombrar las columnas clave con <code>convertir_columnas_mayusculas</code>, asegurando consistencia en los nombres y formatos.</p>
<p>Luego, define una serie de condiciones (<code>conditions</code>) y valores (<code>choices</code>) para crear el prefijo de documento basado en el código <code>CODIGO_DOCUMENTO</code>. La función <code>np.select</code> aplica esta lógica de selección múltiple, asignando a cada tipo de documento su abreviatura correspondiente (por ejemplo, <code>CC</code> para cédula de ciudadanía, <code>TI</code> para tarjeta de identidad). El resultado, <code>DOC_PREFIX</code>, se concatena con <code>ID</code> para formar el campo <code>ID_AFILIADO</code>, eliminando posteriormente la columna auxiliar <code>DOC_PREFIX</code>.</p>
<p>Por último, <code>op_sec_EmpresasSubsi02_v2</code> se reorganiza para incluir columnas seleccionadas, y <code>print(df_standar['PERIODO'].unique())</code> muestra los períodos únicos en el DataFrame, permitiendo validar la consistencia de los datos a través del tiempo.</p>
<div class="highlight"><pre><span></span><code><span class="n">op_EmpresasSubsi02_v2</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span>
<span class="n">op_sec_EmpresasSubsi02_v2</span> <span class="o">=</span> <span class="n">df_structure2</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span>
<span class="n">op_sec_EmpresasSubsi02_v2</span>

<span class="n">_names</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;tipide&#39;</span><span class="p">:</span> <span class="s1">&#39;CODIGO_DOCUMENTO&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;tipper&#39;</span><span class="p">:</span> <span class="s1">&#39;TIPO_PErSONA&#39;</span><span class="p">,</span>  
    <span class="s1">&#39;codzon&#39;</span><span class="p">:</span> <span class="s1">&#39;Codigo_Zona&#39;</span><span class="p">,</span>             
    <span class="s1">&#39;codest&#39;</span><span class="p">:</span> <span class="s1">&#39;COD_EST_INAC&#39;</span><span class="p">,</span>           
    <span class="s1">&#39;seRetiro&#39;</span><span class="p">:</span> <span class="s1">&#39;se_Retiro&#39;</span><span class="p">,</span>             
    <span class="s1">&#39;seAfilio&#39;</span><span class="p">:</span> <span class="s1">&#39;se_Afilio&#39;</span><span class="p">,</span>       
    <span class="s1">&#39;calsuc&#39;</span><span class="p">:</span> <span class="s1">&#39;Calificacion_Sucursal&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;codciu&#39;</span><span class="p">:</span> <span class="s1">&#39;Codigo_Ciudad&#39;</span><span class="p">,</span>   
    <span class="s1">&#39;fecsis&#39;</span><span class="p">:</span> <span class="s1">&#39;Fecha_Sistema&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;MAX(NumTrab)&#39;</span><span class="p">:</span>  <span class="s1">&#39;NUM_TRAB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;estado&#39;</span> <span class="p">:</span> <span class="s1">&#39;COD_EST_AFIL&#39;</span>
<span class="p">}</span>

<span class="n">df_standar</span> <span class="o">=</span> <span class="n">convertir_columnas_mayusculas</span><span class="p">(</span><span class="n">op_sec_EmpresasSubsi02_v2</span><span class="p">,</span><span class="n">_names</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Definir las condiciones y los valores para la lógica CASE</span>
<span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">df_standar</span><span class="p">[</span><span class="s1">&#39;CODIGO_DOCUMENTO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">df_standar</span><span class="p">[</span><span class="s1">&#39;CODIGO_DOCUMENTO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">df_standar</span><span class="p">[</span><span class="s1">&#39;CODIGO_DOCUMENTO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">df_standar</span><span class="p">[</span><span class="s1">&#39;CODIGO_DOCUMENTO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">df_standar</span><span class="p">[</span><span class="s1">&#39;CODIGO_DOCUMENTO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">df_standar</span><span class="p">[</span><span class="s1">&#39;CODIGO_DOCUMENTO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span><span class="p">,</span>
    <span class="n">df_standar</span><span class="p">[</span><span class="s1">&#39;CODIGO_DOCUMENTO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">7</span><span class="p">,</span>
    <span class="n">df_standar</span><span class="p">[</span><span class="s1">&#39;CODIGO_DOCUMENTO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">df_standar</span><span class="p">[</span><span class="s1">&#39;CODIGO_DOCUMENTO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">9</span><span class="p">,</span>
    <span class="n">df_standar</span><span class="p">[</span><span class="s1">&#39;CODIGO_DOCUMENTO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">15</span>
<span class="p">]</span>

<span class="c1"># Valores correspondientes a cada condición</span>
<span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CC&#39;</span><span class="p">,</span> <span class="s1">&#39;TI&#39;</span><span class="p">,</span> <span class="s1">&#39;RC&#39;</span><span class="p">,</span> <span class="s1">&#39;CE&#39;</span><span class="p">,</span> <span class="s1">&#39;NP&#39;</span><span class="p">,</span> <span class="s1">&#39;PA&#39;</span><span class="p">,</span> <span class="s1">&#39;NI&#39;</span><span class="p">,</span> <span class="s1">&#39;CD&#39;</span><span class="p">,</span> <span class="s1">&#39;PE&#39;</span><span class="p">,</span> <span class="s1">&#39;PT&#39;</span><span class="p">]</span>

<span class="c1"># Aplicar las condiciones con np.select y crear el prefijo correspondiente</span>
<span class="n">df_standar</span><span class="p">[</span><span class="s1">&#39;DOC_PREFIX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">df_standar</span><span class="p">[</span><span class="s1">&#39;CODIGO_DOCUMENTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>

<span class="c1"># Concatenar el prefijo y cedtra para crear la columna ID_AFILIADO</span>
<span class="n">df_standar</span><span class="p">[</span><span class="s1">&#39;ID_AFILIADO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_standar</span><span class="p">[</span><span class="s1">&#39;DOC_PREFIX&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_standar</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="c1"># Eliminar la columna auxiliar DOC_PREFIX si no se necesita</span>
<span class="n">df_standar</span> <span class="o">=</span> <span class="n">df_standar</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DOC_PREFIX&#39;</span><span class="p">])</span>

<span class="n">op_sec_EmpresasSubsi02_v2</span> <span class="o">=</span> <span class="n">df_standar</span><span class="p">[[</span>
    <span class="s1">&#39;PERIODO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ID_AFILIADO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ID&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CODIGO_DOCUMENTO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TIPO_PERSONA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CODIGO_ZONA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;COD_EST_INAC&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TIPO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;COD&#39;</span><span class="p">,</span>
    <span class="s1">&#39;COD_EST_AFIL&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SE_RETIRO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SE_AFILIO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NUEVO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CALIFICACION_SUCURSAL&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TIPAPO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NUM_TRAB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CODIGO_CIUDAD&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TIPEMP&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TIPSOC&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NOMCOM&#39;</span><span class="p">,</span>
    <span class="s1">&#39;RAZSOC&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NUMFEM&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NUMMAS&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CODACT&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FECHA_SISTEMA&#39;</span>
    <span class="p">]]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">df_standar</span><span class="p">[</span><span class="s1">&#39;PERIODO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>[&#39;202310&#39; &#39;202311&#39; &#39;202312&#39; &#39;202401&#39; &#39;202402&#39; &#39;202403&#39; &#39;202404&#39; &#39;202309&#39;
 &#39;202407&#39; &#39;202408&#39; &#39;202409&#39; &#39;202304&#39; &#39;202305&#39; &#39;202306&#39; &#39;202307&#39; &#39;202308&#39;
 &#39;202405&#39; &#39;202406&#39;]
</code></pre></div>

<h3 id="almacenamiento-de-datos-en-el-data-warehouse">Almacenamiento de Datos en el Data Warehouse<a class="headerlink" href="#almacenamiento-de-datos-en-el-data-warehouse" title="Permanent link">&para;</a></h3>
<p>En esta última etapa, el código utiliza la función <code>guardar_en_dwh</code> para almacenar los DataFrames <code>op_EmpresasSubsi02_v2</code> y <code>op_sec_EmpresasSubsi02_v2</code> en el Data Warehouse. La primera llamada guarda <code>op_EmpresasSubsi02_v2</code> en una tabla con el mismo nombre en el DWH, y la segunda llamada almacena <code>op_sec_EmpresasSubsi02_v2</code> en la tabla <code>BD_Fact_Historico_Afiliacion_Empresas</code>. Los parámetros <code>multiple=False</code> y <code>if_exists='replace'</code> indican que las tablas se reemplazarán si ya existen y que no se manejarán datos en múltiples bloques, optimizando el proceso de inserción. Esta operación asegura que la información esté disponible y actualizada para futuras consultas o análisis.</p>
<div class="highlight"><pre><span></span><code><span class="n">guardar_en_dwh</span><span class="p">(</span><span class="n">op_EmpresasSubsi02_v2</span><span class="p">,</span> <span class="s1">&#39;op_EmpresasSubsi02_v2&#39;</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
<span class="n">guardar_en_dwh</span><span class="p">(</span><span class="n">op_sec_EmpresasSubsi02_v2</span><span class="p">,</span> <span class="s1">&#39;BD_Fact_Historico_Afiliacion_Empresas&#39;</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 11:50:03,089 - INFO - Intentando conexión a la base DWH...
2024-10-30 11:50:03,091 - INFO - Conexión a la base DWH establecida con éxito.
2024-10-30 11:50:03,388 - INFO - Almacenando tabla única en DWH como op_EmpresasSubsi02_v2
2024-10-30 11:51:50,695 - INFO - Tabla almacenada correctamente. 565,159 registros finales obtenidos.
2024-10-30 11:51:51,500 - INFO - ALMACENAMIENTO ---  --- 1.81 minutes ---
2024-10-30 11:51:51,501 - INFO - Finalizando proceso de almacenamiento en DWH.
2024-10-30 11:51:51,503 - INFO - Intentando conexión a la base DWH...
2024-10-30 11:51:51,506 - INFO - Conexión a la base DWH establecida con éxito.
2024-10-30 11:51:51,839 - INFO - Almacenando tabla única en DWH como BD_Fact_Historico_Afiliacion_Empresas
2024-10-30 11:52:26,714 - INFO - Tabla almacenada correctamente. 199,034 registros finales obtenidos.
2024-10-30 11:52:26,925 - INFO - ALMACENAMIENTO ---  --- 35.42 seconds ---
2024-10-30 11:52:26,927 - INFO - Finalizando proceso de almacenamiento en DWH.
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">op_sec_EmpresasSubsi02_v2</span><span class="p">[</span><span class="s1">&#39;PERIODO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>array([&#39;202310&#39;, &#39;202311&#39;, &#39;202312&#39;, &#39;202401&#39;, &#39;202402&#39;, &#39;202403&#39;,
       &#39;202404&#39;, &#39;202309&#39;, &#39;202407&#39;, &#39;202408&#39;, &#39;202409&#39;, &#39;202304&#39;,
       &#39;202305&#39;, &#39;202306&#39;, &#39;202307&#39;, &#39;202308&#39;, &#39;202405&#39;, &#39;202406&#39;],
      dtype=object)
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;FINAL ETL --- </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> seconds ---&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 11:52:26,991 - INFO - FINAL ETL --- 215.59 seconds ---
</code></pre></div>

<h1 id="18-fact_historicobeneficiarios">1.8-Fact_HistoricoBeneficiarios<a class="headerlink" href="#18-fact_historicobeneficiarios" title="Permanent link">&para;</a></h1>
<h1 id="18-fact_historicobeneficiarios_1">1.8-Fact_HistoricoBeneficiarios<a class="headerlink" href="#18-fact_historicobeneficiarios_1" title="Permanent link">&para;</a></h1>
<h1 id="18-fact-historico-beneficiarios">1.8 Fact Historico Beneficiarios<a class="headerlink" href="#18-fact-historico-beneficiarios" title="Permanent link">&para;</a></h1>
<h2 id="introduccion_1">Introducción<a class="headerlink" href="#introduccion_1" title="Permanent link">&para;</a></h2>
<p>En el proceso ETL de la tabla <code>Fact_HistoricoBeneficiarios</code>, se extraen y transforman datos clave sobre beneficiarios desde el sistema de subsidios y se almacenan en un Data Warehouse (DWH). La estructura de entrada está conformada principalmente por datos detallados de afiliación y retiro, así como estados de beneficiarios de diferentes tablas de origen. Las consultas SQL procesan información de afiliados para agregar valores como categoría, estado y códigos de afiliación, entre otros, optimizando la información para su análisis a lo largo del tiempo.</p>
<p>La salida se estructura en dos tablas de hechos en el DWH: <code>BD_Fact_Beneficiarios_p1</code> y <code>BD_Fact_Beneficiarios_p2</code>. Estas tablas consolidan datos históricos de los beneficiarios, permitiendo una visibilidad completa sobre el comportamiento de la afiliación, incluyendo el estado de retiro o continuidad de los beneficiarios y la categorización en niveles de educación y ciudad, entre otros aspectos clave.</p>
<hr />
<h3 id="diagrama-de-secuencia-del-proceso-etl_2">Diagrama de Secuencia del Proceso ETL<a class="headerlink" href="#diagrama-de-secuencia-del-proceso-etl_2" title="Permanent link">&para;</a></h3>
<p>El diagrama a continuación resume el flujo de datos desde la extracción y transformación de los beneficiarios hasta su consolidación en el DWH:</p>
<pre class="mermaid"><code>sequenceDiagram
    title Diagrama de Secuencia del Proceso ETL para Fact Histórico Beneficiarios
    autonumber
    participant 👤 Usuario
    participant Script as Script ETL
    participant DB as Bases de Datos
    participant DWH as Data Warehouse

    👤 Usuario-&gt;&gt;Script: Solicitar ETL de Fact Histórico Beneficiarios
    Script-&gt;&gt;DB: Conectar y extraer datos de &lt;br&gt; xml4c087, subsi22, BD_Fact_Beneficiarios_p1
    DB--&gt;&gt;Script: Retornar datos extraídos
    Script-&gt;&gt;Script: Procesar y transformar datos
    Script-&gt;DWH: Cargar datos en BD_Fact_Beneficiarios_p1
    DWH--&gt;&gt;Script: Confirmación de carga p1 exitosa
    Script-&gt;DWH: Cargar datos en BD_Fact_Beneficiarios_p2
    DWH--&gt;&gt;Script: Confirmación de carga p2 exitosa
    Script--&gt;&gt;👤 Usuario: Proceso ETL completado con éxito</code></pre>
<p>Este flujo ilustra la secuencia de transformación y carga en el DWH, donde las tablas de salida <code>BD_Fact_Beneficiarios_p1</code> y <code>BD_Fact_Beneficiarios_p2</code> contienen el registro histórico de afiliación y retiro de beneficiarios, permitiendo un análisis detallado en múltiples dimensiones.</p>
<h2 id="etl_2">ETL<a class="headerlink" href="#etl_2" title="Permanent link">&para;</a></h2>
<h3 id="importacion-de-librerias-y-funciones_2">Importación de librerías y funciones<a class="headerlink" href="#importacion-de-librerias-y-funciones_2" title="Permanent link">&para;</a></h3>
<p>Este código realiza las siguientes tareas principales: establece la conexión a una base de datos mediante SQLAlchemy, importa módulos y funciones específicas para manipular y transformar datos en Pandas y NumPy, y ejecuta una serie de funciones personalizadas para cargar, transformar y guardar los datos en un Data Warehouse (DWH).</p>
<p>La importación del módulo <code>Funciones.py</code> incluye funciones que probablemente se encargan de conectar a la base de datos (<code>obtener_conexion</code>), transformar datos (<code>convertir_columnas_mayusculas</code>), y manejar el guardado en el DWH (<code>guardar_en_dwh</code>). Además, el logger (<code>setup_logger</code>) ayuda a monitorear la ejecución y errores del script, y <code>testfunciones</code> podría verificar el estado de estas funciones o probar su correcto funcionamiento.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="nn">sa</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1">#Import de modulo funciones</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Agrega el directorio al sys.path</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;../funciones&#39;</span><span class="p">))</span>

<span class="c1"># Importa las funciones desde el archivo Funciones.py</span>

<span class="kn">from</span> <span class="nn">Funciones</span> <span class="kn">import</span> <span class="n">guardar_en_dwh</span><span class="p">,</span> <span class="n">cargar_tablas</span><span class="p">,</span> <span class="n">obtener_conexion</span><span class="p">,</span> <span class="n">testfunciones</span><span class="p">,</span> <span class="n">setup_logger</span><span class="p">,</span> <span class="n">convertir_columnas_mayusculas</span>
</code></pre></div>
<h3 id="configuracion-del-logger-y-comienzo-del-proceso-etl_1">Configuración del logger y comienzo del proceso ETL<a class="headerlink" href="#configuracion-del-logger-y-comienzo-del-proceso-etl_1" title="Permanent link">&para;</a></h3>
<p>En esta celda se configura el logger, que se utiliza para registrar mensajes de información (logging). El logger está configurado para guardar un archivo log con el nombre <code>nombre.log</code>, y en esta etapa, se inicia el proceso ETL, registrando el comienzo del mismo.</p>
<hr />
<div class="highlight"><pre><span></span><code><span class="c1">#---------------------------------------------</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="n">log_filename</span><span class="o">=</span><span class="s1">&#39;nombre.log&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>  <span class="c1"># Cambiado a logging.INFO</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">testfunciones</span><span class="p">())</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;COMIENZO ETL&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 11:08:56,051 - INFO - Importacion de funciones correcta, 30-10-2024 11:08
2024-10-30 11:08:56,053 - INFO - COMIENZO ETL
</code></pre></div>

<h3 id="consulta-sql-para-extraccion-de-datos-de-beneficiarios-y-periodos-de-afiliacion">Consulta SQL para Extracción de Datos de Beneficiarios y Períodos de Afiliación<a class="headerlink" href="#consulta-sql-para-extraccion-de-datos-de-beneficiarios-y-periodos-de-afiliacion" title="Permanent link">&para;</a></h3>
<p>Esta consulta SQL selecciona y consolida datos de beneficiarios y sus períodos de afiliación en función de múltiples uniones entre tablas (<code>xml4c087</code>, <code>subsi22</code>, <code>subsi23</code>, <code>subsi15</code>). La consulta construye un identificador <code>docben</code> a partir de los campos <code>coddocben</code> y <code>documento</code>, y calcula <code>persis</code>, que representa el año y mes del campo <code>fecsis</code>.</p>
<p>Se extraen campos como <code>codben</code>, <code>periodo</code>, <code>estado</code>, <code>sexo</code>, <code>nivedu</code>, y <code>codzon</code>, así como indicadores de afiliación (<code>perafi</code>) y retiro (<code>perret</code>). El filtro final asegura que los resultados se encuentren en un rango de 18 meses desde la fecha actual, permitiendo analizar los beneficiarios activos y el historial de afiliaciones o retiros recientes.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Lista de querys</span>
<span class="n">qr_structure</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">SELECT * FROM(</span>
<span class="s2">    SELECT p2.*, CONCAT(p2.coddocben,p2.documento) as docben, CONCAT( SUBSTRING(p2.fecsis,1,4) , SUBSTRING(p2.fecsis,6,2) ) as persis, p3.codciu </span>
<span class="s2"> FROM  (SELECT p1.*, d5.fecsis   </span>
<span class="s2"> FROM  (SELECT d2.codben, periodo, &#39;A&#39; as estado, d1.codtra as coddoc, d1.cedtra, d2.codest, d1.documento, d1.coddoc as coddocben, d1.tipgen as sexo, d1.codigo_dicap as captra, d2.nivedu, d1.fecnac, d1.parent, d1.codcat, d1.divpol AS codzon,</span>
<span class="s2">                                d4.perafi, d3.perret, d5.nombre as calsuc, d1.tipafi, SUM(d1.numcuo) as numcuo, SUM(d1.subliq) as subliq</span>
<span class="s2">                                FROM</span>
<span class="s2">                                xml4.xml4c087 as d1 </span>
<span class="s2">        LEFT JOIN (SELECT documento, codben, codest, nivedu</span>
<span class="s2">from subsidio.subsi22</span>
<span class="s2">group by documento) as d2</span>

<span class="s2">                                ON d1.documento=d2.documento</span>
<span class="s2">                                LEFT JOIN (select coddoc, documento,</span>
<span class="s2">                                IF(MAX(periodo)&lt;(SELECT MAX(periodo) from xml4.xml4c087), MAX(periodo), NULL) as perret from xml4.xml4c087 GROUP BY coddoc, documento) as d3</span>
<span class="s2">ON d1.coddoc = d3.coddoc</span>
<span class="s2">AND d1.documento = d3.documento</span>
<span class="s2">LEFT JOIN (select coddoc, documento,</span>
<span class="s2">MIN(periodo) as perafi from xml4.xml4c087 GROUP BY coddoc, documento) as d4</span>
<span class="s2">ON d1.coddoc = d4.coddoc</span>
<span class="s2">AND d1.documento = d4.documento</span>

<span class="s2">LEFT JOIN xml4.xml4b006 as d5</span>
<span class="s2">ON d1.tipafi = d5.tipafi</span>

<span class="s2">#where d1.documento in(&#39;1085104776&#39;, &#39;1084473954&#39;, &#39;1084473707&#39;, &#39;1104383175&#39;)</span>

<span class="s2">                                GROUP BY </span>
<span class="s2">    d1.documento, d1.coddoc, periodo) as p1</span>
<span class="s2">     LEFT JOIN</span>
<span class="s2">                                subsidio.subsi23 as d5</span>
<span class="s2">                                ON p1.codben=d5.codben) as p2</span>
<span class="s2">                                LEFT JOIN subsidio.subsi15 p3</span>
<span class="s2">    ON p2.cedtra = p3.cedtra</span>
<span class="s2">    AND p2.coddoc = p3.coddoc</span>

<span class="s2">    WHERE  (CONCAT(SUBSTRING(periodo, 1, 4), &#39;-&#39;, SUBSTRING(periodo, 5, 2), &#39;-01&#39;) &lt;= CURRENT_DATE()</span>
<span class="s2">        AND CONCAT(SUBSTRING(perret, 1, 4), &#39;-&#39;, SUBSTRING(perret, 5, 2), &#39;-01&#39;) &gt;= cast(DATE_SUB(CURRENT_DATE(), INTERVAL 18 MONTH) as CHAR))</span>
<span class="s2">        OR (CONCAT(SUBSTRING(periodo, 1, 4), &#39;-&#39;, SUBSTRING(periodo, 5, 2), &#39;-01&#39;) &lt;= CURRENT_DATE()</span>
<span class="s2">        AND perret IS NULL)) as m</span>
<span class="s2"> WHERE CONCAT(SUBSTRING(periodo, 1, 4), &#39;-&#39;, SUBSTRING(periodo, 5, 2), &#39;-01&#39;) &lt;= CURRENT_DATE()</span>
<span class="s2">        AND CONCAT(SUBSTRING(periodo, 1, 4), &#39;-&#39;, SUBSTRING(periodo, 5, 2), &#39;-01&#39;) &gt;= cast(DATE_SUB(CURRENT_DATE(), INTERVAL 18 MONTH) as CHAR);    </span>
<span class="s2">        &quot;&quot;&quot;</span>
<span class="p">}</span>
<span class="n">df_structure</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;LECTURA DE QUERYS&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 11:08:56,060 - INFO - LECTURA DE QUERYS
</code></pre></div>

<h3 id="consulta-sql-para-consolidacion-de-datos-de-beneficiarios-por-periodo">Consulta SQL para Consolidación de Datos de Beneficiarios por Período<a class="headerlink" href="#consulta-sql-para-consolidacion-de-datos-de-beneficiarios-por-periodo" title="Permanent link">&para;</a></h3>
<p>Esta consulta en <code>qr_structure2</code> agrupa y consolida información de beneficiarios en el Data Warehouse para cada período (<code>PERIODO</code>). Se seleccionan datos clave, como <code>ID_AFILIADO</code>, <code>CODIGO_DOCUMENTO</code>, <code>CODIGO_BENEFICIARIO</code>, <code>CODIGO_ZONA</code>, <code>CODIGO_ESTADO</code>, y <code>SEXO</code>, junto con información de afiliación y retiros (<code>SE_RETIRO</code>, <code>SE_AFILIO</code>). Indicadores adicionales, como <code>NUEVO</code> (si el beneficiario fue registrado en el sistema en el mismo período) y atributos personales (<code>CAPACIDAD_TRABAJO</code>, <code>NIVEL_EDUCATIVO</code>, <code>FECHA_NACIMIENTO</code>), también se incluyen.</p>
<p>Los datos se agrupan para obtener valores únicos mediante la función <code>MAX</code> en cada campo, y se establece un grupo por <code>PERIODO</code>, <code>TIPO</code>, <code>COD</code>, y <code>ESTADO</code>, generando una vista resumida de beneficiarios en el Data Warehouse. Esta estructura facilita el análisis de cambios en la afiliación, retiros, y características generales de la población de beneficiarios.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Lista de consultas actualizada</span>
<span class="n">qr_structure2</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SELECT PERIODO, </span>
<span class="sd">               ID_AFILIADO,</span>
<span class="sd">               MAX(CODIGO_DOCUMENTO) as CODIGO_DOCUMENTO, </span>
<span class="sd">               MAX(ID) as ID, </span>
<span class="sd">               MAX(CODBEN) as CODIGO_BENEFICIARIO,  </span>
<span class="sd">               MAX(CODCAT) as CODIGO_CATEGORIA, </span>
<span class="sd">               MAX(CODZON) as CODIGO_ZONA, </span>
<span class="sd">               MAX(CODEST) as CODIGO_ESTADO, </span>
<span class="sd">               TIPO, </span>
<span class="sd">               COD, </span>
<span class="sd">               ESTADO,</span>
<span class="sd">               MAX(SE_RETIRO) as SE_RETIRO, </span>
<span class="sd">               MAX(SE_AFILIO) as SE_AFILIO,  </span>
<span class="sd">               MAX(NUEVO) as NUEVO, </span>
<span class="sd">               MAX(SEXO) as SEXO, </span>
<span class="sd">               MAX(CAPTRA) as CAPACIDAD_TRABAJO, </span>
<span class="sd">               MAX(NIVEL_EDU) as NIVEL_EDUCATIVO, </span>
<span class="sd">               MAX(FECNAC) as FECHA_NACIMIENTO, </span>
<span class="sd">               MAX(PARENT) as PARENTESCO, </span>
<span class="sd">               MAX(CODCIU) as CODIGO_CIUDAD, </span>
<span class="sd">               MAX(CALSUC) as CALIFICACION_SUCURSAL, </span>
<span class="sd">               MAX(TIPAFI) as TIPO_AFILIACION, </span>
<span class="sd">               MAX(NUMCUO) as NUMERO_CUOTAS, </span>
<span class="sd">               MAX(SUBLIQ) as SUBSIDIO_LIQUIDADO  </span>
<span class="sd">        FROM (</span>
<span class="sd">            SELECT </span>
<span class="sd">                   ID_AFILIADO,</span>
<span class="sd">                   CODIGO_DOCUMENTO, </span>
<span class="sd">                   DOCUMENTO as ID, </span>
<span class="sd">                   CODIGO_BENEFICIARIO as CODBEN, </span>
<span class="sd">                   ESTADO, </span>
<span class="sd">                   PERIODO, </span>
<span class="sd">                   CODIGO_ZONA as CODZON, </span>
<span class="sd">                   CODIGO_ESTADO as CODEST, </span>
<span class="sd">                   DOCUMENTO_BENEFICIARIO as COD, </span>
<span class="sd">                   CODIGO_CATEGORIA as CODCAT, </span>
<span class="sd">                   SEXO,</span>
<span class="sd">                   CAPACIDAD_TRABAJO as CAPTRA,</span>
<span class="sd">                   NIVEL_EDUCACION as NIVEL_EDU, </span>
<span class="sd">                   FECHA_NACIMIENTO as FECNAC, </span>
<span class="sd">                   PARENTESCO as PARENT, </span>
<span class="sd">                   CODIGO_CIUDAD as CODCIU, </span>
<span class="sd">                   &#39;Beneficiario&#39; as TIPO, </span>
<span class="sd">                   CALIFICACION_SUCURSAL as CALSUC, </span>
<span class="sd">                   TIPO_AFILIACION as TIPAFI, </span>
<span class="sd">                   NUMERO_CUOTAS as NUMCUO, </span>
<span class="sd">                   SUBSIDIO_LIQUIDADO as SUBLIQ, </span>
<span class="sd">                   IF(PERIODO_RETIRO = PERIODO, 1, 0) as SE_RETIRO,</span>
<span class="sd">                   IF(PERIODO_AFILIACION = PERIODO, 1, 0) as SE_AFILIO,</span>
<span class="sd">                   IF(PERIODO = PERIODO_SISTEMA, 1, 0) as NUEVO</span>
<span class="sd">            FROM dwh.BD_Fact_Beneficiarios_p1 as p</span>
<span class="sd">        ) as h</span>
<span class="sd">        GROUP BY PERIODO, TIPO, COD, ESTADO;</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="p">}</span>

<span class="n">df_structure2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</code></pre></div>
<h3 id="conexion-y-cargue-de-tablas-desde-sql-con-registro-de-duracion">Conexión y cargue de tablas desde SQL con registro de duración<a class="headerlink" href="#conexion-y-cargue-de-tablas-desde-sql-con-registro-de-duracion" title="Permanent link">&para;</a></h3>
<p>Este bloque se conecta a la base de datos Minerva, carga las tablas definidas en <code>qr_structure</code>, y utiliza el <code>logger</code> para registrar tanto el tiempo individual de carga de cada tabla como el tiempo total del proceso. Esto proporciona visibilidad sobre el rendimiento de cada cargue y del proceso general, facilitando el monitoreo y la optimización del flujo de datos.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Conexion a base Minerva</span>
<span class="n">motor</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">obtener_conexion</span><span class="p">(</span><span class="s1">&#39;minerva&#39;</span><span class="p">))</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CONEXION A BASE &#39;</span><span class="p">)</span>

<span class="n">cargar_tablas</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="n">qr_structure</span><span class="p">,</span> <span class="n">df_structure</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 11:08:56,130 - INFO - CONEXION A BASE 
2024-10-30 11:08:56,427 - INFO - Cargando query 
2024-10-30 11:17:36,688 - INFO - Cargada query, 3,829,359 registros finales obtenidos. --- 8.67 minutes ---
2024-10-30 11:17:37,068 - INFO - CARGUE TABLAS DESDE MYSQL --- query --- 8.68 minutes ---
</code></pre></div>

<h3 id="consulta-de-codigos-de-documentos-y-conexion-a-base-de-datos-dwh">Consulta de Códigos de Documentos y Conexión a Base de Datos DWH<a class="headerlink" href="#consulta-de-codigos-de-documentos-y-conexion-a-base-de-datos-dwh" title="Permanent link">&para;</a></h3>
<p>Este bloque de código ejecuta una consulta para obtener todos los registros de la tabla <code>BD_Dim_Codigo_Documento</code> en el Data Warehouse (<code>dwh</code>), con el objetivo de cargar los códigos de documentos en un diccionario <code>df_codigos</code>. La función <code>create_engine</code> se utiliza para establecer una conexión con la base de datos mediante la función personalizada <code>obtener_conexion</code>, la cual devuelve la cadena de conexión al DWH.</p>
<p>Una vez establecida la conexión, la función <code>cargar_tablas</code> se ejecuta con los parámetros <code>motor2</code>, <code>qr_structure_cod</code>, <code>df_codigos</code> y <code>logger</code>, encargándose de ejecutar la consulta definida en <code>qr_structure_cod</code> y almacenar los resultados en <code>df_codigos</code>. Esta función probablemente maneja la ejecución de la consulta y el procesamiento de los datos, almacenándolos en un DataFrame u otra estructura.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Lista de querys</span>
<span class="n">qr_structure_cod</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT * FROM dwh.BD_Dim_Codigo_Documento;</span>
<span class="s2">    &quot;&quot;&quot;</span>
<span class="p">}</span>
<span class="n">df_codigos</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;LECTURA DE QUERYS&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">qr_structure2</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">])</span>


<span class="c1">#Conexion a base dwh</span>
<span class="n">motor2</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">obtener_conexion</span><span class="p">(</span><span class="s1">&#39;dwh&#39;</span><span class="p">))</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CONEXION A BASE DWH&#39;</span><span class="p">)</span>

<span class="n">cargar_tablas</span><span class="p">(</span><span class="n">motor2</span><span class="p">,</span> <span class="n">qr_structure_cod</span><span class="p">,</span> <span class="n">df_codigos</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 11:17:37,079 - INFO - LECTURA DE QUERYS
2024-10-30 11:17:37,081 - INFO - CONEXION A BASE DWH



        SELECT PERIODO, 
               ID_AFILIADO,
               MAX(CODIGO_DOCUMENTO) as CODIGO_DOCUMENTO, 
               MAX(ID) as ID, 
               MAX(CODBEN) as CODIGO_BENEFICIARIO,  
               MAX(CODCAT) as CODIGO_CATEGORIA, 
               MAX(CODZON) as CODIGO_ZONA, 
               MAX(CODEST) as CODIGO_ESTADO, 
               TIPO, 
               COD, 
               ESTADO,
               MAX(SE_RETIRO) as SE_RETIRO, 
               MAX(SE_AFILIO) as SE_AFILIO,  
               MAX(NUEVO) as NUEVO, 
               MAX(SEXO) as SEXO, 
               MAX(CAPTRA) as CAPACIDAD_TRABAJO, 
               MAX(NIVEL_EDU) as NIVEL_EDUCATIVO, 
               MAX(FECNAC) as FECHA_NACIMIENTO, 
               MAX(PARENT) as PARENTESCO, 
               MAX(CODCIU) as CODIGO_CIUDAD, 
               MAX(CALSUC) as CALIFICACION_SUCURSAL, 
               MAX(TIPAFI) as TIPO_AFILIACION, 
               MAX(NUMCUO) as NUMERO_CUOTAS, 
               MAX(SUBLIQ) as SUBSIDIO_LIQUIDADO  
        FROM (
            SELECT 
                   ID_AFILIADO,
                   CODIGO_DOCUMENTO, 
                   DOCUMENTO as ID, 
                   CODIGO_BENEFICIARIO as CODBEN, 
                   ESTADO, 
                   PERIODO, 
                   CODIGO_ZONA as CODZON, 
                   CODIGO_ESTADO as CODEST, 
                   DOCUMENTO_BENEFICIARIO as COD, 
                   CODIGO_CATEGORIA as CODCAT, 
                   SEXO,
                   CAPACIDAD_TRABAJO as CAPTRA,
                   NIVEL_EDUCACION as NIVEL_EDU, 
                   FECHA_NACIMIENTO as FECNAC, 
                   PARENTESCO as PARENT, 
                   CODIGO_CIUDAD as CODCIU, 
                   &#39;Beneficiario&#39; as TIPO, 
                   CALIFICACION_SUCURSAL as CALSUC, 
                   TIPO_AFILIACION as TIPAFI, 
                   NUMERO_CUOTAS as NUMCUO, 
                   SUBSIDIO_LIQUIDADO as SUBLIQ, 
                   IF(PERIODO_RETIRO = PERIODO, 1, 0) as SE_RETIRO,
                   IF(PERIODO_AFILIACION = PERIODO, 1, 0) as SE_AFILIO,
                   IF(PERIODO = PERIODO_SISTEMA, 1, 0) as NUEVO
            FROM dwh.BD_Fact_Beneficiarios_p1 as p
        ) as h
        GROUP BY PERIODO, TIPO, COD, ESTADO;



2024-10-30 11:17:37,377 - INFO - Cargando query 
2024-10-30 11:17:37,407 - INFO - Cargada query, 10 registros finales obtenidos. --- 0.03 seconds ---
2024-10-30 11:17:37,458 - INFO - CARGUE TABLAS DESDE MYSQL --- query --- 0.37 seconds ---
</code></pre></div>

<h3 id="union-de-dataframes-para-vincular-informacion-de-codigos-de-documentos">Unión de DataFrames para Vincular Información de Códigos de Documentos<a class="headerlink" href="#union-de-dataframes-para-vincular-informacion-de-codigos-de-documentos" title="Permanent link">&para;</a></h3>
<p>Este código transforma las columnas <code>coddoc</code> en <code>df</code> y <code>COD_SUPERSUBSIDIO</code> en <code>df_cod</code> a texto en mayúsculas para asegurar consistencia. Luego, realiza una unión (<code>merge</code>) entre <code>df</code> y <code>df_cod</code>, usando <code>coddoc</code> en <code>df</code> y <code>COD_SUPERSUBSIDIO</code> en <code>df_cod</code> para agregar datos de documentos desde <code>df_cod</code> a <code>df</code>.</p>
<p>La unión es del tipo <code>left</code>, conservando todos los registros de <code>df</code> y anexando las coincidencias de <code>df_cod</code> cuando están disponibles. La función <code>head()</code> muestra las primeras filas de <code>df_merged</code>, permitiendo verificar visualmente los resultados de la fusión.</p>
<div class="highlight"><pre><span></span><code><span class="n">df_cod</span> <span class="o">=</span> <span class="n">df_codigos</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span>

<span class="c1"># Convertir &#39;coddoc&#39; y &#39;CODDOC&#39; a tipo string y a mayúsculas</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;coddoc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;coddoc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="n">df_cod</span><span class="p">[</span><span class="s1">&#39;COD_SUPERSUBSIDIO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cod</span><span class="p">[</span><span class="s1">&#39;COD_SUPERSUBSIDIO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

<span class="c1"># Realizar el merge usando &#39;CODDOC&#39; de df_cod</span>
<span class="n">df_merged</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_cod</span><span class="p">[[</span><span class="s1">&#39;COD_SUPERSUBSIDIO&#39;</span><span class="p">,</span> <span class="s1">&#39;CODDOC&#39;</span><span class="p">]],</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;coddoc&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;COD_SUPERSUBSIDIO&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

<span class="c1"># Mostrar las primeras filas para verificar el resultado</span>
<span class="n">df_merged</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>codben</th>
      <th>periodo</th>
      <th>estado</th>
      <th>coddoc</th>
      <th>cedtra</th>
      <th>codest</th>
      <th>documento</th>
      <th>coddocben</th>
      <th>sexo</th>
      <th>captra</th>
      <th>...</th>
      <th>calsuc</th>
      <th>tipafi</th>
      <th>numcuo</th>
      <th>subliq</th>
      <th>fecsis</th>
      <th>docben</th>
      <th>persis</th>
      <th>codciu</th>
      <th>COD_SUPERSUBSIDIO</th>
      <th>CODDOC</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>406348.0</td>
      <td>202305</td>
      <td>A</td>
      <td>1</td>
      <td>1000120248</td>
      <td>None</td>
      <td>1084067407</td>
      <td>5</td>
      <td>1</td>
      <td>2</td>
      <td>...</td>
      <td>DEPENDIENTE CATEGORIA C CON DERECHO TEMPORAL A...</td>
      <td>13</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2020-02-08</td>
      <td>51084067407</td>
      <td>202002</td>
      <td>None</td>
      <td>1</td>
      <td>CC</td>
    </tr>
    <tr>
      <th>1</th>
      <td>NaN</td>
      <td>202305</td>
      <td>A</td>
      <td>1</td>
      <td>1000120248</td>
      <td>None</td>
      <td>1128144889</td>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>...</td>
      <td>DEPENDIENTE CATEGORIA C CON DERECHO TEMPORAL A...</td>
      <td>13</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>None</td>
      <td>11128144889</td>
      <td>None</td>
      <td>None</td>
      <td>1</td>
      <td>CC</td>
    </tr>
    <tr>
      <th>2</th>
      <td>NaN</td>
      <td>202305</td>
      <td>A</td>
      <td>1</td>
      <td>1000121261</td>
      <td>None</td>
      <td>1007860991</td>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>...</td>
      <td>DEPENDIENTE CATEGORIA C CON DERECHO TEMPORAL A...</td>
      <td>13</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>None</td>
      <td>11007860991</td>
      <td>None</td>
      <td>None</td>
      <td>1</td>
      <td>CC</td>
    </tr>
    <tr>
      <th>3</th>
      <td>364243.0</td>
      <td>202305</td>
      <td>A</td>
      <td>1</td>
      <td>1000121261</td>
      <td>None</td>
      <td>1083040303</td>
      <td>5</td>
      <td>1</td>
      <td>2</td>
      <td>...</td>
      <td>DEPENDIENTE CATEGORIA C CON DERECHO TEMPORAL A...</td>
      <td>13</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2017-11-02</td>
      <td>51083040303</td>
      <td>201711</td>
      <td>None</td>
      <td>1</td>
      <td>CC</td>
    </tr>
    <tr>
      <th>4</th>
      <td>364243.0</td>
      <td>202305</td>
      <td>A</td>
      <td>1</td>
      <td>1000121261</td>
      <td>None</td>
      <td>1083040303</td>
      <td>5</td>
      <td>1</td>
      <td>2</td>
      <td>...</td>
      <td>DEPENDIENTE CATEGORIA C CON DERECHO TEMPORAL A...</td>
      <td>13</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2023-08-28</td>
      <td>51083040303</td>
      <td>202308</td>
      <td>None</td>
      <td>1</td>
      <td>CC</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 27 columns</p>
</div>

<h3 id="creacion-de-identificador-unico-de-afiliado-y-estandarizacion-de-columnas">Creación de Identificador Único de Afiliado y Estandarización de Columnas<a class="headerlink" href="#creacion-de-identificador-unico-de-afiliado-y-estandarizacion-de-columnas" title="Permanent link">&para;</a></h3>
<p>Este código combina los valores de <code>CODDOC</code> y <code>cedtra</code> para crear una columna <code>ID_AFILIADO</code> que representa un identificador único de afiliado en <code>df_final</code>. Posteriormente, estandariza los nombres de columnas en <code>df_final</code> mediante un diccionario (<code>_names</code>) con la función <code>convertir_columnas_mayusculas</code>, asegurando consistencia y claridad en la nomenclatura de campos.</p>
<p>El DataFrame <code>df_standar</code> resultante se filtra para incluir únicamente las columnas deseadas en un orden específico, y <code>df_final.columns.to_list()</code> proporciona la lista de nombres de columnas finales, confirmando que los nombres y el orden sean correctos antes de proceder con el análisis o almacenamiento en el Data Warehouse.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Crear &#39;ID_AFILIADO&#39; en un solo paso y asignar directamente a df_final</span>
<span class="n">df_final</span> <span class="o">=</span> <span class="n">df_merged</span>
<span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;ID_AFILIADO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;CODDOC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;cedtra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="c1"># Mostrar el resultado</span>
<span class="n">_names</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;codben&#39;</span><span class="p">:</span> <span class="s1">&#39;CODIGO_BENEFICIARIO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;coddoc&#39;</span><span class="p">:</span> <span class="s1">&#39;Codigo_Documento&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cedtra&#39;</span><span class="p">:</span> <span class="s1">&#39;Cedula_Trabajador&#39;</span><span class="p">,</span>
    <span class="s1">&#39;codest&#39;</span><span class="p">:</span> <span class="s1">&#39;Codigo_Estado&#39;</span><span class="p">,</span>
    <span class="s1">&#39;captra&#39;</span><span class="p">:</span> <span class="s1">&#39;Capacidad_Trabajo&#39;</span><span class="p">,</span>
    <span class="s1">&#39;nivedu&#39;</span><span class="p">:</span> <span class="s1">&#39;Nivel_Educacion&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fecnac&#39;</span><span class="p">:</span> <span class="s1">&#39;Fecha_Nacimiento&#39;</span><span class="p">,</span>
    <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="s1">&#39;Parentesco&#39;</span><span class="p">,</span>
    <span class="s1">&#39;codcat&#39;</span><span class="p">:</span> <span class="s1">&#39;Codigo_Categoria&#39;</span><span class="p">,</span>
    <span class="s1">&#39;codzon&#39;</span><span class="p">:</span> <span class="s1">&#39;Codigo_Zona&#39;</span><span class="p">,</span>
    <span class="s1">&#39;perafi&#39;</span><span class="p">:</span> <span class="s1">&#39;Periodo_Afiliacion&#39;</span><span class="p">,</span>
    <span class="s1">&#39;perret&#39;</span><span class="p">:</span> <span class="s1">&#39;Periodo_Retiro&#39;</span><span class="p">,</span>
    <span class="s1">&#39;calsuc&#39;</span><span class="p">:</span> <span class="s1">&#39;Calificacion_Sucursal&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tipafi&#39;</span><span class="p">:</span> <span class="s1">&#39;Tipo_Afiliacion&#39;</span><span class="p">,</span>
    <span class="s1">&#39;numcuo&#39;</span><span class="p">:</span> <span class="s1">&#39;Numero_Cuotas&#39;</span><span class="p">,</span>
    <span class="s1">&#39;subliq&#39;</span><span class="p">:</span> <span class="s1">&#39;Subsidio_Liquidado&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fecsis&#39;</span><span class="p">:</span> <span class="s1">&#39;Fecha_Sistema&#39;</span><span class="p">,</span>
    <span class="s1">&#39;docben&#39;</span><span class="p">:</span> <span class="s1">&#39;Documento_Beneficiario&#39;</span><span class="p">,</span>
    <span class="s1">&#39;persis&#39;</span><span class="p">:</span> <span class="s1">&#39;Periodo_Sistema&#39;</span><span class="p">,</span>
    <span class="s1">&#39;codciu&#39;</span><span class="p">:</span> <span class="s1">&#39;Codigo_Ciudad&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CODDOC&#39;</span><span class="p">:</span> <span class="s1">&#39;Codigo_Documento_Afiliado&#39;</span>
<span class="p">}</span>


<span class="n">df_standar</span> <span class="o">=</span> <span class="n">convertir_columnas_mayusculas</span><span class="p">(</span><span class="n">df_final</span><span class="p">,</span><span class="n">_names</span><span class="p">)</span>
<span class="n">df_final</span> <span class="o">=</span> <span class="n">df_standar</span><span class="p">[[</span>
    <span class="s1">&#39;CODIGO_BENEFICIARIO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ID_AFILIADO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CEDULA_TRABAJADOR&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PERIODO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ESTADO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CODIGO_DOCUMENTO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CODIGO_ESTADO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CODDOCBEN&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SEXO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CAPACIDAD_TRABAJO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NIVEL_EDUCACION&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FECHA_NACIMIENTO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PARENTESCO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CODIGO_CATEGORIA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CODIGO_ZONA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PERIODO_AFILIACION&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PERIODO_RETIRO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CALIFICACION_SUCURSAL&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TIPO_AFILIACION&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NUMERO_CUOTAS&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SUBSIDIO_LIQUIDADO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FECHA_SISTEMA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DOCUMENTO_BENEFICIARIO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PERIODO_SISTEMA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CODIGO_CIUDAD&#39;</span><span class="p">,</span>
    <span class="s1">&#39;COD_SUPERSUBSIDIO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CODIGO_DOCUMENTO_AFILIADO&#39;</span><span class="p">,</span>
    <span class="p">]]</span>
<span class="n">df_final</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>[&#39;CODIGO_BENEFICIARIO&#39;,
 &#39;ID_AFILIADO&#39;,
 &#39;CEDULA_TRABAJADOR&#39;,
 &#39;PERIODO&#39;,
 &#39;ESTADO&#39;,
 &#39;CODIGO_DOCUMENTO&#39;,
 &#39;CODIGO_ESTADO&#39;,
 &#39;DOCUMENTO&#39;,
 &#39;CODDOCBEN&#39;,
 &#39;SEXO&#39;,
 &#39;CAPACIDAD_TRABAJO&#39;,
 &#39;NIVEL_EDUCACION&#39;,
 &#39;FECHA_NACIMIENTO&#39;,
 &#39;PARENTESCO&#39;,
 &#39;CODIGO_CATEGORIA&#39;,
 &#39;CODIGO_ZONA&#39;,
 &#39;PERIODO_AFILIACION&#39;,
 &#39;PERIODO_RETIRO&#39;,
 &#39;CALIFICACION_SUCURSAL&#39;,
 &#39;TIPO_AFILIACION&#39;,
 &#39;NUMERO_CUOTAS&#39;,
 &#39;SUBSIDIO_LIQUIDADO&#39;,
 &#39;FECHA_SISTEMA&#39;,
 &#39;DOCUMENTO_BENEFICIARIO&#39;,
 &#39;PERIODO_SISTEMA&#39;,
 &#39;CODIGO_CIUDAD&#39;,
 &#39;COD_SUPERSUBSIDIO&#39;,
 &#39;CODIGO_DOCUMENTO_AFILIADO&#39;]
</code></pre></div>

<hr />
<h3 id="guardar-en-base-de-datos-dwh_1">Guardar en base de datos DWH<a class="headerlink" href="#guardar-en-base-de-datos-dwh_1" title="Permanent link">&para;</a></h3>
<p>Se guarda el dataframe <code>dfTotal</code> en la tabla <code>BD_nombre</code> de la base DWH usando <code>with</code> para garantizar el cierre automático de la conexión. Se registra el tiempo de ejecución en el log.</p>
<div class="highlight"><pre><span></span><code><span class="n">guardar_en_dwh</span><span class="p">(</span><span class="n">df_final</span><span class="p">,</span> <span class="s1">&#39;BD_Fact_Beneficiarios_p1&#39;</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
<span class="n">df_final</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<span class="n">df_final</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 11:17:45,787 - INFO - Intentando conexión a la base DWH...
2024-10-30 11:17:45,788 - INFO - Conexión a la base DWH establecida con éxito.
2024-10-30 11:17:46,088 - INFO - Almacenando tabla única en DWH como BD_Fact_Beneficiarios_p1
2024-10-30 11:28:18,350 - INFO - Tabla almacenada correctamente. 3,832,674 registros finales obtenidos.
2024-10-30 11:28:22,516 - INFO - ALMACENAMIENTO ---  --- 10.61 minutes ---
2024-10-30 11:28:22,518 - INFO - Finalizando proceso de almacenamiento en DWH.
</code></pre></div>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CODIGO_BENEFICIARIO</th>
      <th>ID_AFILIADO</th>
      <th>CEDULA_TRABAJADOR</th>
      <th>PERIODO</th>
      <th>ESTADO</th>
      <th>CODIGO_DOCUMENTO</th>
      <th>CODIGO_ESTADO</th>
      <th>DOCUMENTO</th>
      <th>CODDOCBEN</th>
      <th>SEXO</th>
      <th>...</th>
      <th>CALIFICACION_SUCURSAL</th>
      <th>TIPO_AFILIACION</th>
      <th>NUMERO_CUOTAS</th>
      <th>SUBSIDIO_LIQUIDADO</th>
      <th>FECHA_SISTEMA</th>
      <th>DOCUMENTO_BENEFICIARIO</th>
      <th>PERIODO_SISTEMA</th>
      <th>CODIGO_CIUDAD</th>
      <th>COD_SUPERSUBSIDIO</th>
      <th>CODIGO_DOCUMENTO_AFILIADO</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>406348.0</td>
      <td>CC1000120248</td>
      <td>1000120248</td>
      <td>202305</td>
      <td>A</td>
      <td>1</td>
      <td>None</td>
      <td>1084067407</td>
      <td>5</td>
      <td>1</td>
      <td>...</td>
      <td>DEPENDIENTE CATEGORIA C CON DERECHO TEMPORAL A...</td>
      <td>13</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2020-02-08</td>
      <td>51084067407</td>
      <td>202002</td>
      <td>None</td>
      <td>1</td>
      <td>CC</td>
    </tr>
    <tr>
      <th>1</th>
      <td>NaN</td>
      <td>CC1000120248</td>
      <td>1000120248</td>
      <td>202305</td>
      <td>A</td>
      <td>1</td>
      <td>None</td>
      <td>1128144889</td>
      <td>1</td>
      <td>2</td>
      <td>...</td>
      <td>DEPENDIENTE CATEGORIA C CON DERECHO TEMPORAL A...</td>
      <td>13</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>None</td>
      <td>11128144889</td>
      <td>None</td>
      <td>None</td>
      <td>1</td>
      <td>CC</td>
    </tr>
    <tr>
      <th>2</th>
      <td>NaN</td>
      <td>CC1000121261</td>
      <td>1000121261</td>
      <td>202305</td>
      <td>A</td>
      <td>1</td>
      <td>None</td>
      <td>1007860991</td>
      <td>1</td>
      <td>2</td>
      <td>...</td>
      <td>DEPENDIENTE CATEGORIA C CON DERECHO TEMPORAL A...</td>
      <td>13</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>None</td>
      <td>11007860991</td>
      <td>None</td>
      <td>None</td>
      <td>1</td>
      <td>CC</td>
    </tr>
    <tr>
      <th>3</th>
      <td>364243.0</td>
      <td>CC1000121261</td>
      <td>1000121261</td>
      <td>202305</td>
      <td>A</td>
      <td>1</td>
      <td>None</td>
      <td>1083040303</td>
      <td>5</td>
      <td>1</td>
      <td>...</td>
      <td>DEPENDIENTE CATEGORIA C CON DERECHO TEMPORAL A...</td>
      <td>13</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2017-11-02</td>
      <td>51083040303</td>
      <td>201711</td>
      <td>None</td>
      <td>1</td>
      <td>CC</td>
    </tr>
    <tr>
      <th>4</th>
      <td>364243.0</td>
      <td>CC1000121261</td>
      <td>1000121261</td>
      <td>202305</td>
      <td>A</td>
      <td>1</td>
      <td>None</td>
      <td>1083040303</td>
      <td>5</td>
      <td>1</td>
      <td>...</td>
      <td>DEPENDIENTE CATEGORIA C CON DERECHO TEMPORAL A...</td>
      <td>13</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2023-08-28</td>
      <td>51083040303</td>
      <td>202308</td>
      <td>None</td>
      <td>1</td>
      <td>CC</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3832669</th>
      <td>8647200.0</td>
      <td>CC9910609</td>
      <td>9910609</td>
      <td>202409</td>
      <td>A</td>
      <td>1</td>
      <td>None</td>
      <td>1105473400</td>
      <td>2</td>
      <td>1</td>
      <td>...</td>
      <td>DEPENDIENTES (NO INCLUYE: SERVICIO DOMESTICO N...</td>
      <td>1</td>
      <td>1.0</td>
      <td>44491.0</td>
      <td>2021-12-16</td>
      <td>21105473400</td>
      <td>202112</td>
      <td>None</td>
      <td>1</td>
      <td>CC</td>
    </tr>
    <tr>
      <th>3832670</th>
      <td>NaN</td>
      <td>CC9910609</td>
      <td>9910609</td>
      <td>202409</td>
      <td>A</td>
      <td>1</td>
      <td>None</td>
      <td>49597057</td>
      <td>1</td>
      <td>2</td>
      <td>...</td>
      <td>DEPENDIENTES (NO INCLUYE: SERVICIO DOMESTICO N...</td>
      <td>1</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>None</td>
      <td>149597057</td>
      <td>None</td>
      <td>None</td>
      <td>1</td>
      <td>CC</td>
    </tr>
    <tr>
      <th>3832671</th>
      <td>314997.0</td>
      <td>CC9910731</td>
      <td>9910731</td>
      <td>202409</td>
      <td>A</td>
      <td>1</td>
      <td>None</td>
      <td>1082877639</td>
      <td>1</td>
      <td>2</td>
      <td>...</td>
      <td>DEPENDIENTES (NO INCLUYE: SERVICIO DOMESTICO N...</td>
      <td>1</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2015-05-07</td>
      <td>11082877639</td>
      <td>201505</td>
      <td>None</td>
      <td>1</td>
      <td>CC</td>
    </tr>
    <tr>
      <th>3832672</th>
      <td>NaN</td>
      <td>CC9910731</td>
      <td>9910731</td>
      <td>202409</td>
      <td>A</td>
      <td>1</td>
      <td>None</td>
      <td>1082939020</td>
      <td>1</td>
      <td>2</td>
      <td>...</td>
      <td>DEPENDIENTES (NO INCLUYE: SERVICIO DOMESTICO N...</td>
      <td>1</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>None</td>
      <td>11082939020</td>
      <td>None</td>
      <td>None</td>
      <td>1</td>
      <td>CC</td>
    </tr>
    <tr>
      <th>3832673</th>
      <td>310091.0</td>
      <td>CC9910731</td>
      <td>9910731</td>
      <td>202409</td>
      <td>A</td>
      <td>1</td>
      <td>None</td>
      <td>1083018512</td>
      <td>2</td>
      <td>2</td>
      <td>...</td>
      <td>DEPENDIENTES (NO INCLUYE: SERVICIO DOMESTICO N...</td>
      <td>1</td>
      <td>1.0</td>
      <td>44491.0</td>
      <td>2015-02-12</td>
      <td>21083018512</td>
      <td>201502</td>
      <td>None</td>
      <td>1</td>
      <td>CC</td>
    </tr>
  </tbody>
</table>
<p>3832674 rows × 28 columns</p>
</div>

<h3 id="conexion-a-la-base-de-datos-dwh-y-carga-de-tablas">Conexión a la Base de Datos DWH y Carga de Tablas<a class="headerlink" href="#conexion-a-la-base-de-datos-dwh-y-carga-de-tablas" title="Permanent link">&para;</a></h3>
<p>Este código establece una conexión con la base de datos de Data Warehouse (DWH) utilizando <code>create_engine</code> con los detalles de conexión proporcionados por la función <code>obtener_conexion</code>. La función personalizada <code>cargar_tablas</code> se encarga de ejecutar las consultas definidas en <code>qr_structure2</code>, almacenando los resultados en el diccionario <code>df_structure2</code>.</p>
<p>Al final, se ejecuta el método <code>head()</code> en <code>df_structure2['query']</code> para mostrar las primeras filas del DataFrame resultante, permitiendo una verificación rápida de los datos cargados. Esto asegura que la conexión a la base de datos y la carga de datos se han realizado correctamente antes de proceder con el análisis o transformación de datos.</p>
<div class="highlight"><pre><span></span><code><span class="n">qr_structure2</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>{&#39;query&#39;: &quot;\n        SELECT PERIODO, \n               ID_AFILIADO,\n               MAX(CODIGO_DOCUMENTO) as CODIGO_DOCUMENTO, \n               MAX(ID) as ID, \n               MAX(CODBEN) as CODIGO_BENEFICIARIO,  \n               MAX(CODCAT) as CODIGO_CATEGORIA, \n               MAX(CODZON) as CODIGO_ZONA, \n               MAX(CODEST) as CODIGO_ESTADO, \n               TIPO, \n               COD, \n               ESTADO,\n               MAX(SE_RETIRO) as SE_RETIRO, \n               MAX(SE_AFILIO) as SE_AFILIO,  \n               MAX(NUEVO) as NUEVO, \n               MAX(SEXO) as SEXO, \n               MAX(CAPTRA) as CAPACIDAD_TRABAJO, \n               MAX(NIVEL_EDU) as NIVEL_EDUCATIVO, \n               MAX(FECNAC) as FECHA_NACIMIENTO, \n               MAX(PARENT) as PARENTESCO, \n               MAX(CODCIU) as CODIGO_CIUDAD, \n               MAX(CALSUC) as CALIFICACION_SUCURSAL, \n               MAX(TIPAFI) as TIPO_AFILIACION, \n               MAX(NUMCUO) as NUMERO_CUOTAS, \n               MAX(SUBLIQ) as SUBSIDIO_LIQUIDADO  \n        FROM (\n            SELECT \n                   ID_AFILIADO,\n                   CODIGO_DOCUMENTO, \n                   DOCUMENTO as ID, \n                   CODIGO_BENEFICIARIO as CODBEN, \n                   ESTADO, \n                   PERIODO, \n                   CODIGO_ZONA as CODZON, \n                   CODIGO_ESTADO as CODEST, \n                   DOCUMENTO_BENEFICIARIO as COD, \n                   CODIGO_CATEGORIA as CODCAT, \n                   SEXO,\n                   CAPACIDAD_TRABAJO as CAPTRA,\n                   NIVEL_EDUCACION as NIVEL_EDU, \n                   FECHA_NACIMIENTO as FECNAC, \n                   PARENTESCO as PARENT, \n                   CODIGO_CIUDAD as CODCIU, \n                   &#39;Beneficiario&#39; as TIPO, \n                   CALIFICACION_SUCURSAL as CALSUC, \n                   TIPO_AFILIACION as TIPAFI, \n                   NUMERO_CUOTAS as NUMCUO, \n                   SUBSIDIO_LIQUIDADO as SUBLIQ, \n                   IF(PERIODO_RETIRO = PERIODO, 1, 0) as SE_RETIRO,\n                   IF(PERIODO_AFILIACION = PERIODO, 1, 0) as SE_AFILIO,\n                   IF(PERIODO = PERIODO_SISTEMA, 1, 0) as NUEVO\n            FROM dwh.BD_Fact_Beneficiarios_p1 as p\n        ) as h\n        GROUP BY PERIODO, TIPO, COD, ESTADO;\n    &quot;}
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1">#Conexion a base DWH</span>
<span class="n">motor</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">obtener_conexion</span><span class="p">(</span><span class="s1">&#39;dwh&#39;</span><span class="p">))</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CONEXION A DWH &#39;</span><span class="p">)</span>
<span class="n">cargar_tablas</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="n">qr_structure2</span><span class="p">,</span> <span class="n">df_structure2</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
<span class="n">df_structure2</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 11:28:26,277 - INFO - CONEXION A DWH 
2024-10-30 11:28:26,577 - INFO - Cargando query 
2024-10-30 11:31:42,403 - INFO - Cargada query, 3,371,398 registros finales obtenidos. --- 3.26 minutes ---
2024-10-30 11:31:42,714 - INFO - CARGUE TABLAS DESDE MYSQL --- query --- 3.27 minutes ---
</code></pre></div>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PERIODO</th>
      <th>ID_AFILIADO</th>
      <th>CODIGO_DOCUMENTO</th>
      <th>ID</th>
      <th>CODIGO_BENEFICIARIO</th>
      <th>CODIGO_CATEGORIA</th>
      <th>CODIGO_ZONA</th>
      <th>CODIGO_ESTADO</th>
      <th>TIPO</th>
      <th>COD</th>
      <th>...</th>
      <th>SEXO</th>
      <th>CAPACIDAD_TRABAJO</th>
      <th>NIVEL_EDUCATIVO</th>
      <th>FECHA_NACIMIENTO</th>
      <th>PARENTESCO</th>
      <th>CODIGO_CIUDAD</th>
      <th>CALIFICACION_SUCURSAL</th>
      <th>TIPO_AFILIACION</th>
      <th>NUMERO_CUOTAS</th>
      <th>SUBSIDIO_LIQUIDADO</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>202305</td>
      <td>CC1000120248</td>
      <td>1</td>
      <td>1084067407</td>
      <td>406348.0</td>
      <td>1</td>
      <td>47001</td>
      <td>None</td>
      <td>Beneficiario</td>
      <td>51084067407</td>
      <td>...</td>
      <td>1</td>
      <td>2</td>
      <td>01</td>
      <td>2019-12-14</td>
      <td>1</td>
      <td>None</td>
      <td>DEPENDIENTE CATEGORIA C CON DERECHO TEMPORAL A...</td>
      <td>13</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>202305</td>
      <td>CC1000120248</td>
      <td>1</td>
      <td>1128144889</td>
      <td>NaN</td>
      <td>1</td>
      <td>47001</td>
      <td>None</td>
      <td>Beneficiario</td>
      <td>11128144889</td>
      <td>...</td>
      <td>2</td>
      <td>2</td>
      <td>None</td>
      <td>2002-03-07</td>
      <td>5</td>
      <td>None</td>
      <td>DEPENDIENTE CATEGORIA C CON DERECHO TEMPORAL A...</td>
      <td>13</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>202305</td>
      <td>CC1000121261</td>
      <td>1</td>
      <td>1007860991</td>
      <td>NaN</td>
      <td>1</td>
      <td>47001</td>
      <td>None</td>
      <td>Beneficiario</td>
      <td>11007860991</td>
      <td>...</td>
      <td>2</td>
      <td>2</td>
      <td>None</td>
      <td>1998-11-12</td>
      <td>5</td>
      <td>None</td>
      <td>DEPENDIENTE CATEGORIA C CON DERECHO TEMPORAL A...</td>
      <td>13</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>202305</td>
      <td>CC1000121261</td>
      <td>1</td>
      <td>1083040303</td>
      <td>364243.0</td>
      <td>1</td>
      <td>47001</td>
      <td>None</td>
      <td>Beneficiario</td>
      <td>51083040303</td>
      <td>...</td>
      <td>1</td>
      <td>2</td>
      <td>01</td>
      <td>2016-10-27</td>
      <td>1</td>
      <td>None</td>
      <td>DEPENDIENTE CATEGORIA C CON DERECHO TEMPORAL A...</td>
      <td>13</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>202305</td>
      <td>CC1000121261</td>
      <td>1</td>
      <td>1084469342</td>
      <td>8626426.0</td>
      <td>1</td>
      <td>47001</td>
      <td>None</td>
      <td>Beneficiario</td>
      <td>51084469342</td>
      <td>...</td>
      <td>1</td>
      <td>2</td>
      <td>01</td>
      <td>2019-10-22</td>
      <td>1</td>
      <td>None</td>
      <td>DEPENDIENTE CATEGORIA C CON DERECHO TEMPORAL A...</td>
      <td>13</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 24 columns</p>
</div>

<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="n">df_structure2</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">][</span><span class="s1">&#39;PERIODO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>[&#39;202305&#39; &#39;202306&#39; &#39;202307&#39; &#39;202308&#39; &#39;202309&#39; &#39;202310&#39; &#39;202311&#39; &#39;202312&#39;
 &#39;202401&#39; &#39;202402&#39; &#39;202403&#39; &#39;202404&#39; &#39;202405&#39; &#39;202406&#39; &#39;202407&#39; &#39;202408&#39;
 &#39;202409&#39;]
</code></pre></div>

<h3 id="guardado-de-datos-en-dwh-y-verificacion-de-columnas">Guardado de Datos en DWH y Verificación de Columnas<a class="headerlink" href="#guardado-de-datos-en-dwh-y-verificacion-de-columnas" title="Permanent link">&para;</a></h3>
<p>En este código, el DataFrame <code>df_final2</code> (cargado desde <code>df_structure2['query']</code>) se guarda en la base de datos DWH en la tabla <code>BD_Fact_Beneficiarios_p2</code> utilizando la función <code>guardar_en_dwh</code>. Esta función recibe <code>multiple=False</code> para realizar una carga única y <code>if_exists='replace'</code> para reemplazar la tabla si ya existe en la base de datos, asegurando que los datos más recientes reemplacen cualquier versión anterior.</p>
<p>Al final, <code>df_final2.columns.to_list()</code> se usa para obtener una lista de los nombres de columnas en <code>df_final2</code>, permitiendo verificar rápidamente que las columnas están en el orden y con los nombres esperados antes de completar el proceso de carga.</p>
<div class="highlight"><pre><span></span><code><span class="n">df_final2</span> <span class="o">=</span> <span class="n">df_structure2</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span>

<span class="n">guardar_en_dwh</span><span class="p">(</span><span class="n">df_final2</span><span class="p">,</span> <span class="s1">&#39;BD_Fact_Beneficiarios_p2&#39;</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
<span class="n">df_final2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 11:31:43,061 - INFO - Intentando conexión a la base DWH...
2024-10-30 11:31:43,062 - INFO - Conexión a la base DWH establecida con éxito.
2024-10-30 11:31:43,387 - INFO - Almacenando tabla única en DWH como BD_Fact_Beneficiarios_p2
2024-10-30 11:40:19,134 - INFO - Tabla almacenada correctamente. 3,371,398 registros finales obtenidos.
2024-10-30 11:40:22,203 - INFO - ALMACENAMIENTO ---  --- 8.65 minutes ---
2024-10-30 11:40:22,204 - INFO - Finalizando proceso de almacenamiento en DWH.





[&#39;PERIODO&#39;,
 &#39;ID_AFILIADO&#39;,
 &#39;CODIGO_DOCUMENTO&#39;,
 &#39;ID&#39;,
 &#39;CODIGO_BENEFICIARIO&#39;,
 &#39;CODIGO_CATEGORIA&#39;,
 &#39;CODIGO_ZONA&#39;,
 &#39;CODIGO_ESTADO&#39;,
 &#39;TIPO&#39;,
 &#39;COD&#39;,
 &#39;ESTADO&#39;,
 &#39;SE_RETIRO&#39;,
 &#39;SE_AFILIO&#39;,
 &#39;NUEVO&#39;,
 &#39;SEXO&#39;,
 &#39;CAPACIDAD_TRABAJO&#39;,
 &#39;NIVEL_EDUCATIVO&#39;,
 &#39;FECHA_NACIMIENTO&#39;,
 &#39;PARENTESCO&#39;,
 &#39;CODIGO_CIUDAD&#39;,
 &#39;CALIFICACION_SUCURSAL&#39;,
 &#39;TIPO_AFILIACION&#39;,
 &#39;NUMERO_CUOTAS&#39;,
 &#39;SUBSIDIO_LIQUIDADO&#39;]
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;FINAL ETL --- </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> seconds ---&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 11:40:22,218 - INFO - FINAL ETL --- 1886.17 seconds ---
</code></pre></div>

<h1 id="42-factcolegio">4.2-FactColegio<a class="headerlink" href="#42-factcolegio" title="Permanent link">&para;</a></h1>
<h1 id="42-factcolegio_1">4.2-FactColegio<a class="headerlink" href="#42-factcolegio_1" title="Permanent link">&para;</a></h1>
<h1 id="42-fact-colegio">4.2 Fact Colegio<a class="headerlink" href="#42-fact-colegio" title="Permanent link">&para;</a></h1>
<h2 id="introduccion_2">Introducción<a class="headerlink" href="#introduccion_2" title="Permanent link">&para;</a></h2>
<p>El proceso ETL para <code>FactColegio</code> permite extraer, transformar y cargar información de estudiantes, acudientes, matrículas, y grados de una base de datos de colegio hacia un Data Warehouse (DWH). Este proceso se enfoca en estructurar datos personales y académicos, así como en estandarizar las direcciones de estudiantes y acudientes. El flujo ETL emplea consultas SQL para extraer los datos, transformaciones para limpieza y deduplicación, y una carga final en el DWH con nombres de tablas predefinidos. Este procedimiento asegura la disponibilidad de datos estandarizados y listos para análisis y reportes en el entorno del DWH.</p>
<h3 id="diagrama-de-secuencia-del-proceso-etl_3">Diagrama de Secuencia del Proceso ETL<a class="headerlink" href="#diagrama-de-secuencia-del-proceso-etl_3" title="Permanent link">&para;</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    title Diagrama de Secuencia del Proceso ETL - FactColegio
    participant 👤 Usuario
    participant ETL_Script
    participant Minerva_DB as Base de Datos Minerva
    participant DWH as Data Warehouse

    👤 Usuario -&gt;&gt; ETL_Script: Ejecuta el script ETL
    ETL_Script -&gt;&gt; ETL_Script: Configura entorno y logger
    ETL_Script -&gt;&gt; Minerva_DB: Conecta a BD Minerva
    Minerva_DB --&gt;&gt; ETL_Script: Conexión exitosa
    ETL_Script -&gt;&gt; Minerva_DB: Ejecuta consulta SQL para datos de estudiantes, acudientes, matrículas, y grados
    Minerva_DB --&gt;&gt; ETL_Script: Retorna datos de entidades del colegio
    ETL_Script -&gt;&gt; ETL_Script: Estandariza direcciones y elimina duplicados
    ETL_Script -&gt;&gt; DWH: Conecta a BD DWH
    DWH --&gt;&gt; ETL_Script: Conexión exitosa
    ETL_Script -&gt;&gt; DWH: Carga tablas transformadas y dimensionales en el DWH
    DWH --&gt;&gt; ETL_Script: Confirmación de carga exitosa
    ETL_Script -&gt;&gt; 👤 Usuario: Finaliza proceso ETL y registra tiempo</code></pre>
<h2 id="etl_3">ETL<a class="headerlink" href="#etl_3" title="Permanent link">&para;</a></h2>
<h3 id="importacion-de-librerias-y-funciones_3">Importación de librerías y funciones<a class="headerlink" href="#importacion-de-librerias-y-funciones_3" title="Permanent link">&para;</a></h3>
<p>Este código configura el entorno para la manipulación de datos en un Data Warehouse, importando librerías clave como <code>pandas</code>, <code>sqlalchemy</code> y <code>logging</code> para el manejo de datos, conexiones de base y registro de eventos. También se cargan funciones personalizadas del módulo <code>Funciones.py</code>, incluyendo <code>guardar_en_dwh</code>, <code>StoreDuplicated</code>, <code>estandarizar_direccion</code>, y <code>marcar_direcciones_estandarizadas</code>, que facilitan la carga, estandarización y validación de datos. La prueba <code>testfunciones()</code> asegura que estas funciones están correctamente importadas y operativas.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="nn">sa</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">insert</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># Agrega el directorio al sys.path</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;../funciones&#39;</span><span class="p">))</span>
<span class="c1"># Importa las funciones desde el archivo Funciones.py</span>
<span class="kn">from</span> <span class="nn">Funciones</span> <span class="kn">import</span> <span class="n">guardar_en_dwh</span><span class="p">,</span> <span class="n">StoreDuplicated</span><span class="p">,</span> <span class="n">obtener_conexion</span><span class="p">,</span> <span class="n">cargar_tablas</span><span class="p">,</span> <span class="n">testfunciones</span><span class="p">,</span> <span class="n">setup_logger</span><span class="p">,</span><span class="n">estandarizar_direccion</span><span class="p">,</span><span class="n">marcar_direcciones_estandarizadas</span>
<span class="nb">print</span><span class="p">(</span><span class="n">testfunciones</span><span class="p">())</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>Importacion de funciones correcta, 30-10-2024 12:28
</code></pre></div>

<h3 id="configuracion-inicial-del-logger">Configuración inicial del logger<a class="headerlink" href="#configuracion-inicial-del-logger" title="Permanent link">&para;</a></h3>
<p>Se configura el logger para registrar eventos del proceso ETL en el archivo <code>Colegio.log</code>, utilizando el nivel de detalle <code>INFO</code>. También se registra el inicio del proceso, y se almacena la hora de inicio para medir el tiempo total de ejecución.</p>
<div class="highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="n">log_filename</span><span class="o">=</span><span class="s1">&#39;Colegio.log&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;COMIENZO ETL&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 12:28:00,767 - INFO - COMIENZO ETL
</code></pre></div>

<h3 id="definicion-de-consultas-para-datos-de-colegio">Definición de Consultas para Datos de Colegio<a class="headerlink" href="#definicion-de-consultas-para-datos-de-colegio" title="Permanent link">&para;</a></h3>
<p>Este código configura las consultas SQL en el diccionario <code>qr_structure</code> para obtener datos de diversas tablas relacionadas con estudiantes, acudientes, matrículas, grados y niveles educativos en una base de datos de colegio. Cada consulta extrae y renombra columnas específicas de las tablas <code>colegio12</code>, <code>colegio13</code>, <code>colegio15</code>, y <code>colegio03</code> para estandarizar los datos. El diccionario <code>dim_names</code> asigna nombres descriptivos para identificar cada consulta en <code>df_structure</code>, donde se almacenarán los resultados. Esta configuración permite la carga y procesamiento eficiente de datos escolares para análisis posteriores.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Lista de querys</span>
<span class="n">qr_structure</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;colegio12&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;select </span>
<span class="s1">                ano as ANIO,</span>
<span class="s1">                CONCAT(coddoc,numdoc) AS ID_AFILIADO,</span>
<span class="s1">                coddoc AS TIPO_DOCUMENTO,</span>
<span class="s1">                numdoc AS DOCUMENTO,</span>
<span class="s1">                ciuexp AS CIUDAD_EXPEDICION,</span>
<span class="s1">                priape AS PRIMER_APELLIDO,</span>
<span class="s1">                segape AS SEGUNDO_APELLIDO,</span>
<span class="s1">                prinom AS PRIMER_NOMBRE,</span>
<span class="s1">                segnom AS SEGUNDO_NOMBRE,</span>
<span class="s1">                rh,</span>
<span class="s1">                eps,</span>
<span class="s1">                codsex AS CODSEX,</span>
<span class="s1">                ciunac AS CIUDAD_NACIMIENTO,</span>
<span class="s1">                fecnac AS FECHA_NACIMIENTO,</span>
<span class="s1">                dirres AS DIRECCION,</span>
<span class="s1">                barrio AS BARRIO,</span>
<span class="s1">                estrato AS ESTRATO,</span>
<span class="s1">                codciu AS CODIGO_CIUDAD,</span>
<span class="s1">                telres AS TELEFONO,</span>
<span class="s1">                email,</span>
<span class="s1">                nota,</span>
<span class="s1">                observacion,</span>
<span class="s1">                docpad AS DOCUMENTO_PADRE,</span>
<span class="s1">                docmad AS DOCUMENTO_MADRE,</span>
<span class="s1">                docacu AS DOCUMENTO_ACUDIENTE,</span>
<span class="s1">                codben,</span>
<span class="s1">                codcat,</span>
<span class="s1">                tipo AS TIPO_ESTUDIANTE</span>
<span class="s1">                from colegio.colegio12&#39;&#39;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;colegio13&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;select </span>
<span class="s1">                CONCAT(coddoc,numdoc) AS ID_AFILIADO,</span>
<span class="s1">                coddoc AS TIPO_DOCUMENTO,</span>
<span class="s1">                numdoc AS DOCUMENTO,</span>
<span class="s1">                ciuexp AS CIUDAD_EXPEDICION,</span>
<span class="s1">                priape AS PRIMER_APELLIDO,</span>
<span class="s1">                segape AS SEGUNDO_APELLIDO,</span>
<span class="s1">                prinom AS PRIMER_NOMBRE,</span>
<span class="s1">                segnom AS SEGUNDO_NOMBRE,</span>
<span class="s1">                codpar AS COD_PARENTESCO,</span>
<span class="s1">                profesion,</span>
<span class="s1">                empresa,</span>
<span class="s1">                ocupacion,</span>
<span class="s1">                codsex,</span>
<span class="s1">                direccion,</span>
<span class="s1">                codciu AS CODIGO_CIUDAD,</span>
<span class="s1">                telefono,</span>
<span class="s1">                email</span>
<span class="s1">                from colegio.colegio13&#39;&#39;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;colegio15&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;select </span>
<span class="s1">                c15.ano as ANIO,</span>
<span class="s1">                c15.nummat AS NUMERO_MATRICULA,</span>
<span class="s1">                concat(c12.coddoc,c15.numdoc) AS ID_AFILIADO,</span>
<span class="s1">                c15.codgra AS COD_GRADO,</span>
<span class="s1">                c15.codgru AS COD_GRUPO,</span>
<span class="s1">                c15.fecmat AS FECHA_MATRICULA,</span>
<span class="s1">                c15.colant AS COLEGIO_ANTERIOR,</span>
<span class="s1">                c15.numlib AS NUMERO_LIBRO_REGISTRO,</span>
<span class="s1">                c15.numfol AS NUMERO_FOLIO_REGISTRO,</span>
<span class="s1">                c15.codcon AS COD_CONVENIO,</span>
<span class="s1">                c15.codest AS COD_ESTADO,</span>
<span class="s1">                c15.codcat,</span>
<span class="s1">                c15.estado,</span>
<span class="s1">                c15.fecest AS FECHA_ESTADO,</span>
<span class="s1">                c15.motivo AS MOTIVO_NOVEDAD,</span>
<span class="s1">                c15.usuario,</span>
<span class="s1">                c15.estbol AS ESTADO_BOLETIN</span>
<span class="s1">                from colegio.colegio15 c15</span>
<span class="s1">            LEFT JOIN colegio.colegio12 c12 on c15.ano = c12.ano and c15.numdoc = c12.numdoc&#39;&#39;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;colegio03&quot;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;SELECT </span>
<span class="s1">                c03.codgra AS COD_GRADO,</span>
<span class="s1">                c03.detalle AS GRADO,</span>
<span class="s1">                c02.detalle AS NIVEL_EDUCATIVO,</span>
<span class="s1">                c03.numcup AS NUMERO_CUPOS</span>
<span class="s1">            FROM colegio.colegio03 c03</span>
<span class="s1">            LEFT JOIN colegio.colegio02 c02 on c03.nivedu = c02.nivedu    </span>
<span class="s1">    &#39;&#39;&#39;</span>
               <span class="p">}</span>
<span class="n">dim_names</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;colegio12&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Fact_Colegio_Estudiantes&#39;</span><span class="p">,</span>
    <span class="s2">&quot;colegio13&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Fact_Colegio_Acudientes&#39;</span><span class="p">,</span>
    <span class="s2">&quot;colegio15&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Fact_Colegio_Matriculas&#39;</span><span class="p">,</span>
    <span class="s2">&quot;BD_Dim_Colegio_Calendario&quot;</span> <span class="p">:</span> <span class="s2">&quot;BD_Dim_Colegio_Calendario&quot;</span><span class="p">,</span>
    <span class="s2">&quot;colegio03&quot;</span><span class="p">:</span> <span class="s2">&quot;BD_Dim_Colegio_Grados&quot;</span>
               <span class="p">}</span>
<span class="n">df_structure</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;LECTURA DE QUERYS&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 12:28:00,782 - INFO - LECTURA DE QUERYS
</code></pre></div>

<h3 id="carga-de-tablas-desde-sql">Carga de tablas desde SQL<a class="headerlink" href="#carga-de-tablas-desde-sql" title="Permanent link">&para;</a></h3>
<p>Se ejecutan las consultas SQL definidas en <code>qr_structure</code> y los resultados se almacenan en el diccionario <code>df_structure</code>. Para cada consulta, se utiliza un bloque <code>with</code> para manejar la conexión a la base de datos de manera segura. El nombre de cada tabla cargada se registra en el log junto con el tiempo total del proceso de carga desde MySQL.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Conexion a base Minerva</span>
<span class="n">motor</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">obtener_conexion</span><span class="p">(</span><span class="s1">&#39;minerva&#39;</span><span class="p">))</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CONEXION A BASE MINERVA&#39;</span><span class="p">)</span>
<span class="n">cargar_tablas</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="n">qr_structure</span><span class="p">,</span> <span class="n">df_structure</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 12:28:00,852 - INFO - CONEXION A BASE MINERVA
2024-10-30 12:28:01,177 - INFO - Cargando colegio12 
2024-10-30 12:28:01,640 - INFO - Cargada colegio12, 2,501 registros finales obtenidos. --- 0.46 seconds ---
2024-10-30 12:28:01,641 - INFO - Cargando colegio13 
2024-10-30 12:28:01,815 - INFO - Cargada colegio13, 1,291 registros finales obtenidos. --- 0.17 seconds ---
2024-10-30 12:28:01,816 - INFO - Cargando colegio15 
2024-10-30 12:28:01,970 - INFO - Cargada colegio15, 2,243 registros finales obtenidos. --- 0.15 seconds ---
2024-10-30 12:28:01,971 - INFO - Cargando colegio03 
2024-10-30 12:28:02,003 - INFO - Cargada colegio03, 13 registros finales obtenidos. --- 0.03 seconds ---
2024-10-30 12:28:02,062 - INFO - CARGUE TABLAS DESDE MYSQL --- colegio03 --- 1.21 seconds ---
</code></pre></div>

<h3 id="validacion-y-eliminacion-de-campos-duplicados-en-tablas">Validación y Eliminación de Campos Duplicados en Tablas<a class="headerlink" href="#validacion-y-eliminacion-de-campos-duplicados-en-tablas" title="Permanent link">&para;</a></h3>
<p>Este código recorre las tablas almacenadas en <code>df_structure</code> y realiza una validación para detectar y registrar valores duplicados en cada tabla. Para cada tabla, genera una lista de columnas a comparar (<code>ColumnsToCompare</code>), excluyendo el campo <code>id</code>. La función <code>StoreDuplicated</code> verifica duplicados en función de estas columnas y genera un archivo de trazabilidad con el nombre <code>\trazaDuplicados_</code> seguido del nombre de la tabla.</p>
<p>Una vez verificados los duplicados, se eliminan las filas duplicadas, dejando solo registros únicos. Los tiempos de ejecución de esta operación se registran en <code>validador_time</code>, proporcionando un resumen del proceso en segundos al finalizar.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Validador de campos repetidos </span>
<span class="n">validador_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">ky</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_structure</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>   
    <span class="n">ColumnsToCompare</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;id&#39;</span> <span class="p">]</span> <span class="p">]</span>
    <span class="n">StoreDuplicated</span><span class="p">(</span><span class="s1">&#39;N/A&#39;</span> <span class="p">,</span> <span class="n">ColumnsToCompare</span><span class="p">,</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">],</span> <span class="sa">r</span><span class="s1">&#39;\trazaDuplicados_&#39;</span> <span class="o">+</span> <span class="n">ky</span> <span class="p">)</span>
    <span class="c1">#Limpieza inicial quitar duplicados</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;VALIDADOR TABLA: &#39;</span><span class="o">+</span> <span class="n">ky</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;VALIDADOR DUPLICADOS --- </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">validador_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> seconds ---&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 12:28:02,124 - INFO - VALIDADOR TABLA: colegio12
2024-10-30 12:28:02,148 - INFO - VALIDADOR TABLA: colegio13
2024-10-30 12:28:02,171 - INFO - VALIDADOR TABLA: colegio15
2024-10-30 12:28:02,178 - INFO - VALIDADOR TABLA: colegio03
2024-10-30 12:28:02,180 - INFO - VALIDADOR DUPLICADOS --- 0.11 seconds ---
</code></pre></div>

<h3 id="transformacion-y-limpieza-de-datos-en-tablas">Transformación y Limpieza de Datos en Tablas<a class="headerlink" href="#transformacion-y-limpieza-de-datos-en-tablas" title="Permanent link">&para;</a></h3>
<p>Este código realiza una serie de transformaciones de limpieza en cada tabla dentro de <code>df_structure</code>. Primero, convierte todos los nombres de columnas a mayúsculas para asegurar consistencia en el formato. Luego, se aplica una transformación en todas las columnas de tipo texto para pasar su contenido a mayúsculas y eliminar espacios en blanco al inicio y al final de cada valor, manteniendo la uniformidad en el formato.</p>
<p>Finalmente, reemplaza los valores <code>"NAN"</code> y <code>"NONE"</code> por <code>NaN</code> de NumPy, asegurando que los datos faltantes estén correctamente etiquetados. El tiempo de ejecución de estas transformaciones se registra y se muestra en <code>limpieza_time</code>.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Transformación 2</span>
<span class="n">limpieza_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">ky</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_structure</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="c1">#print(ky)</span>
    <span class="c1"># Convertir todos los nombres de las columnas a mayúsculas</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="c1">#Pasar las columnas tipo texto a UPPER</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="c1">#En las columnas tipo texto, eliminar espacios al comienzo y al final</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="c1">#Reemplazar los &quot;NAN&quot; o &quot;NONE&quot; por NaN</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;NAN&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;NONE&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;LIMPIEZA  --- </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">limpieza_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> seconds ---&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 12:28:02,326 - INFO - LIMPIEZA  --- 0.14 seconds ---
</code></pre></div>

<h3 id="creacion-de-tabla-dimensional-para-anos-de-calendario">Creación de Tabla Dimensional para Años de Calendario<a class="headerlink" href="#creacion-de-tabla-dimensional-para-anos-de-calendario" title="Permanent link">&para;</a></h3>
<p>Este código extrae la columna <code>ANIO</code> de la tabla de matrículas (<code>colegio15</code>) en <code>df_structure</code>, obtiene los valores únicos de esa columna y crea un nuevo DataFrame <code>df_valores_unicos</code> con estos valores. Este DataFrame sirve como una tabla dimensional de años (<code>BD_Dim_Colegio_Calendario</code>), almacenando los distintos años de calendario de las matrículas en <code>df_structure</code> para su uso en análisis de tiempo o relaciones entre tablas.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Obtener la tabla original desde df_structure</span>
<span class="n">tabla</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="s1">&#39;colegio15&#39;</span><span class="p">]</span>

<span class="c1"># Obtener los valores únicos de la columna &#39;TIPO&#39;</span>
<span class="n">valores_unicos</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tabla</span><span class="p">[</span><span class="s1">&#39;ANIO&#39;</span><span class="p">])</span>

<span class="c1"># Crear un DataFrame a partir de los valores únicos con la columna renombrada</span>
<span class="n">df_valores_unicos</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">valores_unicos</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ANIO&#39;</span><span class="p">])</span>

<span class="c1"># Crear Dim</span>
<span class="n">df_structure</span><span class="p">[</span><span class="s1">&#39;BD_Dim_Colegio_Calendario&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_valores_unicos</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_structure</span><span class="p">[</span><span class="s1">&#39;BD_Dim_Colegio_Calendario&#39;</span><span class="p">]</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ANIO</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2020</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2021</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2022</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2023</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2024</td>
    </tr>
  </tbody>
</table>
</div>

<h3 id="estandarizacion-de-direcciones-para-estudiantes-y-acudientes">Estandarización de Direcciones para Estudiantes y Acudientes<a class="headerlink" href="#estandarizacion-de-direcciones-para-estudiantes-y-acudientes" title="Permanent link">&para;</a></h3>
<p>Este bloque de código realiza la estandarización de direcciones en los DataFrames <code>df_estudiantes</code> y <code>df_acudientes</code>, extraídos de <code>df_structure</code>. Primero, renombra la columna <code>DIRECCION</code> a <code>DIRECCION_ORIGINAL</code> y asegura que sea de tipo texto para ambos DataFrames. Luego, aplica la función <code>estandarizar_direccion</code> en <code>DIRECCION_ORIGINAL</code> para generar una columna <code>DIRECCION_LIMPIA</code> con las direcciones en un formato estandarizado.</p>
<p>Posteriormente, utiliza <code>marcar_direcciones_estandarizadas</code> para agregar una columna que indique si la dirección estandarizada comienza con una de las abreviaturas esperadas. Finalmente, las tablas estandarizadas se actualizan en <code>df_structure</code>, dejando las direcciones listas para su análisis y asegurando consistencia en el formato de dirección.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Para estudiantes</span>
<span class="n">df_estudiantes</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="s1">&#39;colegio12&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Asegurarse de que la columna DIRECCION_ORIGINAL es de tipo texto</span>
<span class="n">df_estudiantes</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;DIRECCION&#39;</span><span class="p">:</span><span class="s1">&#39;DIRECCION_ORIGINAL&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_estudiantes</span><span class="p">[</span><span class="s1">&#39;DIRECCION_ORIGINAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_estudiantes</span><span class="p">[</span><span class="s1">&#39;DIRECCION_ORIGINAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="c1"># Aplicamos la estandarización a todas las direcciones y creamos una nueva columna con las direcciones estandarizadas</span>

<span class="n">df_estudiantes</span><span class="p">[</span><span class="s1">&#39;DIRECCION_LIMPIA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_estudiantes</span><span class="p">[</span><span class="s1">&#39;DIRECCION_ORIGINAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">estandarizar_direccion</span><span class="p">)</span>

<span class="c1"># Agregar columna &#39;DIRECCION_ESTANDARIZADA&#39; si la direccion empieza con algunas de las abreviaturas estandarizadas</span>
<span class="n">marcar_direcciones_estandarizadas</span><span class="p">(</span><span class="n">df_estudiantes</span><span class="p">,</span> <span class="s1">&#39;DIRECCION_LIMPIA&#39;</span><span class="p">)</span>

<span class="n">df_structure</span><span class="p">[</span><span class="s1">&#39;colegio12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_estudiantes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1">#df_structure[&#39;colegio12&#39;]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Para acudientes</span>
<span class="n">df_acudientes</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="s1">&#39;colegio13&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Asegurarse de que la columna DIRECCION_ORIGINAL es de tipo texto</span>
<span class="n">df_acudientes</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;DIRECCION&#39;</span><span class="p">:</span><span class="s1">&#39;DIRECCION_ORIGINAL&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_acudientes</span><span class="p">[</span><span class="s1">&#39;DIRECCION_ORIGINAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_acudientes</span><span class="p">[</span><span class="s1">&#39;DIRECCION_ORIGINAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="c1"># Aplicamos la estandarización a todas las direcciones y creamos una nueva columna con las direcciones estandarizadas</span>

<span class="n">df_acudientes</span><span class="p">[</span><span class="s1">&#39;DIRECCION_LIMPIA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_acudientes</span><span class="p">[</span><span class="s1">&#39;DIRECCION_ORIGINAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">estandarizar_direccion</span><span class="p">)</span>

<span class="c1"># Agregar columna &#39;DIRECCION_ESTANDARIZADA&#39; si la direccion empieza con algunas de las abreviaturas estandarizadas</span>
<span class="n">marcar_direcciones_estandarizadas</span><span class="p">(</span><span class="n">df_acudientes</span><span class="p">,</span> <span class="s1">&#39;DIRECCION_LIMPIA&#39;</span><span class="p">)</span>

<span class="n">df_structure</span><span class="p">[</span><span class="s1">&#39;colegio13&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_acudientes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1">#df_structure[&#39;colegio13&#39;]</span>
</code></pre></div>
<h3 id="conexion-a-la-base-de-datos-dwh">Conexión a la base de datos DWH<a class="headerlink" href="#conexion-a-la-base-de-datos-dwh" title="Permanent link">&para;</a></h3>
<p>Se establece la conexión con la base de datos DWH utilizando la función <code>Conexion_dwh()</code> y se crea el motor de conexión con <code>create_engine()</code>. El evento de conexión exitosa se registra en el log.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#---------------------------------------------</span>
<span class="c1">#Conexion a base dwh</span>
<span class="n">motor2</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">obtener_conexion</span><span class="p">(</span><span class="s1">&#39;dwh&#39;</span><span class="p">))</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CONEXION A BASE DWH&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 12:28:02,430 - INFO - CONEXION A BASE DWH
</code></pre></div>

<h3 id="guardar-en-base-de-datos-dwh_2">Guardar en base de datos DWH<a class="headerlink" href="#guardar-en-base-de-datos-dwh_2" title="Permanent link">&para;</a></h3>
<p>Se guarda cada tabla del diccionario <code>df_structure</code> en su respectiva tabla en la base de datos DWH, utilizando los nombres definidos en <code>dim_names</code>. El contenido de cada tabla se reemplaza si ya existe en la base de datos. El tiempo total de almacenamiento se registra en el log.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Conexion a base dwh</span>

<span class="n">guardar_en_dwh</span><span class="p">(</span><span class="n">df_structure</span><span class="p">,</span> <span class="n">dim_names</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 12:28:02,440 - INFO - Intentando conexión a la base DWH...
2024-10-30 12:28:02,442 - INFO - Conexión a la base DWH establecida con éxito.
2024-10-30 12:28:02,730 - INFO - Almacenando tabla colegio12 en DWH como BD_Fact_Colegio_Estudiantes
2024-10-30 12:28:04,964 - INFO - Tabla colegio12 almacenada correctamente como BD_Fact_Colegio_Estudiantes.
2024-10-30 12:28:04,965 - INFO - Almacenando tabla colegio13 en DWH como BD_Fact_Colegio_Acudientes
2024-10-30 12:28:06,820 - INFO - Tabla colegio13 almacenada correctamente como BD_Fact_Colegio_Acudientes.
2024-10-30 12:28:06,820 - INFO - Almacenando tabla colegio15 en DWH como BD_Fact_Colegio_Matriculas
2024-10-30 12:28:08,041 - INFO - Tabla colegio15 almacenada correctamente como BD_Fact_Colegio_Matriculas.
2024-10-30 12:28:08,042 - INFO - Almacenando tabla colegio03 en DWH como BD_Dim_Colegio_Grados
2024-10-30 12:28:08,625 - INFO - Tabla colegio03 almacenada correctamente como BD_Dim_Colegio_Grados.
2024-10-30 12:28:08,627 - INFO - Almacenando tabla BD_Dim_Colegio_Calendario en DWH como BD_Dim_Colegio_Calendario
2024-10-30 12:28:09,123 - INFO - Tabla BD_Dim_Colegio_Calendario almacenada correctamente como BD_Dim_Colegio_Calendario.
2024-10-30 12:28:09,181 - INFO - ALMACENAMIENTO ---  --- 6.74 seconds ---
2024-10-30 12:28:09,182 - INFO - Finalizando proceso de almacenamiento en DWH.
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;FINAL ETL --- </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> seconds ---&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 12:28:09,191 - INFO - FINAL ETL --- 8.44 seconds ---
</code></pre></div>

<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h1 id="52-factserviciosocial">5.2-FactServicioSocial<a class="headerlink" href="#52-factserviciosocial" title="Permanent link">&para;</a></h1>
<h1 id="52-factserviciosocial_1">5.2-FactServicioSocial<a class="headerlink" href="#52-factserviciosocial_1" title="Permanent link">&para;</a></h1>
<h1 id="52-fact-servicio-social">5.2 Fact Servicio Social<a class="headerlink" href="#52-fact-servicio-social" title="Permanent link">&para;</a></h1>
<h2 id="introduccion_3">Introducción<a class="headerlink" href="#introduccion_3" title="Permanent link">&para;</a></h2>
<p>El proceso ETL <code>FactServicioSocial</code> permite extraer, transformar y cargar información clave sobre estudiantes y sus parientes en un Data Warehouse. Las tablas origen se extraen de dos bases (<code>nsijec</code> y <code>saipi</code>), se realizan validaciones de duplicados, limpieza de texto y estandarización de direcciones, asegurando que los datos cargados en el DWH sean completos, consistentes y listos para análisis posteriores.</p>
<h3 id="diagrama-de-secuencia-del-proceso-etl_4">Diagrama de Secuencia del Proceso ETL<a class="headerlink" href="#diagrama-de-secuencia-del-proceso-etl_4" title="Permanent link">&para;</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    title Diagrama de Secuencia del Proceso ETL - FactServicioSocial
    participant 👤 Usuario
    participant ETL_Script
    participant Minerva_DB as Base de Datos Minerva
    participant Neith_DB as Base de Datos Neith
    participant DWH as Data Warehouse

    👤 Usuario -&gt;&gt; ETL_Script: Ejecuta el script ETL
    ETL_Script -&gt;&gt; ETL_Script: Configura entorno y logger
    ETL_Script -&gt;&gt; Minerva_DB: Conecta a BD Minerva
    Minerva_DB --&gt;&gt; ETL_Script: Conexión exitosa
    ETL_Script -&gt;&gt; Minerva_DB: Ejecuta consulta SQL para extraer `estudiantes`
    Minerva_DB --&gt;&gt; ETL_Script: Retorna datos de `estudiantes`
    ETL_Script -&gt;&gt; Neith_DB: Conecta a BD Neith
    Neith_DB --&gt;&gt; ETL_Script: Conexión exitosa
    ETL_Script -&gt;&gt; Neith_DB: Ejecuta consultas SQL para extraer `personas_saipi`, `acudientes`, `registros`, `valoracion`
    Neith_DB --&gt;&gt; ETL_Script: Retorna datos de `saipi`
    ETL_Script -&gt;&gt; ETL_Script: Valida duplicados y transforma datos
    ETL_Script -&gt;&gt; ETL_Script: Estandariza direcciones
    ETL_Script -&gt;&gt; DWH: Conecta a BD DWH
    DWH --&gt;&gt; ETL_Script: Conexión exitosa
    ETL_Script -&gt;&gt; DWH: Carga datos en tablas de DWH (`Fact_nsijec_Estudiantes`, `Dim_saipi_Personas`, etc.)
    DWH --&gt;&gt; ETL_Script: Confirmación de carga exitosa
    ETL_Script -&gt;&gt; 👤 Usuario: Finaliza proceso ETL y registra tiempo</code></pre>
<p>Este diagrama muestra cómo el proceso ETL asegura que los datos de los estudiantes y sus parientes estén consolidados en el DWH, permitiendo mantener una base de datos uniforme y de calidad.</p>
<h2 id="etl_4">ETL<a class="headerlink" href="#etl_4" title="Permanent link">&para;</a></h2>
<h3 id="importacion-de-librerias-y-funciones_4">Importación de librerías y funciones<a class="headerlink" href="#importacion-de-librerias-y-funciones_4" title="Permanent link">&para;</a></h3>
<p>Se importan las librerías necesarias (<code>sqlalchemy</code>, <code>pandas</code>, <code>numpy</code>, <code>dateutil</code>, entre otras) y se cargan funciones personalizadas desde el archivo <code>Funciones.py</code>. Además, se ajusta el <code>sys.path</code> para incluir el directorio correspondiente, garantizando la correcta importación del módulo de funciones.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="nn">sa</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">insert</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pymysql</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>
<span class="c1">#---------------------------------------------</span>
<span class="c1">#Import de modulo funciones</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># Agrega el directorio al sys.path</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;../funciones&#39;</span><span class="p">))</span>
<span class="c1"># Importa las funciones desde el archivo Funciones.py</span>
<span class="kn">from</span> <span class="nn">Funciones</span> <span class="kn">import</span> <span class="n">StoreDuplicated</span><span class="p">,</span> <span class="n">guardar_en_dwh</span><span class="p">,</span> <span class="n">cargar_tablas</span><span class="p">,</span> <span class="n">obtener_conexion</span><span class="p">,</span> <span class="n">testfunciones</span><span class="p">,</span> <span class="n">setup_logger</span><span class="p">,</span><span class="n">estandarizar_direccion</span><span class="p">,</span><span class="n">marcar_direcciones_estandarizadas</span>
<span class="nb">print</span><span class="p">(</span><span class="n">testfunciones</span><span class="p">())</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>Importacion de funciones correcta, 30-10-2024 10:45
</code></pre></div>

<h3 id="configuracion-inicial-del-logger_1">Configuración inicial del logger<a class="headerlink" href="#configuracion-inicial-del-logger_1" title="Permanent link">&para;</a></h3>
<p>Se configura el logger para registrar eventos del proceso ETL en el archivo <code>ServicioSocial.log</code>, utilizando el nivel de detalle <code>INFO</code>. También se registra el inicio del proceso, y se almacena la hora de inicio para medir el tiempo total de ejecución.</p>
<div class="highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="n">log_filename</span><span class="o">=</span><span class="s1">&#39;ServicioSocial.log&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;COMIENZO ETL&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 10:45:43,742 - INFO - COMIENZO ETL
</code></pre></div>

<h3 id="consultas-para-extraer-datos-de-estudiantes-y-registros-de-saipi">Consultas para Extraer Datos de Estudiantes y Registros de SAIPI<a class="headerlink" href="#consultas-para-extraer-datos-de-estudiantes-y-registros-de-saipi" title="Permanent link">&para;</a></h3>
<p>Este código configura las consultas SQL para extraer datos de estudiantes y beneficiarios desde las bases de datos <code>nsijec</code> y <code>saipi</code>. El diccionario <code>qr_structure</code> contiene una consulta para la tabla de <code>estudiantes</code> en <code>nsijec</code>, extrayendo detalles personales y de inscripción. <code>qr_structureNeith</code> agrupa consultas para tablas en <code>saipi</code>, incluyendo <code>personas_saipi</code>, <code>acudientes</code>, <code>registros</code>, y <code>valoracion</code>, cada una de las cuales selecciona información detallada sobre identificación, parentesco, registros de vinculación y valoraciones médicas.</p>
<p>El diccionario <code>dim_names</code> define nombres descriptivos para los resultados en <code>df_structure</code>, donde se almacenarán estos datos para análisis y reportes. Esta configuración asegura una carga organizada y estandarizada para un análisis de datos integral sobre los beneficiarios y sus relaciones en ambas bases de datos.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Lista de querys</span>
<span class="n">qr_structure</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;estudiantes&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;select </span>
<span class="s1">                e.id AS ID_REGISTRO,</span>
<span class="s1">                CONCAT(t.tipo,p.identificacion) AS ID_AFILIADO,</span>
<span class="s1">                DATE_FORMAT(fecha_inscripcion, &#39;%Y%m&#39;) AS PERIODO,</span>
<span class="s1">                t.tipo as TIPO_DOCUMENTO,</span>
<span class="s1">                p.identificacion as DOCUMENTO,</span>
<span class="s1">                #e.persona AS ID_PERSONA, </span>
<span class="s1">                #e.convenio AS NUMERO_CONVENIO,</span>
<span class="s1">                con.convenio as NOMBRE_CONVENIO,</span>
<span class="s1">                e.enfermedad_alergia,</span>
<span class="s1">                e.estado,</span>
<span class="s1">                e.fecha_inscripcion,</span>
<span class="s1">                #e.grado,</span>
<span class="s1">                gr.descripcion as GRADO,</span>
<span class="s1">                #e.institucion,</span>
<span class="s1">                ins.institucion,</span>
<span class="s1">                ins.codigo as CODIGO_DANE_INSTITUCION,</span>
<span class="s1">                e.nombre_enfermedad_alergia,</span>
<span class="s1">                e.nombres_medicamentos,</span>
<span class="s1">                e.observacion,</span>
<span class="s1">                e.pob_estudiante,</span>
<span class="s1">                e.toma_medicamentos,</span>
<span class="s1">                e.trabajador_adolecente AS TRABAJADOR_ADOLESCENTE,</span>
<span class="s1">                e.updated_at as FECHA_ACTUALIZACION</span>
<span class="s1">                from nsijec.estudiantes e</span>
<span class="s1">            INNER JOIN nsijec.personas p ON e.persona = p.id</span>
<span class="s1">            INNER JOIN nsijec.tipos_idens t on p.tipo_identificacion = t.id</span>
<span class="s1">            INNER JOIN nsijec.convenios con on e.convenio = con.id</span>
<span class="s1">            INNER JOIN nsijec.grados gr on e.grado = gr.id</span>
<span class="s1">            INNER JOIN nsijec.instituciones_educativas ins on e.institucion = ins.id</span>


<span class="s1">            WHERE fecha_inscripcion &gt;= DATE_SUB(CURDATE(), INTERVAL 18 MONTH) and fecha_inscripcion &lt;= curdate();&#39;&#39;&#39;</span>
    <span class="c1">#,</span>
    <span class="c1">#Tabla parientes vacía</span>
    <span class="c1">#&quot;colegio13&quot;:&#39;&#39;&#39;select </span>
    <span class="c1">#            id AS ID_REGISTRO,</span>
    <span class="c1">#            acudiente AS NOMBRE_ACUDIENTE,</span>
    <span class="c1">#            created_at,</span>
    <span class="c1">#            created_by,</span>
    <span class="c1">#            direccion,</span>
    <span class="c1">#            email,</span>
    <span class="c1">#            estrato,</span>
    <span class="c1">#            estudiante,</span>
    <span class="c1">#            municipio,</span>
    <span class="c1">#            parentesco,</span>
    <span class="c1">#            pariente,</span>
    <span class="c1">#            telefono,</span>
    <span class="c1">#            updated_at,</span>
    <span class="c1">#            updated_by</span>
    <span class="c1">#            from nsijec.parientes&#39;&#39;&#39;                </span>
               <span class="p">}</span>

<span class="c1">#Lista de querys Neith</span>
<span class="n">qr_structureNeith</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;personas_saipi&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;select </span>
<span class="s1">                p.id as ID_PERSONA,</span>
<span class="s1">                CONCAT(t.referencia,p.identificacion) AS ID_AFILIADO,               </span>
<span class="s1">                p.direccion,</span>
<span class="s1">                p.telefono,</span>
<span class="s1">                mun.codigo as CODIGO_CIUDAD,</span>
<span class="s1">                p.estado,</span>
<span class="s1">                p.created_at AS FECHA_CREACION,</span>
<span class="s1">                p.updated_at AS FECHA_ACTUALIZACION</span>
<span class="s1">                from saipi.personas p</span>
<span class="s1">            INNER JOIN saipi.tipos_identificacion t on p.tipiden = t.id</span>
<span class="s1">            INNER JOIN saipi.municipios mun on p.municipio_nacimiento = mun.id&#39;&#39;&#39;</span><span class="p">,</span>

    <span class="s2">&quot;acudientes&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;SELECT </span>
<span class="s1">                a.id as ID_ACUDIENTE,</span>
<span class="s1">                a.registro_id AS ID_REGISTRO,</span>
<span class="s1">                a.persona_id AS ID_PERSONA,</span>
<span class="s1">                pa.detalle as PARENTESCO</span>
<span class="s1">                FROM saipi.acudientes a</span>
<span class="s1">                left join saipi.parentescos pa on a.parentesco_id = pa.id &#39;&#39;&#39;</span><span class="p">,</span>

    <span class="s2">&quot;registros&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;SELECT </span>
<span class="s1">                    r.id AS ID_REGISTRO,</span>
<span class="s1">                    r.persona AS ID_PERSONA,</span>
<span class="s1">                    DATE_FORMAT(r.fecvin, &#39;%Y%m&#39;) AS PERIODO,</span>
<span class="s1">                    #r.convenio,</span>
<span class="s1">                    c.detalle as CONVENIO,</span>
<span class="s1">                    #r.modalidad,</span>
<span class="s1">                    m.detalle as MODALIDAD,</span>
<span class="s1">                    #r.tipben,</span>
<span class="s1">                    b.detalle as TIPO_BENEFICIARIO,</span>
<span class="s1">                    r.fecvin AS FECHA_VINCULACION,</span>
<span class="s1">                    #r.municipio,</span>
<span class="s1">                    mun.codigo as CODIGO_CIUDAD,</span>
<span class="s1">                    #r.caracteristica_poblacion,</span>
<span class="s1">                    cp.detalle as CARACTERISTICA_POBLACION,</span>
<span class="s1">                    #r.poblacion,</span>
<span class="s1">                    pb.detalle as POBLACION,</span>
<span class="s1">                    r.sisben,</span>
<span class="s1">                    r.puntaje AS PUNTAJE_SISBEN,</span>
<span class="s1">                    r.icbf,</span>
<span class="s1">                    r.discapacidad,</span>
<span class="s1">                    r.afiliado,</span>
<span class="s1">                    r.categoria,</span>
<span class="s1">                    r.estafi AS ESTADO_AFILIACION,</span>
<span class="s1">                    #r.pueblo,</span>
<span class="s1">                    r.estado,</span>
<span class="s1">                    r.created_at AS FECHA_CREACION,</span>
<span class="s1">                    r.updated_at AS FECHA_ACTUALIZACION</span>
<span class="s1">                FROM saipi.registros r</span>
<span class="s1">            INNER JOIN saipi.convenios c on r.convenio = c.id</span>
<span class="s1">            INNER JOIN saipi.modalidades m on r.modalidad = m.id</span>
<span class="s1">            INNER JOIN saipi.beneficiarios b on r.tipben = b.id</span>
<span class="s1">            INNER JOIN saipi.municipios mun on r.municipio = mun.id</span>
<span class="s1">            INNER JOIN saipi.caracteristica_poblaciones cp on r.caracteristica_poblacion = cp.id</span>
<span class="s1">            INNER JOIN saipi.poblaciones pb on r.poblacion = pb.id</span>
<span class="s1">            WHERE DATE_FORMAT(r.fecvin, &#39;%Y%m%01&#39;)&gt;= DATE_SUB(CURDATE(), INTERVAL 18 MONTH) and r.fecvin &lt;=CURDATE()&#39;&#39;&#39;</span><span class="p">,</span>

    <span class="s2">&quot;valoracion&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;SELECT </span>
<span class="s1">            v.id AS ID_VALORACION,</span>
<span class="s1">            v.registro_id AS ID_REGISTRO,</span>
<span class="s1">            v.fecval AS FECHA_VALORACION,</span>
<span class="s1">            v.talla,</span>
<span class="s1">            v.peso,</span>
<span class="s1">            v.p_braquial,</span>
<span class="s1">            v.p_cefalico,</span>
<span class="s1">            v.observaciones,</span>
<span class="s1">            v.estado,</span>
<span class="s1">            v.created_at AS FECHA_CREACION,</span>
<span class="s1">            v.updated_at AS FECHA_ACTUALIZACION</span>
<span class="s1">        FROM saipi.valoracion v</span>
<span class="s1">        INNER JOIN (select </span>
<span class="s1">        r.id, r.fecvin </span>
<span class="s1">        FROM saipi.registros r</span>
<span class="s1">        WHERE DATE_FORMAT(r.fecvin, &#39;%Y%m%01&#39;)&gt;= DATE_SUB(CURDATE(), INTERVAL 18 MONTH) and r.fecvin &lt;=CURDATE() ) reg</span>
<span class="s1">        on reg.id = v.registro_id&#39;&#39;&#39;</span>
    <span class="p">}</span>

<span class="n">dim_names</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;estudiantes&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Fact_nsijec_Estudiantes&#39;</span><span class="p">,</span>
    <span class="c1">#&quot;colegio13&quot;:&#39;BD_Fact_nsijec_Parientes&#39;,</span>
    <span class="s2">&quot;personas_saipi&quot;</span> <span class="p">:</span> <span class="s1">&#39;BD_Dim_saipi_Personas&#39;</span><span class="p">,</span>
    <span class="s2">&quot;acudientes&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Fact_saipi_Acudientes&#39;</span><span class="p">,</span>
    <span class="s2">&quot;registros&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Fact_saipi_Registros&#39;</span><span class="p">,</span>
    <span class="s2">&quot;valoracion&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Fact_saipi_Valoraciones&#39;</span>
               <span class="p">}</span>
<span class="n">df_structure</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;LECTURA DE QUERYS&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 10:45:43,759 - INFO - LECTURA DE QUERYS
</code></pre></div>

<h3 id="carga-de-tablas-desde-sql_1">Carga de tablas desde SQL<a class="headerlink" href="#carga-de-tablas-desde-sql_1" title="Permanent link">&para;</a></h3>
<p>Se ejecutan las consultas SQL definidas en <code>qr_structure</code> y los resultados se almacenan en el diccionario <code>df_structure</code>. Para cada consulta, se utiliza un bloque <code>with</code> para manejar la conexión de manera segura. El nombre de cada tabla cargada se registra en el log junto con el tiempo total del proceso de carga desde MySQL.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Cargar tablas desde la base &#39;minerva&#39;</span>
<span class="n">motor</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">obtener_conexion</span><span class="p">(</span><span class="s1">&#39;minerva&#39;</span><span class="p">))</span>
<span class="n">cargar_tablas</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="n">qr_structure</span><span class="p">,</span> <span class="n">df_structure</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 10:45:44,205 - INFO - Cargando estudiantes 
2024-10-30 10:45:45,745 - INFO - Cargada estudiantes, 19,777 registros finales obtenidos. --- 1.54 seconds ---
2024-10-30 10:45:45,813 - INFO - CARGUE TABLAS DESDE MYSQL --- estudiantes --- 2.02 seconds ---
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># Cargar tablas desde la base &#39;neith&#39;</span>
<span class="n">motorNeith</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">obtener_conexion</span><span class="p">(</span><span class="s1">&#39;neith&#39;</span><span class="p">))</span>
<span class="n">cargar_tablas</span><span class="p">(</span><span class="n">motorNeith</span><span class="p">,</span> <span class="n">qr_structureNeith</span><span class="p">,</span> <span class="n">df_structure</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 10:45:46,301 - INFO - Cargando personas_saipi 
2024-10-30 10:45:46,973 - INFO - Cargada personas_saipi, 15,210 registros finales obtenidos. --- 0.67 seconds ---
2024-10-30 10:45:46,975 - INFO - Cargando acudientes 
2024-10-30 10:45:47,122 - INFO - Cargada acudientes, 8,178 registros finales obtenidos. --- 0.15 seconds ---
2024-10-30 10:45:47,123 - INFO - Cargando registros 
2024-10-30 10:45:47,727 - INFO - Cargada registros, 8,182 registros finales obtenidos. --- 0.60 seconds ---
2024-10-30 10:45:47,728 - INFO - Cargando valoracion 
2024-10-30 10:45:48,264 - INFO - Cargada valoracion, 15,211 registros finales obtenidos. --- 0.54 seconds ---
2024-10-30 10:45:48,330 - INFO - CARGUE TABLAS DESDE MYSQL --- valoracion --- 2.50 seconds ---
</code></pre></div>

<h3 id="validador-de-campos-repetidos_1">Validador de campos repetidos<a class="headerlink" href="#validador-de-campos-repetidos_1" title="Permanent link">&para;</a></h3>
<p>Se verifica la existencia de registros duplicados en todas las tablas de <code>df_structure</code>, excluyendo la columna <code>id</code>. Los duplicados se almacenan utilizando la función <code>StoreDuplicated</code>, y luego se eliminan los duplicados de cada tabla con <code>drop_duplicates()</code>. El proceso se registra en el log para cada tabla, junto con el tiempo total del validador de duplicados.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Validador de campos repetidos </span>
<span class="n">validador_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">ky</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_structure</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>   
    <span class="n">ColumnsToCompare</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;id&#39;</span> <span class="p">]</span> <span class="p">]</span>
    <span class="n">StoreDuplicated</span><span class="p">(</span><span class="s1">&#39;N/A&#39;</span> <span class="p">,</span> <span class="n">ColumnsToCompare</span><span class="p">,</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">],</span> <span class="sa">r</span><span class="s1">&#39;\trazaDuplicados_&#39;</span> <span class="o">+</span> <span class="n">ky</span> <span class="p">)</span>
    <span class="c1">#Limpieza inicial quitar duplicados</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;VALIDADOR TABLA: &#39;</span><span class="o">+</span> <span class="n">ky</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;VALIDADOR DUPLICADOS --- </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">validador_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> seconds ---&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 10:45:48,489 - INFO - VALIDADOR TABLA: estudiantes
2024-10-30 10:45:48,530 - INFO - VALIDADOR TABLA: personas_saipi
2024-10-30 10:45:48,547 - INFO - VALIDADOR TABLA: acudientes
2024-10-30 10:45:48,602 - INFO - VALIDADOR TABLA: registros
2024-10-30 10:45:48,629 - INFO - VALIDADOR TABLA: valoracion
2024-10-30 10:45:48,631 - INFO - VALIDADOR DUPLICADOS --- 0.29 seconds ---
</code></pre></div>

<h3 id="transformacion-y-limpieza-de-texto">Transformación y limpieza de texto<a class="headerlink" href="#transformacion-y-limpieza-de-texto" title="Permanent link">&para;</a></h3>
<p>Se realiza una limpieza de las columnas de texto en cada tabla de <code>df_structure</code>. Las columnas de texto se convierten a mayúsculas (<code>UPPER</code>), se eliminan los espacios en blanco al inicio y al final, y se reemplazan los valores <code>"NAN"</code> y <code>"NONE"</code> por valores nulos (<code>NaN</code>). El tiempo total del proceso de limpieza se registra en el log.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Transformación 2</span>
<span class="n">limpieza_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">ky</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_structure</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="c1">#print(ky)</span>
    <span class="c1"># Convertir todos los nombres de las columnas a mayúsculas</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="c1">#Pasar las columnas tipo texto a UPPER</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="c1">#En las columnas tipo texto, eliminar espacios al comienzo y al final</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="c1">#Reemplazar los &quot;NAN&quot; o &quot;NONE&quot; por NaN</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;NAN&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;NONE&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;LIMPIEZA --- </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">limpieza_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> seconds ---&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 10:45:49,671 - INFO - LIMPIEZA --- 1.03 seconds ---
</code></pre></div>

<h3 id="estandarizar-direcciones">Estandarizar direcciones<a class="headerlink" href="#estandarizar-direcciones" title="Permanent link">&para;</a></h3>
<p>Este bloque de código llama la función estandarización de direcciones, lo cual permite limpiar las direcciones y marcar aquellas que empiezan con las siglas de carrera, calle, diagonal, transversal, kilometro, manzana, lote, carretera, finca o las que no registran como estandarizadas.</p>
<div class="highlight"><pre><span></span><code><span class="n">df_personas</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="s1">&#39;personas_saipi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Asegurarse de que la columna DIRECCION_ORIGINAL es de tipo texto</span>
<span class="n">df_personas</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;DIRECCION&#39;</span><span class="p">:</span><span class="s1">&#39;DIRECCION_ORIGINAL&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_personas</span><span class="p">[</span><span class="s1">&#39;DIRECCION_ORIGINAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_personas</span><span class="p">[</span><span class="s1">&#39;DIRECCION_ORIGINAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="c1"># Aplicamos la estandarización a todas las direcciones y creamos una nueva columna con las direcciones estandarizadas</span>

<span class="n">df_personas</span><span class="p">[</span><span class="s1">&#39;DIRECCION_LIMPIA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_personas</span><span class="p">[</span><span class="s1">&#39;DIRECCION_ORIGINAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">estandarizar_direccion</span><span class="p">)</span>

<span class="c1"># Agregar columna &#39;DIRECCION_ESTANDARIZADA&#39; si la direccion empieza con algunas de las abreviaturas estandarizadas</span>
<span class="n">marcar_direcciones_estandarizadas</span><span class="p">(</span><span class="n">df_personas</span><span class="p">,</span> <span class="s1">&#39;DIRECCION_LIMPIA&#39;</span><span class="p">)</span>

<span class="n">df_structure</span><span class="p">[</span><span class="s1">&#39;personas_saipi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_personas</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1">#df_structure[&#39;personas_saipi&#39;]</span>
</code></pre></div>
<h3 id="guardar-en-base-de-datos-dwh_3">Guardar en base de datos DWH<a class="headerlink" href="#guardar-en-base-de-datos-dwh_3" title="Permanent link">&para;</a></h3>
<p>Se guarda cada tabla de <code>df_structure</code> en la base de datos DWH utilizando los nombres definidos en <code>dim_names</code>. Si la clave de la tabla no está presente en <code>dim_names</code>, se genera una advertencia en el log. El tiempo total del proceso de almacenamiento se registra, junto con los nombres de las tablas que se almacenaron correctamente.</p>
<div class="highlight"><pre><span></span><code><span class="n">guardar_en_dwh</span><span class="p">(</span><span class="n">df_structure</span><span class="p">,</span> <span class="n">dim_names</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 10:45:50,048 - INFO - Intentando conexión a la base DWH...
2024-10-30 10:45:50,051 - INFO - Conexión a la base DWH establecida con éxito.
2024-10-30 10:45:50,462 - INFO - Almacenando tabla estudiantes en DWH como BD_Fact_nsijec_Estudiantes
2024-10-30 10:45:55,969 - INFO - Tabla estudiantes almacenada correctamente como BD_Fact_nsijec_Estudiantes.
2024-10-30 10:45:55,971 - INFO - Almacenando tabla personas_saipi en DWH como BD_Dim_saipi_Personas
2024-10-30 10:45:59,065 - INFO - Tabla personas_saipi almacenada correctamente como BD_Dim_saipi_Personas.
2024-10-30 10:45:59,066 - INFO - Almacenando tabla acudientes en DWH como BD_Fact_saipi_Acudientes
2024-10-30 10:46:00,581 - INFO - Tabla acudientes almacenada correctamente como BD_Fact_saipi_Acudientes.
2024-10-30 10:46:00,582 - INFO - Almacenando tabla registros en DWH como BD_Fact_saipi_Registros
2024-10-30 10:46:03,558 - INFO - Tabla registros almacenada correctamente como BD_Fact_saipi_Registros.
2024-10-30 10:46:03,559 - INFO - Almacenando tabla valoracion en DWH como BD_Fact_saipi_Valoraciones
2024-10-30 10:46:07,558 - INFO - Tabla valoracion almacenada correctamente como BD_Fact_saipi_Valoraciones.
2024-10-30 10:46:07,655 - INFO - ALMACENAMIENTO ---  --- 17.61 seconds ---
2024-10-30 10:46:07,656 - INFO - Finalizando proceso de almacenamiento en DWH.
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;FINAL ETL --- </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> seconds ---&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 10:46:07,668 - INFO - FINAL ETL --- 23.94 seconds ---
</code></pre></div>

<h1 id="61-factencuestas">6.1-FactEncuestas<a class="headerlink" href="#61-factencuestas" title="Permanent link">&para;</a></h1>
<h1 id="61-factencuestas_1">6.1-FactEncuestas<a class="headerlink" href="#61-factencuestas_1" title="Permanent link">&para;</a></h1>
<h1 id="61-fact-encuestas">6.1 Fact Encuestas<a class="headerlink" href="#61-fact-encuestas" title="Permanent link">&para;</a></h1>
<h2 id="introduccion_4">Introducción<a class="headerlink" href="#introduccion_4" title="Permanent link">&para;</a></h2>
<p>El proceso ETL se enfoca en la obtención, transformación y almacenamiento de datos de encuestas en el Data Warehouse (DWH). Para ello, se realiza la extracción de datos desde diferentes tablas relacionadas con encuestas (<code>lime_questions</code>, <code>lime_answers</code>, entre otras) de bases de datos de encuestas y Neith, se transforman mediante limpieza y normalización, y finalmente, se cargan en la tabla <code>BD_Fact_Encuestas</code>. </p>
<p>Se establecen conexiones a diferentes bases de datos para el acceso a tablas de encuestas y metadatos de usuarios, permitiendo crear relaciones entre identificadores, códigos y respuestas de encuestas. El flujo del proceso de datos asegura que los datos se integren correctamente, permitiendo un análisis posterior en el DWH.</p>
<h4 id="diagrama-de-secuencia-del-proceso-etl_5">Diagrama de Secuencia del Proceso ETL<a class="headerlink" href="#diagrama-de-secuencia-del-proceso-etl_5" title="Permanent link">&para;</a></h4>
<pre class="mermaid"><code>sequenceDiagram
  title Diagrama de Secuencia del Proceso ETL para la Tabla FactEncuestas
  autonumber
  participant 👤 Usuario
  participant ETL
  participant BD_DWH as Base de Datos DWH
  participant BD_Neith as Base de Datos Neith
  👤 Usuario-&gt;&gt;ETL: Solicitar procesamiento de datos
  ETL-&gt;&gt;BD_Neith: Extraer encuestas y preguntas
  BD_Neith--&gt;&gt;ETL: Datos de encuestas y preguntas
  ETL-&gt;&gt;BD_DWH: Extraer inventario de tablas y diccionario de campos
  BD_DWH--&gt;&gt;ETL: Inventario y diccionario
  ETL-&gt;&gt;ETL: Transformar datos (limpieza, estandarización)
  ETL-&gt;&gt;BD_DWH: Cargar datos transformados en `BD_Fact_Encuestas`
  BD_DWH--&gt;&gt;ETL: Confirmación de carga exitosa
  ETL--&gt;&gt;👤 Usuario: Proceso ETL completado con éxito</code></pre>
<h2 id="etl_5">ETL<a class="headerlink" href="#etl_5" title="Permanent link">&para;</a></h2>
<h3 id="importacion-de-librerias-y-funciones_5">Importación de librerías y funciones<a class="headerlink" href="#importacion-de-librerias-y-funciones_5" title="Permanent link">&para;</a></h3>
<p>Este código configura el entorno necesario para la manipulación y carga de datos en un Data Warehouse, importando librerías esenciales (<code>pandas</code>, <code>sqlalchemy</code>, <code>BeautifulSoup</code> para procesamiento de HTML, y <code>logging</code>). También incluye funciones personalizadas del archivo <code>Funciones.py</code>, como <code>guardar_en_dwh</code> para almacenar datos en el DWH, <code>Conexion_dwh</code> y <code>Conexion_neith</code> para la conexión a diferentes bases de datos, y <code>setup_logger</code> para el registro de eventos. La prueba <code>testfunciones()</code> verifica que las funciones se hayan importado correctamente y están listas para su uso.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="nn">sa</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">insert</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">time</span> 
<span class="kn">import</span> <span class="nn">os</span> 
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># Agrega el directorio al sys.path</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;../funciones&#39;</span><span class="p">))</span>
<span class="c1"># Importa las funciones desde el archivo Funciones.py</span>
<span class="kn">from</span> <span class="nn">Funciones</span> <span class="kn">import</span> <span class="n">guardar_en_dwh</span><span class="p">,</span> <span class="n">testfunciones</span><span class="p">,</span> <span class="n">setup_logger</span><span class="p">,</span> <span class="n">Conexion_dwh</span><span class="p">,</span> <span class="n">Conexion_neith</span>

<span class="nb">print</span><span class="p">(</span><span class="n">testfunciones</span><span class="p">())</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>Importacion de funciones correcta, 30-10-2024 10:26
</code></pre></div>

<h3 id="configuracion-inicial-del-logger_2">Configuración inicial del logger<a class="headerlink" href="#configuracion-inicial-del-logger_2" title="Permanent link">&para;</a></h3>
<p>Se configura el logger para registrar eventos del proceso ETL en el archivo <code>Encuestas.log</code>, utilizando el nivel de detalle <code>INFO</code>. También se registra el inicio del proceso, y se almacena la hora de inicio para medir el tiempo total de ejecución.</p>
<div class="highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="n">log_filename</span><span class="o">=</span><span class="s1">&#39;Encuestas.log&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;COMIENZO ETL&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 10:26:52,904 - INFO - COMIENZO ETL
</code></pre></div>

<h3 id="funciones-para-limpieza-de-html-y-carga-de-consultas-en-paralelo">Funciones para Limpieza de HTML y Carga de Consultas en Paralelo<a class="headerlink" href="#funciones-para-limpieza-de-html-y-carga-de-consultas-en-paralelo" title="Permanent link">&para;</a></h3>
<p>Este código define dos funciones para manejar datos: <code>limpiar_html</code> usa <code>BeautifulSoup</code> para extraer el contenido de texto de un HTML, eliminando etiquetas para dejar solo texto limpio. La función <code>load_query</code> ejecuta una consulta SQL y carga los resultados en un DataFrame (<code>df_query</code>). Diseñada para uso con <code>ThreadPoolExecutor</code>, permite cargar varias consultas en paralelo y devuelve <code>None</code> en caso de error, sin interrumpir el flujo principal.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">limpiar_html</span><span class="p">(</span><span class="n">texto_html</span><span class="p">):</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">texto_html</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">soup</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span>
<span class="c1">###Librerias para paralelizar</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>

<span class="k">def</span> <span class="nf">load_query</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span> 
        <span class="n">df_query</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">motor_consulta</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_query</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">#Medir tiempos</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</code></pre></div>
<h3 id="conexion-a-la-base-de-datos-dwh_1">Conexión a la base de datos DWH<a class="headerlink" href="#conexion-a-la-base-de-datos-dwh_1" title="Permanent link">&para;</a></h3>
<p>Se establece la conexión con la base de datos DWH utilizando la función <code>Conexion_dwh()</code> y se crea el motor de conexión con <code>create_engine()</code>. El evento de conexión exitosa se registra en el log.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#---------------------------------------------</span>
<span class="c1">#Conexion a base dwh</span>
<span class="n">cadena_conexion_pruebas</span> <span class="o">=</span> <span class="n">Conexion_dwh</span><span class="p">()</span>
<span class="n">motor_pruebas</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">cadena_conexion_pruebas</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CONEXION A BASE DWH&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 10:26:53,000 - INFO - CONEXION A BASE DWH
</code></pre></div>

<h3 id="consulta-de-inventario-de-tablas-en-base-de-datos-de-encuestas">Consulta de Inventario de Tablas en Base de Datos de Encuestas<a class="headerlink" href="#consulta-de-inventario-de-tablas-en-base-de-datos-de-encuestas" title="Permanent link">&para;</a></h3>
<p>Este bloque de código consulta el inventario de tablas en la base de datos <code>encuestas</code> para identificar aquellas incluidas en la bodega de datos (<code>SeIncluyeEnBodega = "Si"</code>). La consulta se ejecuta en la tabla de inventario <code>gb_Dim_Bodega_Inventario de Tablas</code> en el Data Warehouse (<code>dwh</code>), filtrando las tablas del servidor con <code>IdServidor = 3</code>. El resultado se almacena en <code>df_tablas</code>, que contendrá los nombres de las bases de datos y tablas relevantes para su posterior uso en análisis o cargas de datos en el entorno de encuestas.</p>
<div class="highlight"><pre><span></span><code><span class="c1">##1. Consultar el diccionario con las tablas de la base de encuestas</span>
<span class="k">with</span> <span class="n">motor_pruebas</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">qr_structure</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT NombreBaseDeDatos,NombreTabla FROM dwh.`gb_Dim_Bodega_Inventario de Tablas`  </span>
<span class="s2">    where IdServidor = 3 and SeIncluyeEnBodega = &quot;Si&quot; and NombreBaseDeDatos = &quot;encuestas&quot; &quot;&quot;&quot;</span>
    <span class="n">df_tablas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">qr_structure</span><span class="p">),</span> <span class="n">conn</span><span class="p">)</span>
<span class="c1">#df_tablas</span>
</code></pre></div>
<h3 id="extraccion-de-codigos-de-encuestas-desde-nombres-de-tablas">Extracción de Códigos de Encuestas desde Nombres de Tablas<a class="headerlink" href="#extraccion-de-codigos-de-encuestas-desde-nombres-de-tablas" title="Permanent link">&para;</a></h3>
<p>Este código extrae los códigos de encuestas (<code>sid</code>) a partir de la columna <code>NombreTabla</code> en <code>df_tablas</code>. Utiliza el método <code>str.split</code> con <code>"_"</code> como delimitador y expande el resultado en varias columnas, seleccionando el tercer elemento (<code>[2]</code>) como el código de encuesta. Luego, convierte <code>sid</code> a tipo <code>str</code> para asegurar la consistencia de formato, facilitando su uso en análisis o filtrado posterior.</p>
<div class="highlight"><pre><span></span><code><span class="c1">## Lista de codigos de encuestas</span>
<span class="c1">#df_tablas[&#39;sid&#39;] = df_tablas[&#39;NombreTabla&#39;].str.split(&quot;_&quot;)</span>
<span class="n">df_tablas</span><span class="p">[</span><span class="s1">&#39;sid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_tablas</span><span class="p">[</span><span class="s1">&#39;NombreTabla&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="n">expand</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">df_tablas</span><span class="p">[</span><span class="s2">&quot;sid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_tablas</span><span class="p">[</span><span class="s2">&quot;sid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</code></pre></div>
<h3 id="conexion-a-la-base-de-datos-neith">Conexión a la base de datos Neith<a class="headerlink" href="#conexion-a-la-base-de-datos-neith" title="Permanent link">&para;</a></h3>
<p>Se establece la conexión con la base de datos Neith utilizando la función <code>Conexion_neith()</code> para generar la cadena de conexión y <code>create_engine()</code> para crear el motor de conexión. El evento de conexión exitosa se registra en el log.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#---------------------------------------------</span>
<span class="c1">#Conexion a base Neith</span>
<span class="n">cadena_conexion_neith</span> <span class="o">=</span> <span class="n">Conexion_neith</span><span class="p">()</span>
<span class="n">motor_neith</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">cadena_conexion_neith</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CONEXION A BASE Neith&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 10:26:53,541 - INFO - CONEXION A BASE Neith
</code></pre></div>

<h3 id="consulta-de-nombres-de-encuestas-en-la-base-de-datos-de-limesurvey">Consulta de Nombres de Encuestas en la Base de Datos de LimeSurvey<a class="headerlink" href="#consulta-de-nombres-de-encuestas-en-la-base-de-datos-de-limesurvey" title="Permanent link">&para;</a></h3>
<p>Este código extrae los nombres de las encuestas desde la tabla <code>lime_surveys_languagesettings</code> en la base de datos <code>encuestas</code>. La consulta selecciona el ID de la encuesta (<code>surveyls_survey_id</code> como <code>sid</code>) y el título (<code>surveyls_title</code> como <code>NombreEncuesta</code>). El resultado se almacena en el DataFrame <code>df_nombre_encuestas</code>, con la columna <code>sid</code> convertida a tipo <code>str</code> para facilitar su uso en futuras uniones o consultas. </p>
<p>Este DataFrame proporciona una referencia de los nombres y IDs de las encuestas, útil para análisis de respuestas o estructuras en encuestas de LimeSurvey.</p>
<div class="highlight"><pre><span></span><code><span class="c1">##2. Consultar nombres de las encuestas</span>
<span class="k">with</span> <span class="n">motor_neith</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">qr_structure</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT surveyls_survey_id as sid, surveyls_title as NombreEncuesta </span>
<span class="s2">    FROM encuestas.lime_surveys_languagesettings &quot;&quot;&quot;</span>
    <span class="n">df_nombre_encuestas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">qr_structure</span><span class="p">),</span> <span class="n">conn</span><span class="p">)</span>
<span class="n">df_nombre_encuestas</span><span class="p">[</span><span class="s2">&quot;sid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_nombre_encuestas</span><span class="p">[</span><span class="s2">&quot;sid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</code></pre></div>
<h3 id="fusion-de-codigos-y-nombres-de-encuestas-y-exportacion-a-excel">Fusión de Códigos y Nombres de Encuestas y Exportación a Excel<a class="headerlink" href="#fusion-de-codigos-y-nombres-de-encuestas-y-exportacion-a-excel" title="Permanent link">&para;</a></h3>
<p>Este código combina los DataFrames <code>df_tablas</code> y <code>df_nombre_encuestas</code> mediante una unión izquierda (<code>merge</code>) en la columna <code>sid</code>, agregando los nombres de las encuestas (<code>NombreEncuesta</code>) a sus respectivos códigos en <code>df_tablas</code>. Las filas con valores nulos resultantes de la combinación se eliminan, y el índice se reinicia para un formato uniforme. </p>
<p>El DataFrame resultante <code>df_tablas_nombres</code> se exporta a un archivo Excel (<code>df_tablas.xlsx</code>) para facilitar su visualización y análisis externo, mientras que <code>df_tablas_codigos</code> se define como una vista simplificada con solo las columnas <code>NombreBaseDeDatos</code>, <code>NombreTabla</code> y <code>sid</code>.</p>
<div class="highlight"><pre><span></span><code><span class="c1">## Nombres de las tablas de encuestas</span>
<span class="n">df_tablas_nombres</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_tablas</span><span class="p">,</span><span class="n">df_nombre_encuestas</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;sid&#39;</span><span class="p">)</span>
<span class="n">df_tablas_nombres</span> <span class="o">=</span> <span class="n">df_tablas_nombres</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">df_tablas_nombres</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s1">&#39;df_tablas.xlsx&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">df_tablas_codigos</span> <span class="o">=</span> <span class="n">df_tablas_nombres</span><span class="p">[[</span><span class="s1">&#39;NombreBaseDeDatos&#39;</span><span class="p">,</span> <span class="s1">&#39;NombreTabla&#39;</span><span class="p">,</span> <span class="s1">&#39;sid&#39;</span><span class="p">]]</span>
</code></pre></div>
<h3 id="consulta-del-diccionario-de-campos-de-la-base-de-encuestas">Consulta del diccionario de campos de la base de encuestas<a class="headerlink" href="#consulta-del-diccionario-de-campos-de-la-base-de-encuestas" title="Permanent link">&para;</a></h3>
<p>Se ejecuta una consulta SQL para obtener los campos de las tablas de la base de datos <code>encuestas</code>, que están incluidas en la bodega de datos. La consulta selecciona los campos <code>NombreBaseDeDatos</code>, <code>NombreTabla</code>, y <code>NombreCampo</code> desde la tabla <code>gb_Dim_Bodega_Diccionario de Campos</code> en el DWH, filtrando por el servidor con <code>IdServidor = 3</code> y asegurando que los campos estén marcados como incluidos en la bodega (<code>SeIncluyeEnBodega = "Si"</code>).</p>
<p>El resultado de la consulta se carga en el dataframe <code>df_campos</code>.</p>
<div class="highlight"><pre><span></span><code><span class="c1">##3. Consultar el diccionario con las tablas de la base de encuestas</span>
<span class="k">with</span> <span class="n">motor_pruebas</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">qr_structure</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT NombreBaseDeDatos,NombreTabla, NombreCampo FROM dwh.`gb_Dim_Bodega_Diccionario de Campos`</span>
<span class="s2">    where IdServidor = 3 and SeIncluyeEnBodega = &quot;Si&quot; and NombreBaseDeDatos = &quot;encuestas&quot; &quot;&quot;&quot;</span>
    <span class="n">df_campos</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">qr_structure</span><span class="p">),</span> <span class="n">conn</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">df_campos_codigo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_campos</span><span class="p">,</span><span class="n">df_tablas_codigos</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NombreBaseDeDatos&#39;</span><span class="p">,</span> <span class="s1">&#39;NombreTabla&#39;</span><span class="p">])</span>
</code></pre></div>
<h3 id="extraccion-y-transformacion-de-codigos-qid-y-parent_qid">Extracción y transformación de códigos <code>qid</code> y <code>parent_qid</code><a class="headerlink" href="#extraccion-y-transformacion-de-codigos-qid-y-parent_qid" title="Permanent link">&para;</a></h3>
<p>Se crea la columna <code>qid</code> en el dataframe <code>df_campos_codigo</code>, extrayendo parte del nombre de campo dividiendo el texto por "X". Luego, se limpian los datos y se convierten los valores a formato <code>str</code>. Además, se genera la columna <code>parent_qid</code> tomando los primeros dígitos del código <code>qid</code>, mientras que <code>qid</code> contiene los últimos cinco caracteres.</p>
<div class="highlight"><pre><span></span><code><span class="n">df_campos_codigo</span><span class="p">[</span><span class="s1">&#39;qid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_campos_codigo</span><span class="p">[</span><span class="s1">&#39;NombreCampo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span><span class="n">expand</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">df_campos_codigo_qid</span> <span class="o">=</span> <span class="n">df_campos_codigo</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_campos_codigo_qid</span><span class="p">[</span><span class="s2">&quot;qid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_campos_codigo_qid</span><span class="p">[</span><span class="s2">&quot;qid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">df_campos_codigo_qid</span><span class="p">[</span><span class="s2">&quot;parent_qid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_campos_codigo_qid</span><span class="p">[</span><span class="s1">&#39;qid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
<span class="n">df_campos_codigo_qid</span><span class="p">[</span><span class="s2">&quot;qid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_campos_codigo_qid</span><span class="p">[</span><span class="s1">&#39;qid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">#df_campos_codigo_qid.to_excel(&#39;t1.xlsx&#39;,index=False)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">#df_campos_codigo_qid[&#39;qid&#39;].str[-5:]</span>
</code></pre></div>
<h3 id="consulta-de-la-tabla-lime_questions">Consulta de la tabla <code>lime_questions</code><a class="headerlink" href="#consulta-de-la-tabla-lime_questions" title="Permanent link">&para;</a></h3>
<p>Se ejecuta una consulta SQL para obtener los datos de la tabla <code>lime_questions</code> en la base de datos <code>encuestas</code>. La consulta selecciona las columnas <code>qid</code>, <code>parent_qid</code>, <code>sid</code>, y <code>title</code>. Posteriormente, las columnas <code>qid</code>, <code>parent_qid</code>, y <code>sid</code> se convierten al tipo <code>str</code> para asegurar una correcta manipulación de datos. El resultado de la consulta se almacena en el dataframe <code>df_lime_questions</code>.</p>
<div class="highlight"><pre><span></span><code><span class="c1">##4. Consultar la tabla lime_questions</span>
<span class="k">with</span> <span class="n">motor_neith</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">qr_structure</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT qid, parent_qid, sid,title FROM encuestas.lime_questions &quot;&quot;&quot;</span>
    <span class="n">df_lime_questions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">qr_structure</span><span class="p">),</span> <span class="n">conn</span><span class="p">)</span>
<span class="n">df_lime_questions</span><span class="p">[</span><span class="s2">&quot;qid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lime_questions</span><span class="p">[</span><span class="s2">&quot;qid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">df_lime_questions</span><span class="p">[</span><span class="s2">&quot;parent_qid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lime_questions</span><span class="p">[</span><span class="s2">&quot;parent_qid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">df_lime_questions</span><span class="p">[</span><span class="s2">&quot;sid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lime_questions</span><span class="p">[</span><span class="s2">&quot;sid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">df_lime_questions</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>qid</th>
      <th>parent_qid</th>
      <th>sid</th>
      <th>title</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>216</td>
      <td>186</td>
      <td>832591</td>
      <td>SQ004</td>
    </tr>
    <tr>
      <th>1</th>
      <td>217</td>
      <td>186</td>
      <td>832591</td>
      <td>SQ005</td>
    </tr>
    <tr>
      <th>2</th>
      <td>218</td>
      <td>186</td>
      <td>832591</td>
      <td>SQ006</td>
    </tr>
    <tr>
      <th>3</th>
      <td>219</td>
      <td>186</td>
      <td>832591</td>
      <td>SQ007</td>
    </tr>
    <tr>
      <th>4</th>
      <td>220</td>
      <td>186</td>
      <td>832591</td>
      <td>SQ008</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1526</th>
      <td>2753</td>
      <td>0</td>
      <td>354133</td>
      <td>Q22</td>
    </tr>
    <tr>
      <th>1527</th>
      <td>2754</td>
      <td>0</td>
      <td>354133</td>
      <td>Q23</td>
    </tr>
    <tr>
      <th>1528</th>
      <td>2755</td>
      <td>0</td>
      <td>354133</td>
      <td>SUMRALO</td>
    </tr>
    <tr>
      <th>1529</th>
      <td>2756</td>
      <td>0</td>
      <td>354133</td>
      <td>SUMTOTAL</td>
    </tr>
    <tr>
      <th>1530</th>
      <td>2757</td>
      <td>0</td>
      <td>354133</td>
      <td>RESULTADO</td>
    </tr>
  </tbody>
</table>
<p>1531 rows × 4 columns</p>
</div>

<h3 id="ajuste-de-qid-para-las-tablas">Ajuste de <code>qid</code> para las tablas<a class="headerlink" href="#ajuste-de-qid-para-las-tablas" title="Permanent link">&para;</a></h3>
<p>Se realiza un proceso de combinación entre los dataframes <code>df_campos_codigo_qid</code> y <code>df_lime_questions</code> para arreglar los campos <code>qid</code>. Se ajustan los nombres de columnas y se completan los valores faltantes de <code>qid</code> utilizando los valores de respaldo. El dataframe resultante, <code>df_campos_2</code>, contiene las columnas clave como <code>NombreBaseDeDatos</code>, <code>NombreTabla</code>, <code>NombreCampo</code>, <code>sid</code>, y el <code>qid</code> corregido.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Arreglar qid para las tablas</span>
<span class="n">df_campos_1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">df_campos_codigo_qid</span> <span class="p">,</span> <span class="n">df_lime_questions</span> <span class="p">,</span> <span class="n">how</span> <span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sid&#39;</span><span class="p">,</span> <span class="s1">&#39;qid&#39;</span><span class="p">])</span>
<span class="n">df_campos_1</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;title_1&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_qid_x&#39;</span><span class="p">:</span><span class="s1">&#39;parent_qid&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_campos_1</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_campos_1</span><span class="p">[</span><span class="s1">&#39;qid&#39;</span><span class="p">]</span>
<span class="n">df_campos_2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_campos_1</span><span class="p">,</span><span class="n">df_lime_questions</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sid&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_qid&#39;</span><span class="p">])</span>
<span class="n">df_campos_2</span><span class="p">[</span><span class="s1">&#39;qid_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df_campos_2</span><span class="p">[</span><span class="s1">&#39;qid_x&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_campos_2</span> <span class="o">=</span> <span class="n">df_campos_2</span><span class="p">[[</span><span class="s1">&#39;NombreBaseDeDatos&#39;</span><span class="p">,</span> <span class="s1">&#39;NombreTabla&#39;</span><span class="p">,</span> <span class="s1">&#39;NombreCampo&#39;</span><span class="p">,</span> <span class="s1">&#39;sid&#39;</span><span class="p">,</span> <span class="s1">&#39;qid_y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_campos_2</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;qid_y&#39;</span><span class="p">:</span><span class="s1">&#39;qid&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<h3 id="consulta-y-limpieza-de-preguntas-de-encuestas-lime_questions_l10ns">Consulta y limpieza de preguntas de encuestas (<code>lime_questions_l10ns</code>)<a class="headerlink" href="#consulta-y-limpieza-de-preguntas-de-encuestas-lime_questions_l10ns" title="Permanent link">&para;</a></h3>
<p>Se consulta la tabla <code>lime_question_l10ns</code> de la base de datos <code>encuestas</code> para obtener información detallada sobre las preguntas de encuestas. Se combina este resultado con el dataframe <code>df_campos_2</code>, eliminando columnas irrelevantes como <code>help</code>, <code>script</code>, y <code>language</code>. Luego, se limpian las preguntas usando la función <code>limpiar_html</code> para eliminar etiquetas HTML, y se eliminan los caracteres especiales, como corchetes. Finalmente, se filtran las filas para excluir registros con <code>qid</code> no válidos como <code>'count'</code> y <code>'other'</code>, y el dataframe se reorganiza con los datos limpios.</p>
<div class="highlight"><pre><span></span><code><span class="c1">##4. Consultar la tabla lime_questions q10</span>
<span class="k">with</span> <span class="n">motor_neith</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">qr_structure</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM encuestas.lime_question_l10ns &quot;&quot;&quot;</span>
    <span class="n">df_lime_questions_names</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">qr_structure</span><span class="p">),</span> <span class="n">conn</span><span class="p">)</span>
<span class="n">df_lime_questions_names</span><span class="p">[</span><span class="s2">&quot;qid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lime_questions_names</span><span class="p">[</span><span class="s2">&quot;qid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">df_sol</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_campos_2</span><span class="p">,</span><span class="n">df_lime_questions_names</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;qid&#39;</span><span class="p">)</span>
<span class="n">df_sol</span> <span class="o">=</span> <span class="n">df_sol</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;help&#39;</span><span class="p">,</span> <span class="s1">&#39;script&#39;</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_sol</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_sol</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">df_sol</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_sol</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">df_sol</span><span class="p">[</span><span class="s1">&#39;question_clean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_sol</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">limpiar_html</span><span class="p">)</span>
<span class="n">df_sol</span><span class="p">[</span><span class="s1">&#39;question_clean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_sol</span><span class="p">[</span><span class="s1">&#39;question_clean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\[\]]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_clean</span> <span class="o">=</span> <span class="n">df_sol</span><span class="p">[</span><span class="o">~</span><span class="n">df_sol</span><span class="p">[</span><span class="s1">&#39;qid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>C:\Users\Consultor_QCS\AppData\Local\Temp\ipykernel_8392\1878959599.py:2: MarkupResemblesLocatorWarning: The input looks more like a filename than markup. You may want to open this file and pass the filehandle into Beautiful Soup.
  soup = BeautifulSoup(texto_html, &#39;html.parser&#39;)
</code></pre></div>

<h3 id="consulta-de-grupos-de-encuestas-lime_groups">Consulta de grupos de encuestas (<code>lime_groups</code>)<a class="headerlink" href="#consulta-de-grupos-de-encuestas-lime_groups" title="Permanent link">&para;</a></h3>
<p>Se ejecuta una consulta SQL para obtener los grupos de encuestas desde la tabla <code>lime_groups</code> y su descripción desde la tabla <code>lime_group_l10ns</code>. La consulta selecciona el <code>gid</code>, <code>sid</code>, y el nombre del grupo (<code>group_name</code>) como <code>DetalleTabla</code>. El resultado se almacena en el dataframe <code>df_lime_groups</code>, asegurando que la columna <code>sid</code> esté en formato <code>str</code>.</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">motor_neith</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">qr_structure</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT e1.gid, e1.sid, e2.group_name as DetalleTabla FROM encuestas.lime_groups as e1</span>
<span class="s2">                    LEFT JOIN encuestas.lime_group_l10ns as e2</span>
<span class="s2">                    ON e1.gid= e2.gid&quot;&quot;&quot;</span>
    <span class="n">df_lime_groups</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">qr_structure</span><span class="p">),</span> <span class="n">conn</span><span class="p">)</span>
<span class="n">df_lime_groups</span><span class="p">[</span><span class="s1">&#39;sid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lime_groups</span><span class="p">[</span><span class="s1">&#39;sid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">df_clean</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">df_clean</span> <span class="p">,</span> <span class="n">df_lime_groups</span> <span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;sid&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">df_clean</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NombreBaseDeDatos</th>
      <th>NombreTabla</th>
      <th>NombreCampo</th>
      <th>sid</th>
      <th>qid</th>
      <th>id</th>
      <th>question</th>
      <th>question_clean</th>
      <th>gid</th>
      <th>DetalleTabla</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>encuestas</td>
      <td>lime_survey_124282</td>
      <td>124282X29X488</td>
      <td>124282</td>
      <td>488</td>
      <td>488.0</td>
      <td>&lt;p style="text-align: center;"&gt;&lt;span style="fo...</td>
      <td>PLANCHA N°1 \n\n\n\nPRINCIPALES\n\n\n\n\n\n\n\...</td>
      <td>29</td>
      <td>REPRESENTANTES</td>
    </tr>
    <tr>
      <th>1</th>
      <td>encuestas</td>
      <td>lime_survey_161825</td>
      <td>161825X51X1103</td>
      <td>161825</td>
      <td>1103</td>
      <td>1103.0</td>
      <td>¿CÓMO CALIFICA EN GENERAL LA CALIDAD DEL SERVI...</td>
      <td>¿CÓMO CALIFICA EN GENERAL LA CALIDAD DEL SERVI...</td>
      <td>51</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO DE ALOJAMIENTO</td>
    </tr>
    <tr>
      <th>2</th>
      <td>encuestas</td>
      <td>lime_survey_161825</td>
      <td>161825X51X1104</td>
      <td>161825</td>
      <td>1104</td>
      <td>1104.0</td>
      <td>¡SU OPINION NOS INTERESA! Si desea registrar u...</td>
      <td>¡SU OPINION NOS INTERESA! Si desea registrar u...</td>
      <td>51</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO DE ALOJAMIENTO</td>
    </tr>
    <tr>
      <th>3</th>
      <td>encuestas</td>
      <td>lime_survey_161825</td>
      <td>161825X51X1105SQ001</td>
      <td>161825</td>
      <td>1113</td>
      <td>1113.0</td>
      <td>LA ATENCION DURANTE EL CHECK IN Y EL CHECK OUT</td>
      <td>LA ATENCION DURANTE EL CHECK IN Y EL CHECK OUT</td>
      <td>51</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO DE ALOJAMIENTO</td>
    </tr>
    <tr>
      <th>4</th>
      <td>encuestas</td>
      <td>lime_survey_161825</td>
      <td>161825X51X1105SQ002</td>
      <td>161825</td>
      <td>1114</td>
      <td>1114.0</td>
      <td>LA ENTREGA DE LA CABAÑA Y ATENCIÓN BRINDADA PO...</td>
      <td>LA ENTREGA DE LA CABAÑA Y ATENCIÓN BRINDADA PO...</td>
      <td>51</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO DE ALOJAMIENTO</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>915</th>
      <td>encuestas</td>
      <td>lime_survey_995137</td>
      <td>995137X42X861SQ007</td>
      <td>995137</td>
      <td>877</td>
      <td>877.0</td>
      <td>E-mail:</td>
      <td>E-mail:</td>
      <td>42</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO AL CLIENTE</td>
    </tr>
    <tr>
      <th>916</th>
      <td>encuestas</td>
      <td>lime_survey_995137</td>
      <td>995137X42X862</td>
      <td>995137</td>
      <td>862</td>
      <td>862.0</td>
      <td>ESTADO LLAMADA:</td>
      <td>ESTADO LLAMADA:</td>
      <td>42</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO AL CLIENTE</td>
    </tr>
    <tr>
      <th>917</th>
      <td>encuestas</td>
      <td>lime_survey_995137</td>
      <td>995137X42X863</td>
      <td>995137</td>
      <td>863</td>
      <td>863.0</td>
      <td>AÑO:</td>
      <td>AÑO:</td>
      <td>42</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO AL CLIENTE</td>
    </tr>
    <tr>
      <th>918</th>
      <td>encuestas</td>
      <td>lime_survey_995137</td>
      <td>995137X42X864</td>
      <td>995137</td>
      <td>864</td>
      <td>864.0</td>
      <td>SEMESTRE:</td>
      <td>SEMESTRE:</td>
      <td>42</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO AL CLIENTE</td>
    </tr>
    <tr>
      <th>919</th>
      <td>encuestas</td>
      <td>lime_survey_995137</td>
      <td>995137X42X865</td>
      <td>995137</td>
      <td>865</td>
      <td>865.0</td>
      <td>MES:</td>
      <td>MES:</td>
      <td>42</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO AL CLIENTE</td>
    </tr>
  </tbody>
</table>
<p>920 rows × 10 columns</p>
</div>

<div class="highlight"><pre><span></span><code><span class="c1">#df_sol.to_excel(&#39;df_sol.xlsx&#39;,index=False)</span>
<span class="c1">#df_clean.to_excel(&#39;df_clean.xlsx&#39;,index=False)</span>
</code></pre></div>
<h3 id="consulta-de-respuestas-de-encuestas-lime_answers">Consulta de respuestas de encuestas (<code>lime_answers</code>)<a class="headerlink" href="#consulta-de-respuestas-de-encuestas-lime_answers" title="Permanent link">&para;</a></h3>
<p>Se ejecuta una consulta SQL para obtener las respuestas de encuestas desde la tabla <code>lime_answers</code> y sus descripciones desde la tabla <code>lime_answer_l10ns</code>. La consulta selecciona el <code>aid</code>, <code>qid</code>, <code>code</code>, y la respuesta (<code>answer</code>). El resultado de la consulta se almacena en el dataframe <code>df_lime_answers</code>, asegurando que las columnas <code>qid</code> y <code>aid</code> estén en formato <code>str</code> para facilitar su manipulación.</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">motor_neith</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">qr_structure</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT a1.aid, a1.qid, a1.code, a2.answer </span>
<span class="s2">                    FROM encuestas.lime_answers as a1</span>
<span class="s2">                    LEFT JOIN encuestas.lime_answer_l10ns as a2</span>
<span class="s2">                    ON a1.aid = a2.aid&quot;&quot;&quot;</span> 

    <span class="n">df_lime_answers</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">qr_structure</span><span class="p">),</span> <span class="n">conn</span><span class="p">)</span>
<span class="n">df_lime_answers</span><span class="p">[</span><span class="s1">&#39;qid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lime_answers</span><span class="p">[</span><span class="s1">&#39;qid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">df_lime_answers</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lime_answers</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">tables_survey_names</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="s1">&#39;NombreTabla&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</code></pre></div>
<h3 id="proceso-de-limpieza-y-estandarizacion-de-datos-en-encuestas">Proceso de Limpieza y Estandarización de Datos en Encuestas<a class="headerlink" href="#proceso-de-limpieza-y-estandarizacion-de-datos-en-encuestas" title="Permanent link">&para;</a></h3>
<p>Este bloque de código extrae y estandariza datos de múltiples tablas de encuestas (<code>tables_survey_names</code>), realizando operaciones de limpieza, validación, y normalización de campos relevantes como identificadores y fechas. Primero, cada tabla de encuestas se carga en <code>df_survey</code> y se mapea su estructura con <code>df_clean</code> y <code>df_lime_answers</code>, combinando campos y respuestas relacionadas. Solo se conservan los campos con valores válidos, descartando aquellos sin relación en <code>df_lime_answers</code>.</p>
<p>Para cada tabla de encuestas, se renombra y estandariza los nombres de las columnas identificadoras (<code>Cédula:</code>, <code>Número Documento de Identidad</code>, etc.) a <code>documento</code> y <code>tipo_documento</code>. Luego, se utiliza la función <code>melt</code> para transformar las tablas en un formato largo (<code>Pregunta</code>, <code>Respuesta</code>), facilitando su análisis y manipulación. Además, se eliminan espacios y tabulaciones no deseados en los valores de texto, reemplazando valores faltantes con <code>NaN</code>.</p>
<p>Las tablas finales son agregadas en <code>tablesToConcat</code> para unificación y exportación, mientras que las que no cumplen con los criterios se guardan como archivos CSV en el directorio actual para su revisión. La columna <code>DetalleEncuesta</code> también se añade a cada tabla, proporcionando contexto adicional.</p>
<div class="highlight"><pre><span></span><code><span class="n">df_survey</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">columnsStatic</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Cédula:&#39;</span><span class="p">,</span><span class="s1">&#39;NIT:&#39;</span><span class="p">,</span><span class="s1">&#39;Tipo Documento de Identidad&#39;</span><span class="p">,</span><span class="s1">&#39;Número Documento de Identidad&#39;</span><span class="p">,</span><span class="s1">&#39;Tipo Documento Identidad&#39;</span><span class="p">,</span> <span class="s1">&#39;Numero de identificación&#39;</span><span class="p">]</span>
<span class="n">columnsId</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Cédula:&#39;</span><span class="p">,</span> <span class="s1">&#39;Número Documento de Identidad&#39;</span><span class="p">,</span> <span class="s1">&#39;Numero de identificación&#39;</span> <span class="p">]</span>
<span class="n">columnsTipoId</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Tipo Documento de Identidad&#39;</span><span class="p">,</span> <span class="s1">&#39;Tipo Documento Identidad&#39;</span> <span class="p">]</span>
<span class="n">tablesToConcat</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">tables_survey_names</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">motor_neith</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">qr_structure</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM encuestas. &quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">table_name</span>
        <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">qr_structure</span><span class="p">),</span> <span class="n">conn</span><span class="p">)</span>

    <span class="n">dfColumns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;NombreCampo&#39;</span><span class="p">:</span><span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()})</span>
    <span class="n">dfColumns_p2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">dfColumns</span> <span class="p">,</span> <span class="n">df_clean</span> <span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span> <span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NombreCampo&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">dfColumns_p2</span> <span class="o">=</span> <span class="n">dfColumns_p2</span><span class="p">[</span> <span class="o">~</span><span class="n">dfColumns_p2</span><span class="p">[</span><span class="s1">&#39;NombreTabla&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="p">]</span>
    <span class="n">dfColumns_p2</span> <span class="o">=</span> <span class="n">dfColumns_p2</span><span class="p">[[</span><span class="s1">&#39;NombreCampo&#39;</span><span class="p">,</span><span class="s1">&#39;NombreTabla&#39;</span><span class="p">,</span><span class="s1">&#39;sid&#39;</span><span class="p">,</span><span class="s1">&#39;qid&#39;</span><span class="p">,</span><span class="s1">&#39;question_clean&#39;</span><span class="p">]]</span>
    <span class="n">dfToValidateAnswer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">dfColumns_p2</span> <span class="p">,</span> <span class="n">df_lime_answers</span> <span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span> <span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;qid&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">dfToValidateAnswer</span> <span class="o">=</span> <span class="n">dfToValidateAnswer</span><span class="p">[</span><span class="o">~</span><span class="n">dfToValidateAnswer</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
    <span class="n">columnsTVA</span> <span class="o">=</span> <span class="n">dfToValidateAnswer</span><span class="p">[</span><span class="s1">&#39;NombreCampo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">][[</span><span class="s1">&#39;submitdate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dfColumns_p2</span><span class="p">[</span><span class="s1">&#39;NombreCampo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span> 
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columnsTVA</span><span class="p">:</span>
            <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">][</span><span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;_answer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">][[</span><span class="n">col</span><span class="p">]]</span> <span class="p">,</span> <span class="n">dfToValidateAnswer</span><span class="p">[</span> <span class="n">dfToValidateAnswer</span><span class="p">[</span><span class="s1">&#39;NombreCampo&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">col</span> <span class="p">]</span> <span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span> <span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span> <span class="n">col</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s1">&#39;code&#39;</span> <span class="p">)[</span><span class="s1">&#39;answer&#39;</span><span class="p">]</span>
            <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;_answer&#39;</span><span class="p">:</span> <span class="n">col</span> <span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">newName</span> <span class="o">=</span> <span class="n">dfColumns_p2</span><span class="p">[</span> <span class="n">dfColumns_p2</span><span class="p">[</span><span class="s1">&#39;NombreCampo&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">col</span> <span class="p">][</span><span class="s1">&#39;question_clean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">newName</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span> <span class="n">col</span><span class="p">:</span> <span class="n">newName</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">columnsToMantain</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">columnsStatic</span><span class="p">]</span>
    <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">columnsToMantain</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No aplica&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span><span class="n">table_name</span> <span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
            <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">table_name</span> <span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;FECHA:&#39;</span> <span class="ow">in</span> <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tiene fecha&#39;</span><span class="p">)</span>
            <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span>  <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;submitdate&quot;</span><span class="p">,</span><span class="s1">&#39;FECHA:&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">columnsToMantain</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;Pregunta&quot;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;Respuesta&quot;</span><span class="p">)</span>
            <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">][</span><span class="s2">&quot;Respuesta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">][</span><span class="s2">&quot;Respuesta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="p">,</span> <span class="s2">&quot; &quot;</span> <span class="p">))</span>
            <span class="n">tablesToConcat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sin fecha&#39;</span><span class="p">)</span>
            <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span>  <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;submitdate&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">columnsToMantain</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;Pregunta&quot;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;Respuesta&quot;</span><span class="p">)</span>
            <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">][</span><span class="s2">&quot;Respuesta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">][</span><span class="s2">&quot;Respuesta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="p">,</span> <span class="s2">&quot; &quot;</span> <span class="p">))</span>
            <span class="n">tablesToConcat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">colClean</span> <span class="ow">in</span> <span class="n">columnsToMantain</span><span class="p">:</span>
            <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">][</span><span class="n">colClean</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">][</span><span class="n">colClean</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="p">,</span> <span class="s2">&quot;&quot;</span> <span class="p">))</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;posible vacio&#39;</span><span class="p">)</span>
        <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">table_name</span> <span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span>


    <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>    
    <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span> <span class="n">subset</span> <span class="o">=</span> <span class="n">columnsToMantain</span> <span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">][</span><span class="s1">&#39;DetalleEncuesta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">df_clean</span><span class="p">[</span><span class="s1">&#39;NombreTabla&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">table_name</span><span class="p">][</span><span class="s1">&#39;DetalleTabla&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> 

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columnsId</span><span class="p">:</span>
        <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span> <span class="n">col</span><span class="p">:</span> <span class="s1">&#39;documento&#39;</span> <span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columnsTipoId</span><span class="p">:</span>
        <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_survey</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span> <span class="n">col</span><span class="p">:</span> <span class="s1">&#39;tipo_documento&#39;</span> <span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>lime_survey_124282
No aplica C:\Users\Consultor_QCS\Documents\Local\Cajamag\02.Gobierno_De_Datos\03.Ejecución\18.Bodega\Entrega\Bloques\Bloque6\lime_survey_124282.csv
lime_survey_161825
tiene fecha
lime_survey_189858
tiene fecha
lime_survey_267495
tiene fecha
lime_survey_385698
sin fecha
lime_survey_413658
No aplica C:\Users\Consultor_QCS\Documents\Local\Cajamag\02.Gobierno_De_Datos\03.Ejecución\18.Bodega\Entrega\Bloques\Bloque6\lime_survey_413658.csv
lime_survey_452416
tiene fecha
lime_survey_478847
No aplica C:\Users\Consultor_QCS\Documents\Local\Cajamag\02.Gobierno_De_Datos\03.Ejecución\18.Bodega\Entrega\Bloques\Bloque6\lime_survey_478847.csv
lime_survey_548818
tiene fecha
lime_survey_567215
sin fecha
lime_survey_576377
tiene fecha
lime_survey_586872
No aplica C:\Users\Consultor_QCS\Documents\Local\Cajamag\02.Gobierno_De_Datos\03.Ejecución\18.Bodega\Entrega\Bloques\Bloque6\lime_survey_586872.csv
lime_survey_599513
No aplica C:\Users\Consultor_QCS\Documents\Local\Cajamag\02.Gobierno_De_Datos\03.Ejecución\18.Bodega\Entrega\Bloques\Bloque6\lime_survey_599513.csv
lime_survey_699399
sin fecha
posible vacio
lime_survey_757259
sin fecha
lime_survey_767954
No aplica C:\Users\Consultor_QCS\Documents\Local\Cajamag\02.Gobierno_De_Datos\03.Ejecución\18.Bodega\Entrega\Bloques\Bloque6\lime_survey_767954.csv
lime_survey_773674
No aplica C:\Users\Consultor_QCS\Documents\Local\Cajamag\02.Gobierno_De_Datos\03.Ejecución\18.Bodega\Entrega\Bloques\Bloque6\lime_survey_773674.csv
lime_survey_818378
sin fecha
lime_survey_832591
sin fecha
lime_survey_934423
tiene fecha
lime_survey_959511
tiene fecha
lime_survey_995137
tiene fecha
</code></pre></div>

<h3 id="concatenacion-final-de-encuestas">Concatenación final de encuestas<a class="headerlink" href="#concatenacion-final-de-encuestas" title="Permanent link">&para;</a></h3>
<p>Se filtran las tablas procesadas en <code>df_survey</code> que están presentes en la lista <code>tablesToConcat</code> y se almacenan en el diccionario <code>df_survey_2</code>. Luego, se concatenan todas las tablas seleccionadas en un único dataframe <code>df_survey_final</code>, combinando los resultados y asegurando un índice continuo.</p>
<div class="highlight"><pre><span></span><code><span class="n">df_survey_2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">tablesToConcat</span><span class="p">,</span> <span class="n">df_survey</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="p">)</span>
<span class="n">df_survey_final</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_survey_2</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="p">,</span> <span class="n">ignore_index</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">)</span>
</code></pre></div>
<h3 id="conexion-transformacion-y-estandarizacion-de-datos-de-encuestas">Conexión, Transformación y Estandarización de Datos de Encuestas<a class="headerlink" href="#conexion-transformacion-y-estandarizacion-de-datos-de-encuestas" title="Permanent link">&para;</a></h3>
<p>Este código conecta a la base de datos DWH, consulta datos de <code>BD_Dim_Datos_Fijos</code>, y realiza operaciones de limpieza y normalización en <code>df_survey_final</code>. </p>
<p>Primero, se establece la conexión mediante <code>motor3</code> y se extrae <code>DOCUMENTO</code> y <code>CODDOC</code> de <code>BD_Dim_Datos_Fijos</code>, que luego se combina con <code>df_survey_final</code> para asignar el tipo de documento (<code>tipo_documento</code>), reemplazando valores faltantes por "CC". La columna <code>ID_AFILIADO</code> se crea concatenando <code>tipo_documento</code> y <code>documento</code>.</p>
<p>A continuación, las columnas se renombran para facilitar su identificación y el campo <code>FECHA</code> se convierte al tipo <code>datetime</code>, permitiendo generar el campo <code>PERIODO</code> en formato <code>YYYYMM</code>. Las columnas se reordenan, colocando <code>ID_AFILIADO</code> al inicio para una organización clara, y finalmente se verifica el resultado en los logs.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#---------------------------------------------</span>
<span class="c1">#Conexion a base dwh</span>
<span class="n">cadena_conexion3</span> <span class="o">=</span> <span class="n">Conexion_dwh</span><span class="p">()</span>
<span class="n">motor3</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">cadena_conexion3</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CONEXION A BASE DWH&#39;</span><span class="p">)</span>


<span class="c1"># Bloque 1: Consulta y carga de datos</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Iniciando consulta a BD_Dim_Datos_Fijos y carga de datos.&quot;</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT DOCUMENTO, CODDOC FROM BD_Dim_Datos_Fijos&quot;</span>
<span class="n">df_datos_fijos</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">motor3</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Consulta a BD_Dim_Datos_Fijos completada: </span><span class="si">{</span><span class="n">df_datos_fijos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> filas cargadas.&quot;</span><span class="p">)</span>

<span class="c1"># Bloque 2: Merge y limpieza de columnas</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Realizando merge entre df_survey_final y BD_Dim_Datos_Fijos, seguido de limpieza de columnas.&quot;</span><span class="p">)</span>
<span class="n">df_survey_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_survey_final</span><span class="p">,</span> <span class="n">df_datos_fijos</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;documento&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">)</span>
<span class="n">df_survey_final</span> <span class="o">=</span> <span class="n">df_survey_final</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">])</span>
<span class="n">df_survey_final</span><span class="p">[</span><span class="s1">&#39;tipo_documento&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_survey_final</span><span class="p">[</span><span class="s1">&#39;CODDOC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;CC&#39;</span><span class="p">)</span>
<span class="n">df_survey_final</span> <span class="o">=</span> <span class="n">df_survey_final</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CODDOC&#39;</span><span class="p">])</span>

<span class="c1"># Bloque 3: Generación de ID y reorganización de columnas</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generando &#39;ID_AFILIADO&#39; y reorganizando columnas.&quot;</span><span class="p">)</span>
<span class="n">df_survey_final</span><span class="p">[</span><span class="s1">&#39;ID_AFILIADO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_survey_final</span><span class="p">[</span><span class="s1">&#39;tipo_documento&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="n">df_survey_final</span><span class="p">[</span><span class="s1">&#39;documento&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="c1"># Renombrar columnas</span>
<span class="n">df_survey_final</span> <span class="o">=</span> <span class="n">df_survey_final</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&#39;submitdate&#39;</span><span class="p">:</span> <span class="s1">&#39;FECHA_ENCUESTA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FECHA:&#39;</span> <span class="p">:</span> <span class="s1">&#39;FECHA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;documento&#39;</span><span class="p">:</span> <span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Pregunta&#39;</span><span class="p">:</span> <span class="s1">&#39;PREGUNTA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Respuesta&#39;</span><span class="p">:</span> <span class="s1">&#39;RESPUESTA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DetalleEncuesta&#39;</span><span class="p">:</span> <span class="s1">&#39;NOMBRE_ENCUESTA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NIT:&#39;</span><span class="p">:</span> <span class="s1">&#39;NIT_EMPRESA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tipo_documento&#39;</span><span class="p">:</span> <span class="s1">&#39;TIPO_DOCUMENTO&#39;</span><span class="p">,</span>
<span class="p">})</span>

<span class="c1"># Asegurarse que FECHA es de tipo datetime</span>
<span class="n">df_survey_final</span><span class="p">[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_survey_final</span><span class="p">[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">])</span>

<span class="c1"># Crear el campo PERIODO con el formato &#39;YYYYMM&#39;</span>
<span class="n">df_survey_final</span><span class="p">[</span><span class="s1">&#39;PERIODO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_survey_final</span><span class="p">[</span><span class="s1">&#39;FECHA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m&#39;</span><span class="p">)</span>


<span class="c1"># Reordenar las columnas colocando &#39;ID_AFILIADO&#39; en la primera posición</span>
<span class="n">columnas</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ID_AFILIADO&#39;</span><span class="p">,</span> <span class="s1">&#39;PERIODO&#39;</span><span class="p">,</span> <span class="s1">&#39;FECHA_ENCUESTA&#39;</span><span class="p">,</span> <span class="s1">&#39;FECHA&#39;</span><span class="p">,</span> <span class="s1">&#39;TIPO_DOCUMENTO&#39;</span><span class="p">,</span><span class="s1">&#39;DOCUMENTO&#39;</span><span class="p">,</span>
       <span class="s1">&#39;NOMBRE_ENCUESTA&#39;</span><span class="p">,</span><span class="s1">&#39;PREGUNTA&#39;</span><span class="p">,</span> <span class="s1">&#39;RESPUESTA&#39;</span><span class="p">,</span> <span class="s1">&#39;NIT_EMPRESA&#39;</span><span class="p">,</span> <span class="p">]</span>
<span class="n">df_survey_final</span> <span class="o">=</span> <span class="n">df_survey_final</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columnas</span><span class="p">)</span>

<span class="c1"># Mostrar las columnas finales</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proceso completado. Columnas finales: </span><span class="si">{</span><span class="n">df_survey_final</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 10:27:02,768 - INFO - CONEXION A BASE DWH
2024-10-30 10:27:02,770 - INFO - Iniciando consulta a BD_Dim_Datos_Fijos y carga de datos.
2024-10-30 10:27:08,813 - INFO - Consulta a BD_Dim_Datos_Fijos completada: 970252 filas cargadas.
2024-10-30 10:27:08,814 - INFO - Realizando merge entre df_survey_final y BD_Dim_Datos_Fijos, seguido de limpieza de columnas.
2024-10-30 10:27:09,197 - INFO - Generando &#39;ID_AFILIADO&#39; y reorganizando columnas.
2024-10-30 10:27:09,687 - INFO - Proceso completado. Columnas finales: [&#39;ID_AFILIADO&#39;, &#39;PERIODO&#39;, &#39;FECHA_ENCUESTA&#39;, &#39;FECHA&#39;, &#39;TIPO_DOCUMENTO&#39;, &#39;DOCUMENTO&#39;, &#39;NOMBRE_ENCUESTA&#39;, &#39;PREGUNTA&#39;, &#39;RESPUESTA&#39;, &#39;NIT_EMPRESA&#39;]
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># Convertir el campo PERIODO a datetime para poder filtrar</span>
<span class="n">df_survey_final</span><span class="p">[</span><span class="s1">&#39;PERIODO_DT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_survey_final</span><span class="p">[</span><span class="s1">&#39;PERIODO&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;01&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Calcular la fecha límite de 18 meses atrás desde la fecha actual y ajustarla al primer día del mes siguiente</span>
<span class="n">fecha_limite</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">primer_dia_mes_siguiente</span> <span class="o">=</span> <span class="p">(</span><span class="n">fecha_limite</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">MonthBegin</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>

<span class="c1"># Filtrar los resultados para los últimos 18 meses a partir del campo PERIODO</span>
<span class="n">df_filtrado</span> <span class="o">=</span> <span class="n">df_survey_final</span><span class="p">[</span><span class="n">df_survey_final</span><span class="p">[</span><span class="s1">&#39;PERIODO_DT&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">primer_dia_mes_siguiente</span><span class="p">]</span>

<span class="c1"># Eliminar el campo &#39;PERIODO_DT&#39;</span>
<span class="n">df_survey_final</span> <span class="o">=</span> <span class="n">df_filtrado</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PERIODO_DT&#39;</span><span class="p">,</span><span class="s1">&#39;NIT_EMPRESA&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_survey_final</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID_AFILIADO</th>
      <th>PERIODO</th>
      <th>FECHA_ENCUESTA</th>
      <th>FECHA</th>
      <th>TIPO_DOCUMENTO</th>
      <th>DOCUMENTO</th>
      <th>NOMBRE_ENCUESTA</th>
      <th>PREGUNTA</th>
      <th>RESPUESTA</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>CC4158282</td>
      <td>202404</td>
      <td>2024-04-10 10:53:55</td>
      <td>2024-04-10</td>
      <td>CC</td>
      <td>4158282</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO DE ALOJAMIENTO</td>
      <td>Nombres y Apellidos:</td>
      <td>MURCIA LOPEZ LUIS</td>
    </tr>
    <tr>
      <th>1</th>
      <td>CC79690928</td>
      <td>202404</td>
      <td>2024-04-10 10:57:38</td>
      <td>2024-04-10</td>
      <td>CC</td>
      <td>79690928</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO DE ALOJAMIENTO</td>
      <td>Nombres y Apellidos:</td>
      <td>ESPINOSA TORO JOSE JAVIER</td>
    </tr>
    <tr>
      <th>2</th>
      <td>CC1032470737</td>
      <td>202404</td>
      <td>2024-04-10 11:00:04</td>
      <td>2024-04-10</td>
      <td>CC</td>
      <td>1032470737</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO DE ALOJAMIENTO</td>
      <td>Nombres y Apellidos:</td>
      <td>MURCIA FLORIAN NEIFY ESPERANZA</td>
    </tr>
    <tr>
      <th>3</th>
      <td>CC1073609064</td>
      <td>202404</td>
      <td>2024-04-10 11:03:14</td>
      <td>2024-04-10</td>
      <td>CC</td>
      <td>1073609064</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO DE ALOJAMIENTO</td>
      <td>Nombres y Apellidos:</td>
      <td>MURCIA FLORIAN MONICA</td>
    </tr>
    <tr>
      <th>4</th>
      <td>CC1056029010</td>
      <td>202404</td>
      <td>2024-04-10 11:05:07</td>
      <td>2024-04-10</td>
      <td>CC</td>
      <td>1056029010</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO DE ALOJAMIENTO</td>
      <td>Nombres y Apellidos:</td>
      <td>MURCIA FLORIAN MARTA</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>282363</th>
      <td>CC1081918879</td>
      <td>202407</td>
      <td>2024-07-17 10:02:42</td>
      <td>2024-07-17</td>
      <td>CC</td>
      <td>1081918879</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO AL CLIENTE</td>
      <td>Nombre del Funcionario que aplicó la encuesta:</td>
      <td>katty.jimenez</td>
    </tr>
    <tr>
      <th>282364</th>
      <td>CC57293976</td>
      <td>202407</td>
      <td>2024-07-17 10:04:07</td>
      <td>2024-07-17</td>
      <td>CC</td>
      <td>57293976</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO AL CLIENTE</td>
      <td>Nombre del Funcionario que aplicó la encuesta:</td>
      <td>katty.jimenez</td>
    </tr>
    <tr>
      <th>282365</th>
      <td>CC1081915588</td>
      <td>202407</td>
      <td>2024-07-17 10:06:40</td>
      <td>2024-07-17</td>
      <td>CC</td>
      <td>1081915588</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO AL CLIENTE</td>
      <td>Nombre del Funcionario que aplicó la encuesta:</td>
      <td>katty.jimenez</td>
    </tr>
    <tr>
      <th>282366</th>
      <td>CC1082243440</td>
      <td>202407</td>
      <td>2024-07-17 10:08:00</td>
      <td>2024-07-17</td>
      <td>CC</td>
      <td>1082243440</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO AL CLIENTE</td>
      <td>Nombre del Funcionario que aplicó la encuesta:</td>
      <td>katty.jimenez</td>
    </tr>
    <tr>
      <th>282367</th>
      <td>CC1081916237</td>
      <td>202407</td>
      <td>2024-07-17 10:09:58</td>
      <td>2024-07-17</td>
      <td>CC</td>
      <td>1081916237</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO AL CLIENTE</td>
      <td>Nombre del Funcionario que aplicó la encuesta:</td>
      <td>sandra.perez</td>
    </tr>
  </tbody>
</table>
<p>78778 rows × 9 columns</p>
</div>

<h3 id="crear-dim-encuestas">Crear Dim Encuestas<a class="headerlink" href="#crear-dim-encuestas" title="Permanent link">&para;</a></h3>
<p>En esta parte se identifican las encuestas únicas y se asigna un indice que sirve como llave primaria. Luego se cruza con la df_survey_final para asignar la llave correspondiente</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Encontrar valor unicos de nombres de encuestas</span>
<span class="n">df_unique_nombre_encuesta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_survey_final</span><span class="p">[</span><span class="s1">&#39;NOMBRE_ENCUESTA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NOMBRE_ENCUESTA&#39;</span><span class="p">])</span>

<span class="c1"># Ordenar por orden alfabético</span>
<span class="n">df_unique_nombre_encuesta</span> <span class="o">=</span> <span class="n">df_unique_nombre_encuesta</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;NOMBRE_ENCUESTA&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Asignar un índice empezando desde 1</span>
<span class="n">df_unique_nombre_encuesta</span><span class="p">[</span><span class="s1">&#39;ID_ENCUESTA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_unique_nombre_encuesta</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c1"># Reorganizar las columnas para tener &#39;Index&#39; como la primera columna</span>
<span class="n">df_unique_nombre_encuesta</span> <span class="o">=</span> <span class="n">df_unique_nombre_encuesta</span><span class="p">[[</span><span class="s1">&#39;ID_ENCUESTA&#39;</span><span class="p">,</span> <span class="s1">&#39;NOMBRE_ENCUESTA&#39;</span><span class="p">]]</span>
<span class="n">df_unique_nombre_encuesta</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID_ENCUESTA</th>
      <th>NOMBRE_ENCUESTA</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>ENCUESTA DE SATISFACCION AFILIACION DE EMPLEAD...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>ENCUESTA DE SATISFACCION DE AFILIACION DEL TRA...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>ENCUESTA DE SATISFACCION ESCUELAS DEPORTIVAS</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO AL CLIENTE</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO DE ALIMENTOS...</td>
    </tr>
    <tr>
      <th>5</th>
      <td>6</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO DE ALOJAMIENTO</td>
    </tr>
    <tr>
      <th>6</th>
      <td>7</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO DE RECREACION</td>
    </tr>
    <tr>
      <th>7</th>
      <td>8</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO DE VACUNACION</td>
    </tr>
    <tr>
      <th>8</th>
      <td>9</td>
      <td>ENCUESTA DE SATISFACCIÓN DE VIVIENDA FOVIS</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><span class="c1"># Realizar el inner join con el DataFrame df_survey_final por el campo NOMBRE_ENCUESTA</span>
<span class="n">df_survey_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_survey_final</span><span class="p">,</span> <span class="n">df_unique_nombre_encuesta</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;NOMBRE_ENCUESTA&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
<span class="n">df_survey_final</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID_AFILIADO</th>
      <th>PERIODO</th>
      <th>FECHA_ENCUESTA</th>
      <th>FECHA</th>
      <th>TIPO_DOCUMENTO</th>
      <th>DOCUMENTO</th>
      <th>NOMBRE_ENCUESTA</th>
      <th>PREGUNTA</th>
      <th>RESPUESTA</th>
      <th>ID_ENCUESTA</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>CC4158282</td>
      <td>202404</td>
      <td>2024-04-10 10:53:55</td>
      <td>2024-04-10</td>
      <td>CC</td>
      <td>4158282</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO DE ALOJAMIENTO</td>
      <td>Nombres y Apellidos:</td>
      <td>MURCIA LOPEZ LUIS</td>
      <td>6</td>
    </tr>
    <tr>
      <th>1</th>
      <td>CC79690928</td>
      <td>202404</td>
      <td>2024-04-10 10:57:38</td>
      <td>2024-04-10</td>
      <td>CC</td>
      <td>79690928</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO DE ALOJAMIENTO</td>
      <td>Nombres y Apellidos:</td>
      <td>ESPINOSA TORO JOSE JAVIER</td>
      <td>6</td>
    </tr>
    <tr>
      <th>2</th>
      <td>CC1032470737</td>
      <td>202404</td>
      <td>2024-04-10 11:00:04</td>
      <td>2024-04-10</td>
      <td>CC</td>
      <td>1032470737</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO DE ALOJAMIENTO</td>
      <td>Nombres y Apellidos:</td>
      <td>MURCIA FLORIAN NEIFY ESPERANZA</td>
      <td>6</td>
    </tr>
    <tr>
      <th>3</th>
      <td>CC1073609064</td>
      <td>202404</td>
      <td>2024-04-10 11:03:14</td>
      <td>2024-04-10</td>
      <td>CC</td>
      <td>1073609064</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO DE ALOJAMIENTO</td>
      <td>Nombres y Apellidos:</td>
      <td>MURCIA FLORIAN MONICA</td>
      <td>6</td>
    </tr>
    <tr>
      <th>4</th>
      <td>CC1056029010</td>
      <td>202404</td>
      <td>2024-04-10 11:05:07</td>
      <td>2024-04-10</td>
      <td>CC</td>
      <td>1056029010</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO DE ALOJAMIENTO</td>
      <td>Nombres y Apellidos:</td>
      <td>MURCIA FLORIAN MARTA</td>
      <td>6</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>78773</th>
      <td>CC1081918879</td>
      <td>202407</td>
      <td>2024-07-17 10:02:42</td>
      <td>2024-07-17</td>
      <td>CC</td>
      <td>1081918879</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO AL CLIENTE</td>
      <td>Nombre del Funcionario que aplicó la encuesta:</td>
      <td>katty.jimenez</td>
      <td>4</td>
    </tr>
    <tr>
      <th>78774</th>
      <td>CC57293976</td>
      <td>202407</td>
      <td>2024-07-17 10:04:07</td>
      <td>2024-07-17</td>
      <td>CC</td>
      <td>57293976</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO AL CLIENTE</td>
      <td>Nombre del Funcionario que aplicó la encuesta:</td>
      <td>katty.jimenez</td>
      <td>4</td>
    </tr>
    <tr>
      <th>78775</th>
      <td>CC1081915588</td>
      <td>202407</td>
      <td>2024-07-17 10:06:40</td>
      <td>2024-07-17</td>
      <td>CC</td>
      <td>1081915588</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO AL CLIENTE</td>
      <td>Nombre del Funcionario que aplicó la encuesta:</td>
      <td>katty.jimenez</td>
      <td>4</td>
    </tr>
    <tr>
      <th>78776</th>
      <td>CC1082243440</td>
      <td>202407</td>
      <td>2024-07-17 10:08:00</td>
      <td>2024-07-17</td>
      <td>CC</td>
      <td>1082243440</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO AL CLIENTE</td>
      <td>Nombre del Funcionario que aplicó la encuesta:</td>
      <td>katty.jimenez</td>
      <td>4</td>
    </tr>
    <tr>
      <th>78777</th>
      <td>CC1081916237</td>
      <td>202407</td>
      <td>2024-07-17 10:09:58</td>
      <td>2024-07-17</td>
      <td>CC</td>
      <td>1081916237</td>
      <td>ENCUESTA DE SATISFACCION SERVICIO AL CLIENTE</td>
      <td>Nombre del Funcionario que aplicó la encuesta:</td>
      <td>sandra.perez</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
<p>78778 rows × 10 columns</p>
</div>

<h3 id="conexion-a-la-base-de-datos-dwh_2">Conexión a la base de datos DWH<a class="headerlink" href="#conexion-a-la-base-de-datos-dwh_2" title="Permanent link">&para;</a></h3>
<p>Se establece la conexión con la base de datos DWH utilizando la función <code>Conexion_dwh()</code> y se crea el motor de conexión con <code>create_engine()</code>. El evento de conexión exitosa se registra en el log.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#---------------------------------------------</span>
<span class="c1">#Conexion a base dwh</span>
<span class="n">cadena_conexion2</span> <span class="o">=</span> <span class="n">Conexion_dwh</span><span class="p">()</span>
<span class="n">motor2</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">cadena_conexion2</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CONEXION A BASE DWH&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 10:27:09,850 - INFO - CONEXION A BASE DWH
</code></pre></div>

<h3 id="guardar-en-base-de-datos-dwh_4">Guardar en base de datos DWH<a class="headerlink" href="#guardar-en-base-de-datos-dwh_4" title="Permanent link">&para;</a></h3>
<p>Se guarda el dataframe <code>df_survey_final</code> en la tabla <code>BD_Fact_Encuestas</code> de la base de datos DWH. Si la tabla ya existe, se reemplaza su contenido con los nuevos datos. Se registra el tiempo total de almacenamiento en el log y, una vez completado el proceso, también se registra el tiempo total de ejecución del proceso ETL.</p>
<div class="highlight"><pre><span></span><code><span class="n">guardar_en_dwh</span><span class="p">(</span><span class="n">df_survey_final</span><span class="p">,</span> <span class="s1">&#39;BD_Fact_Encuestas&#39;</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 10:27:09,860 - INFO - Intentando conexión a la base DWH...
2024-10-30 10:27:09,862 - INFO - Conexión a la base DWH establecida con éxito.
2024-10-30 10:27:10,261 - INFO - Almacenando tabla única en DWH como BD_Fact_Encuestas
2024-10-30 10:27:22,427 - INFO - Tabla almacenada correctamente. 78,778 registros finales obtenidos.
2024-10-30 10:27:22,542 - INFO - ALMACENAMIENTO ---  --- 12.68 seconds ---
2024-10-30 10:27:22,542 - INFO - Finalizando proceso de almacenamiento en DWH.
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">guardar_en_dwh</span><span class="p">(</span><span class="n">df_unique_nombre_encuesta</span><span class="p">,</span> <span class="s1">&#39;BD_Dim_Encuestas&#39;</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 10:27:22,549 - INFO - Intentando conexión a la base DWH...
2024-10-30 10:27:22,551 - INFO - Conexión a la base DWH establecida con éxito.
2024-10-30 10:27:22,940 - INFO - Almacenando tabla única en DWH como BD_Dim_Encuestas
2024-10-30 10:27:23,504 - INFO - Tabla almacenada correctamente. 9 registros finales obtenidos.
2024-10-30 10:27:23,580 - INFO - ALMACENAMIENTO ---  --- 1.03 seconds ---
2024-10-30 10:27:23,581 - INFO - Finalizando proceso de almacenamiento en DWH.
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;FINAL ETL --- </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> seconds ---&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-30 10:27:57,385 - INFO - FINAL ETL --- 64.46 seconds ---
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="../../js/init_mermaid.js"></script>
      
    
  </body>
</html>