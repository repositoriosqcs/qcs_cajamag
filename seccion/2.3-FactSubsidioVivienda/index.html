
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../2.2-FactHistoricoCuota/">
      
      
        <link rel="next" href="../2.4-FactFosfec/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.42">
    
    
      
        <title>2.3 FactSubsidioVivienda - Optimización CAJAMAG - Gobierno de Datos</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="#d89717" data-md-color-accent="light-blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#23-fact-subsidio-vivienda" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../.." title="Optimización CAJAMAG - Gobierno de Datos" class="md-header__button md-logo" aria-label="Optimización CAJAMAG - Gobierno de Datos" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Optimización CAJAMAG - Gobierno de Datos
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2.3 FactSubsidioVivienda
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Buscar">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpiar" aria-label="Limpiar" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Optimización CAJAMAG - Gobierno de Datos" class="md-nav__button md-logo" aria-label="Optimización CAJAMAG - Gobierno de Datos" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Optimización CAJAMAG - Gobierno de Datos
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    INTRODUCCIÓN
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../instalacion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    INSTALACIÓN Y CONFIGURACIÓN
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../buenaspracticas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BUENAS PRACTICAS
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../codigo/funciones/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FUNCIONES
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    BODEGAS
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            BODEGAS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    1. Bodega 1
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            1. Bodega 1
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Bloque1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intoduccion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.1-DimDatosFijos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.1 DimDatosFijos
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.2-DimCalendarioMensual/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.2 DimCalendarioMensual
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.3-Dimensiones/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.3 Dimensiones
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.4-Dimensiones_xml/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.4 Dimensiones xml
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.5-FactDatosContacto/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.5 FactDatosContacto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.6-Fact_Historico_Afiliacion_Empresas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.6 Fact Historico Afiliacion Empresas
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.7-Fact_Historico_Trabajadores1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.7 Fact Historico Trabajadores1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.7-Fact_Historico_Trabajadores2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.7 Fact Historico Trabajadores2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.8-Fact_HistoricoBeneficiarios/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.8 Fact HistoricoBeneficiarios
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.9-Dim_Parametricas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.9 Dim Parametricas
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" checked>
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    2. Bodega 2
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            2. Bodega 2
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Bloque2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intoduccion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.1-FactAportesEmpAfiliadas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.1 FactAportesEmpAfiliadas
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.1-FactHistoricoAportesTotales/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.1 FactHistoricoAportesTotales
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.2-FactHistoricoCuota/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.2 FactHistoricoCuota
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    2.3 FactSubsidioVivienda
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    2.3 FactSubsidioVivienda
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduccion" class="md-nav__link">
    <span class="md-ellipsis">
      Introducción
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Introducción">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#diagrama-de-secuencia-para-el-proceso-etl" class="md-nav__link">
    <span class="md-ellipsis">
      Diagrama de secuencia para el proceso ETL
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#etl" class="md-nav__link">
    <span class="md-ellipsis">
      ETL
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ETL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#importacion-de-librerias-y-funciones" class="md-nav__link">
    <span class="md-ellipsis">
      Importación de librerías y funciones
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuracion-inicial-del-logger" class="md-nav__link">
    <span class="md-ellipsis">
      Configuración inicial del logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#definicion-de-consultas-sql-para-extraccion-de-datos-de-vivienda" class="md-nav__link">
    <span class="md-ellipsis">
      Definición de Consultas SQL para Extracción de Datos de Vivienda
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conexion-y-carga-de-tablas-desde-sql" class="md-nav__link">
    <span class="md-ellipsis">
      Conexión y carga de tablas desde SQL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validador-de-campos-repetidos" class="md-nav__link">
    <span class="md-ellipsis">
      Validador de campos repetidos
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transformacion-y-limpieza-de-texto" class="md-nav__link">
    <span class="md-ellipsis">
      Transformación y limpieza de texto
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conexion-a-la-base-de-datos-dwh" class="md-nav__link">
    <span class="md-ellipsis">
      Conexión a la base de datos DWH
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#guardar-en-base-de-datos-dwh" class="md-nav__link">
    <span class="md-ellipsis">
      Guardar en base de datos DWH
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.4-FactFosfec/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.4 FactFosfec
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.2-FactEstadoGiroCuota/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.2 FactEstadoGiroCuota
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.5-Fact_HistoricoMoraEmp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.5 Fact HistoricoMoraEmp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.6-FactHistoricoANS/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.6 FactHistoricoANS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.7-FactHistoricoSubPrescrito/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.7 FactHistoricoSubPrescrito
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.8-FactHistoricoRecobro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.8 FactHistoricoRecobro
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.9-FactHistoricoRecuperado/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.9 FactHistoricoRecuperado
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.10-FactIgestion_Mercurio/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.10 FactIgestion Mercurio
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    3. Bodega 3
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            3. Bodega 3
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Bloque3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intoduccion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3.1-FactTransaccionesVentas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3.1 FactTransaccionesVentas
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    4. Bodega 4
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            4. Bodega 4
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Bloque4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intoduccion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4.1-FactColegio_fijos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4.1 FactColegio fijos
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4.2-FactColegio/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4.2 FactColegio
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    5. Bodega 5
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            5. Bodega 5
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Bloque5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intoduccion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../5.1-FactServicioSocial_Fijos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5.1 FactServicioSocial Fijos
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../5.2-FactServicioSocial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5.2 FactServicioSocial
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    6. Bodega 6
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            6. Bodega 6
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Bloque6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intoduccion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../6.1-FactEncuestas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6.1 FactEncuestas
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../6.2-Fact_Encuesta_afil_empleador/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6.2 Fact Encuesta afil empleador
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduccion" class="md-nav__link">
    <span class="md-ellipsis">
      Introducción
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Introducción">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#diagrama-de-secuencia-para-el-proceso-etl" class="md-nav__link">
    <span class="md-ellipsis">
      Diagrama de secuencia para el proceso ETL
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#etl" class="md-nav__link">
    <span class="md-ellipsis">
      ETL
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ETL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#importacion-de-librerias-y-funciones" class="md-nav__link">
    <span class="md-ellipsis">
      Importación de librerías y funciones
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuracion-inicial-del-logger" class="md-nav__link">
    <span class="md-ellipsis">
      Configuración inicial del logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#definicion-de-consultas-sql-para-extraccion-de-datos-de-vivienda" class="md-nav__link">
    <span class="md-ellipsis">
      Definición de Consultas SQL para Extracción de Datos de Vivienda
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conexion-y-carga-de-tablas-desde-sql" class="md-nav__link">
    <span class="md-ellipsis">
      Conexión y carga de tablas desde SQL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validador-de-campos-repetidos" class="md-nav__link">
    <span class="md-ellipsis">
      Validador de campos repetidos
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transformacion-y-limpieza-de-texto" class="md-nav__link">
    <span class="md-ellipsis">
      Transformación y limpieza de texto
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conexion-a-la-base-de-datos-dwh" class="md-nav__link">
    <span class="md-ellipsis">
      Conexión a la base de datos DWH
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#guardar-en-base-de-datos-dwh" class="md-nav__link">
    <span class="md-ellipsis">
      Guardar en base de datos DWH
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="23-fact-subsidio-vivienda">2.3 Fact Subsidio Vivienda<a class="headerlink" href="#23-fact-subsidio-vivienda" title="Permanent link">&para;</a></h1>
<h2 id="introduccion">Introducción<a class="headerlink" href="#introduccion" title="Permanent link">&para;</a></h2>
<p>El objetivo de este proceso ETL es integrar y almacenar en un <em>Data Warehouse</em> (DWH) los datos de postulaciones para subsidios de vivienda. Se inicia configurando el entorno de trabajo y registrando los eventos mediante un <code>logger</code> que documenta cada fase del proceso. Con una serie de consultas SQL definidas en <code>qr_structure</code>, el proceso extrae datos de varias tablas relacionadas con subsidios en la base de datos Minerva, tales como <code>subvi02</code>, <code>subvi03</code>, <code>subvi04</code>, <code>subvi05</code>, y <code>subvi06</code>. Estas consultas incluyen filtros específicos para seleccionar los registros de los últimos 18 meses, a través de la columna <code>periodo</code>.</p>
<p>Cada tabla es validada en búsqueda de registros duplicados antes de transformarse en un formato uniforme y limpio. Las columnas de texto son convertidas a mayúsculas y sus valores de <code>"NAN"</code> o <code>"NONE"</code> son reemplazados con valores nulos para facilitar el procesamiento. Finalmente, el proceso guarda los datos transformados en tablas específicas del DWH, reemplazando los datos previos si existen. Las tablas se guardan con nombres definidos en <code>dim_names</code> para cada conjunto de datos: <code>BD_Dim_Subvi_Postulacion</code>, <code>BD_Dim_Subvi_Postulacion_Detalle</code>, <code>BD_Fact_Subvi_Beneficiario</code>, <code>BD_Fact_Subvi_Financiero</code>, y <code>BD_Fact_Subvi_Resultado_Solicitud</code>.</p>
<hr />
<h3 id="diagrama-de-secuencia-para-el-proceso-etl">Diagrama de secuencia para el proceso ETL<a class="headerlink" href="#diagrama-de-secuencia-para-el-proceso-etl" title="Permanent link">&para;</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    title Diagrama de secuencia para el proceso ETL - FactSubsidioVivienda
    participant 👤 Usuario
    participant ETL_Script
    participant Minerva_DB as Base de Datos Minerva
    participant DWH as Data Warehouse

    Usuario -&gt;&gt; ETL_Script: Ejecuta el script ETL
    ETL_Script -&gt;&gt; ETL_Script: Configura entorno y logger
    ETL_Script -&gt;&gt; Minerva_DB: Conecta a BD Minerva
    Minerva_DB --&gt;&gt; ETL_Script: Conexión exitosa
    ETL_Script -&gt;&gt; Minerva_DB: Ejecuta consultas para cada tabla de `qr_structure`
    Minerva_DB --&gt;&gt; ETL_Script: Retorna datos de postulaciones y subsidios
    ETL_Script -&gt;&gt; ETL_Script: Valida duplicados y limpia datos
    ETL_Script -&gt;&gt; DWH: Conecta a BD DWH
    DWH --&gt;&gt; ETL_Script: Conexión exitosa
    ETL_Script -&gt;&gt; DWH: Carga cada tabla en DWH según `dim_names`
    DWH --&gt;&gt; ETL_Script: Confirmación de carga exitosa
    ETL_Script -&gt;&gt; Usuario: Finaliza proceso ETL y registra tiempo</code></pre>
<h2 id="etl">ETL<a class="headerlink" href="#etl" title="Permanent link">&para;</a></h2>
<h3 id="importacion-de-librerias-y-funciones">Importación de librerías y funciones<a class="headerlink" href="#importacion-de-librerias-y-funciones" title="Permanent link">&para;</a></h3>
<p>Este bloque de código configura el entorno para la conexión a bases de datos y el procesamiento de datos. Primero, se importan varias bibliotecas clave como SQLAlchemy, Pandas, y PyMySQL para manejar la conexión y la manipulación de datos, y <code>logging</code> para registrar eventos. Luego, se define la ruta para importar funciones personalizadas desde un archivo <code>Funciones.py</code>, ubicado en un directorio superior. Entre estas funciones se encuentran <code>StoreDuplicated</code>, <code>guardar_en_dwh</code>, <code>obtener_conexion</code>, <code>cargar_tablas</code>, <code>testfunciones</code>, y <code>setup_logger</code>, que permiten gestionar registros, establecer conexiones, y ejecutar operaciones de carga y almacenamiento en un Data Warehouse (DWH). Al final, <code>testfunciones()</code> es llamado para verificar la conexión o funcionalidad del módulo importado, lo que permite asegurar la correcta configuración antes de iniciar el procesamiento de datos.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="nn">sa</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">insert</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pymysql</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="c1">#---------------------------------------------</span>

<span class="c1">#Import de modulo funciones</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Agrega el directorio al sys.path</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;../funciones&#39;</span><span class="p">))</span>
<span class="c1"># Importa las funciones desde el archivo Funciones.py</span>
<span class="kn">from</span> <span class="nn">Funciones</span> <span class="kn">import</span> <span class="n">StoreDuplicated</span><span class="p">,</span> <span class="n">guardar_en_dwh</span><span class="p">,</span> <span class="n">obtener_conexion</span><span class="p">,</span> <span class="n">cargar_tablas</span><span class="p">,</span> <span class="n">testfunciones</span><span class="p">,</span> <span class="n">setup_logger</span>
<span class="nb">print</span><span class="p">(</span><span class="n">testfunciones</span><span class="p">())</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>Importacion de funciones correcta, 23-10-2024 15:06
</code></pre></div>

<h3 id="configuracion-inicial-del-logger">Configuración inicial del logger<a class="headerlink" href="#configuracion-inicial-del-logger" title="Permanent link">&para;</a></h3>
<p>Se configura el logger para registrar eventos del proceso ETL en el archivo <code>SubsidioVivienda.log</code>, utilizando el nivel de detalle <code>INFO</code>. También se registra el inicio del proceso, y se almacena la hora de inicio para medir el tiempo total de ejecución.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Configuración inicial</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="n">log_filename</span><span class="o">=</span><span class="s1">&#39;SubsidioVivienda.log&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;COMIENZO ETL&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-23 15:06:01,473 - INFO - COMIENZO ETL
</code></pre></div>

<h3 id="definicion-de-consultas-sql-para-extraccion-de-datos-de-vivienda">Definición de Consultas SQL para Extracción de Datos de Vivienda<a class="headerlink" href="#definicion-de-consultas-sql-para-extraccion-de-datos-de-vivienda" title="Permanent link">&para;</a></h3>
<p>Este código define un conjunto de consultas SQL organizadas en el diccionario <code>qr_structure</code>, que extraen y estructuran datos de varias tablas relacionadas con información de postulaciones de vivienda. Cada consulta (<code>"subvi02"</code>, <code>"subvi03"</code>, <code>"subvi04"</code>, <code>"subvi05"</code>, <code>"subvi06"</code>) selecciona un conjunto de campos específicos, normalizando el formato de las columnas para facilitar su integración en el análisis de datos. </p>
<p>Además, las consultas comparten un filtro común que limita los datos a los registros con un <code>periodo</code> dentro de los últimos 18 meses, usando <code>DATE_FORMAT</code> y <code>DATE_SUB</code> para establecer el rango de fechas en las condiciones <code>WHERE</code>. Varias de las subconsultas emplean <code>JOIN</code> para combinar registros de la tabla <code>subvi02</code> y asociar documentos de solicitud específicos con otros datos de las tablas adicionales.</p>
<p>Finalmente, el diccionario <code>dim_names</code> asocia cada clave de <code>qr_structure</code> con un nombre de tabla específico para facilitar su identificación en el procesamiento posterior, siendo este diseño ideal para organizar y cargar datos en un entorno de Data Warehouse.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Lista de querys</span>
<span class="n">qr_structure</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;subvi02&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;SELECT </span>
<span class="s1">                CONCAT(coddoc, cedpos) as ID_AFILIADO, </span>
<span class="s1">                periodo, </span>
<span class="s1">                documento as NUMERO_SOLICITUD,</span>
<span class="s1">                numrad as NUMERO_RADICADO,</span>
<span class="s1">                salario,</span>
<span class="s1">                porapo AS PORCENTAJE_APORTES,</span>
<span class="s1">                tippob AS TIPO_POBLACION,</span>
<span class="s1">                tippos AS TIPO_POSTULANTE,</span>
<span class="s1">                discap AS DISCAPACIDAD,</span>
<span class="s1">                cabhog AS CABEZA_HOGAR,</span>
<span class="s1">                numasi AS NUMERO_ASIGNACIONES,</span>
<span class="s1">                tipmad AS TIPO_MADRE,</span>
<span class="s1">                prioridad,</span>
<span class="s1">                estado,</span>
<span class="s1">                fecest AS FECHA_ESTADO,</span>
<span class="s1">                fecdig AS FECHA_DIGITACION,</span>
<span class="s1">                fecmod AS FECHA_MODIFICACION,</span>
<span class="s1">                fecact AS FECHA_ACTUALIZACION,</span>
<span class="s1">                nota</span>
<span class="s1">                FROM vivienda.subvi02</span>
<span class="s1">                WHERE DATE_FORMAT(STR_TO_DATE(periodo, &#39;%Y%m&#39;), &#39;%Y%m01&#39;) &gt; DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 18 MONTH), &#39;%Y%m01&#39;)              </span>
<span class="s1">                &#39;&#39;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;subvi03&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;SELECT </span>
<span class="s1">                documento as NUMERO_SOLICITUD,</span>
<span class="s1">                modsol AS MODALIDAD_SOLICITUD,</span>
<span class="s1">                tippro AS TIPO_PROYECTO,</span>
<span class="s1">                coddep AS COD_DEP,</span>
<span class="s1">                codciu AS COD_CIU,</span>
<span class="s1">                tipviv AS TIPO_VIVIENDA,</span>
<span class="s1">                valviv AS VALOR_VIVIENDA,</span>
<span class="s1">                valaho AS VALOR_AHORRO,</span>
<span class="s1">                valces AS VALOR_CESANTIAS,</span>
<span class="s1">                fecter AS FECHA_TERMINA_CONTRATO,</span>
<span class="s1">                totapo AS TOTAL_APORTES,</span>
<span class="s1">                fecini AS FECHA_INICIAL,</span>
<span class="s1">                totsub AS TOTAL_SUBSIDIO,</span>
<span class="s1">                totfin AS TOTAL_FINANCIADO</span>
<span class="s1">                FROM vivienda.subvi03 s03</span>
<span class="s1">                INNER JOIN (</span>
<span class="s1">                SELECT </span>
<span class="s1">                    periodo, </span>
<span class="s1">                    documento as NUMERO_SOLICITUD</span>
<span class="s1">                    FROM vivienda.subvi02</span>
<span class="s1">                    WHERE DATE_FORMAT(STR_TO_DATE(periodo, &#39;%Y%m&#39;), &#39;%Y%m01&#39;) &gt; DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 18 MONTH), &#39;%Y%m01&#39;)</span>
<span class="s1">                    ) AS s02 ON s03.documento = s02.NUMERO_SOLICITUD&#39;&#39;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;subvi04&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;SELECT</span>
<span class="s1">                documento as NUMERO_SOLICITUD,</span>
<span class="s1">                CONCAT(coddoc, numdoc) as ID_AFILIADO,</span>
<span class="s1">                priape AS PRIMER_APELLIDO,</span>
<span class="s1">                segape AS SEGUNDO_APELLIDO,</span>
<span class="s1">                prinom AS PRIMER_NOMBRE,</span>
<span class="s1">                segnom AS SEGUNDO_NOMBRE,</span>
<span class="s1">                fecnac AS FECHA_NACIMIENTO,</span>
<span class="s1">                numdoc AS NUMERO_DOCUMENTO,</span>
<span class="s1">                coddoc AS CODDOC,</span>
<span class="s1">                sexo,</span>
<span class="s1">                parent AS PARENTESCO,</span>
<span class="s1">                estciv AS ESTADO_CIVIL,</span>
<span class="s1">                discap AS DISCAPACIDAD,</span>
<span class="s1">                ingres AS INGRESOS_MENSUALES</span>
<span class="s1">                FROM vivienda.subvi04 s04</span>
<span class="s1">                INNER JOIN (</span>
<span class="s1">                SELECT </span>
<span class="s1">                    periodo, </span>
<span class="s1">                    documento as NUMERO_SOLICITUD</span>
<span class="s1">                    FROM vivienda.subvi02</span>
<span class="s1">                    WHERE DATE_FORMAT(STR_TO_DATE(periodo, &#39;%Y%m&#39;), &#39;%Y%m01&#39;) &gt; DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 18 MONTH), &#39;%Y%m01&#39;)</span>
<span class="s1">                    ) AS s02 ON s04.documento = s02.NUMERO_SOLICITUD</span>
<span class="s1">                &#39;&#39;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;subvi05&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;select </span>
<span class="s1">                documento as NUMERO_SOLICITUD,</span>
<span class="s1">                credito AS ESTADO_CREDITO,</span>
<span class="s1">                cueaho AS CUENTA_AHORROS,</span>
<span class="s1">                codban COD_BANCO,</span>
<span class="s1">                ciuban AS CIUDAD_BANCO,</span>
<span class="s1">                fecaho AS FECHA_AHORROS,</span>
<span class="s1">                fonces AS FONDO_CESANTIAS,</span>
<span class="s1">                fecces AS FECHA_CESANTIAS,</span>
<span class="s1">                fecini AS FECHA_INICIAL,</span>
<span class="s1">                ciufon AS CIUDAD_CESANTIAS</span>
<span class="s1">                FROM vivienda.subvi05 s05</span>
<span class="s1">                INNER JOIN (</span>
<span class="s1">                SELECT </span>
<span class="s1">                    periodo, </span>
<span class="s1">                    documento as NUMERO_SOLICITUD</span>
<span class="s1">                    FROM vivienda.subvi02</span>
<span class="s1">                    WHERE DATE_FORMAT(STR_TO_DATE(periodo, &#39;%Y%m&#39;), &#39;%Y%m01&#39;) &gt; DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 18 MONTH), &#39;%Y%m01&#39;)</span>
<span class="s1">                    ) AS s02 ON s05.documento = s02.NUMERO_SOLICITUD&#39;&#39;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;subvi06&quot;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;select </span>
<span class="s1">                documento as NUMERO_SOLICITUD,</span>
<span class="s1">                s06.periodo ,</span>
<span class="s1">                numasi AS NUMERO_ASIGNACIONES,</span>
<span class="s1">                fecasi AS FECHA_ASIGNACION, </span>
<span class="s1">                valaju AS VALOR_AJUSTE,</span>
<span class="s1">                valsub AS VALOR_SUBSIDIO,</span>
<span class="s1">                nota,</span>
<span class="s1">                estado,</span>
<span class="s1">                fecven AS FECHA_VENCIMIENTO,</span>
<span class="s1">                fecpag AS FECHA_PAGO,</span>
<span class="s1">                fecleg AS FECHA_LEGALIZACION,</span>
<span class="s1">                ruaf,</span>
<span class="s1">                ruasub,</span>
<span class="s1">                feccom AS FECHA_COMPRA</span>
<span class="s1">                FROM vivienda.subvi06 s06</span>
<span class="s1">                INNER JOIN (</span>
<span class="s1">                SELECT </span>
<span class="s1">                    periodo, </span>
<span class="s1">                    documento as NUMERO_SOLICITUD</span>
<span class="s1">                    FROM vivienda.subvi02</span>
<span class="s1">                    WHERE DATE_FORMAT(STR_TO_DATE(periodo, &#39;%Y%m&#39;), &#39;%Y%m01&#39;) &gt; DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 18 MONTH), &#39;%Y%m01&#39;)</span>
<span class="s1">                    ) AS s02 ON s06.documento = s02.NUMERO_SOLICITUD&#39;&#39;&#39;</span>
               <span class="p">}</span>
<span class="n">dim_names</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;subvi02&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Dim_Subvi_Postulacion&#39;</span><span class="p">,</span>
    <span class="s2">&quot;subvi03&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Dim_Subvi_Postulacion_Detalle&#39;</span><span class="p">,</span>
    <span class="s2">&quot;subvi04&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Fact_Subvi_Beneficiario&#39;</span><span class="p">,</span>
    <span class="s2">&quot;subvi05&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Fact_Subvi_Financiero&#39;</span><span class="p">,</span>
    <span class="s2">&quot;subvi06&quot;</span><span class="p">:</span><span class="s1">&#39;BD_Fact_Subvi_Resultado_Solicitud&#39;</span>
               <span class="p">}</span>
<span class="n">df_structure</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;LECTURA DE QUERYS&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-23 15:06:01,487 - INFO - LECTURA DE QUERYS
</code></pre></div>

<h3 id="conexion-y-carga-de-tablas-desde-sql">Conexión y carga de tablas desde SQL<a class="headerlink" href="#conexion-y-carga-de-tablas-desde-sql" title="Permanent link">&para;</a></h3>
<p>Este código se conecta a la base de datos Minerva y carga las tablas especificadas en <code>qr_structure</code> utilizando SQL. Para cada tabla, el proceso de carga es registrado en el <code>logger</code>, y al final se registra el tiempo total que tomó cargar todas las tablas desde MySQL. Esto permite monitorear la ejecución y duración del proceso de carga de datos.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Conexion a base Minerva</span>
<span class="n">motor</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">obtener_conexion</span><span class="p">(</span><span class="s1">&#39;minerva&#39;</span><span class="p">))</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CONEXION A BASE MINERVA&#39;</span><span class="p">)</span>
<span class="n">cargar_tablas</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="n">qr_structure</span><span class="p">,</span> <span class="n">df_structure</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-23 15:06:01,507 - INFO - CONEXION A BASE MINERVA
2024-10-23 15:06:01,865 - INFO - Cargando subvi02 
2024-10-23 15:06:02,063 - INFO - Cargada subvi02 --- 0.20 seconds ---
2024-10-23 15:06:02,063 - INFO - Cargando subvi03 
2024-10-23 15:06:02,205 - INFO - Cargada subvi03 --- 0.14 seconds ---
2024-10-23 15:06:02,206 - INFO - Cargando subvi04 
2024-10-23 15:06:02,352 - INFO - Cargada subvi04 --- 0.15 seconds ---
2024-10-23 15:06:02,353 - INFO - Cargando subvi05 
2024-10-23 15:06:02,403 - INFO - Cargada subvi05 --- 0.05 seconds ---
2024-10-23 15:06:02,405 - INFO - Cargando subvi06 
2024-10-23 15:06:02,453 - INFO - Cargada subvi06 --- 0.05 seconds ---
2024-10-23 15:06:02,509 - INFO - CARGUE TABLAS DESDE MYSQL --- subvi06 --- 1.00 seconds ---
</code></pre></div>

<h3 id="validador-de-campos-repetidos">Validador de campos repetidos<a class="headerlink" href="#validador-de-campos-repetidos" title="Permanent link">&para;</a></h3>
<p>Se verifica la presencia de registros duplicados en todas las tablas del diccionario <code>df_structure</code>. Las columnas utilizadas para comparar duplicados excluyen la columna <code>id</code>. Los duplicados detectados se almacenan utilizando la función <code>StoreDuplicated</code>, y luego se eliminan los duplicados de cada tabla con <code>drop_duplicates()</code>. El proceso se registra en el log para cada tabla, junto con el tiempo total del validador de duplicados.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Validador de campos repetidos </span>
<span class="n">validador_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">ky</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_structure</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>   
    <span class="n">ColumnsToCompare</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;id&#39;</span> <span class="p">]</span> <span class="p">]</span>
    <span class="n">StoreDuplicated</span><span class="p">(</span><span class="s1">&#39;N/A&#39;</span> <span class="p">,</span> <span class="n">ColumnsToCompare</span><span class="p">,</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">],</span> <span class="sa">r</span><span class="s1">&#39;trazaDuplicados_&#39;</span> <span class="o">+</span> <span class="n">ky</span> <span class="p">)</span>
    <span class="c1">#Limpieza inicial quitar duplicados</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;VALIDADOR TABLA: &#39;</span><span class="o">+</span> <span class="n">ky</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;VALIDADOR DUPLICADOS --- </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">validador_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> seconds ---&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-23 15:06:02,542 - INFO - VALIDADOR TABLA: subvi02
2024-10-23 15:06:02,551 - INFO - VALIDADOR TABLA: subvi03
2024-10-23 15:06:02,561 - INFO - VALIDADOR TABLA: subvi04
2024-10-23 15:06:02,568 - INFO - VALIDADOR TABLA: subvi05
2024-10-23 15:06:02,576 - INFO - VALIDADOR TABLA: subvi06
2024-10-23 15:06:02,577 - INFO - VALIDADOR DUPLICADOS --- 0.06 seconds ---
</code></pre></div>

<h3 id="transformacion-y-limpieza-de-texto">Transformación y limpieza de texto<a class="headerlink" href="#transformacion-y-limpieza-de-texto" title="Permanent link">&para;</a></h3>
<p>Se realiza una limpieza de las columnas de texto en cada tabla dentro de <code>df_structure</code>. Las columnas de texto se convierten a mayúsculas (<code>UPPER</code>), se eliminan los espacios en blanco al inicio y al final, y se reemplazan los valores <code>"NAN"</code> y <code>"NONE"</code> por valores nulos (<code>NaN</code>). El tiempo total de la operación se registra en el log.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Transformación 2</span>
<span class="n">limpieza_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">ky</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_structure</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="c1">#print(ky)</span>
    <span class="c1"># Convertir todos los nombres de las columnas a mayúsculas</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="c1">#Pasar las columnas tipo texto a UPPER</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="c1">#En las columnas tipo texto, eliminar espacios al comienzo y al final</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="c1">#Reemplazar los &quot;NAN&quot; o &quot;NONE&quot; por NaN</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;NAN&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_structure</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;NONE&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;LIMPIEZA --- </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">limpieza_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> seconds ---&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-23 15:06:02,656 - INFO - LIMPIEZA --- 0.07 seconds ---
</code></pre></div>

<h3 id="conexion-a-la-base-de-datos-dwh">Conexión a la base de datos DWH<a class="headerlink" href="#conexion-a-la-base-de-datos-dwh" title="Permanent link">&para;</a></h3>
<p>Se establece la conexión con la base de datos DWH utilizando la función <code>Conexion_dwh()</code> y se crea el motor de conexión con <code>create_engine()</code>. El evento de conexión exitosa se registra en el log.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#---------------------------------------------</span>
<span class="c1">#Conexion a base dwh</span>
<span class="n">motor2</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">obtener_conexion</span><span class="p">(</span><span class="s1">&#39;dwh&#39;</span><span class="p">))</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CONEXION A BASE DWH&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-23 15:06:02,662 - INFO - CONEXION A BASE DWH
</code></pre></div>

<h3 id="guardar-en-base-de-datos-dwh">Guardar en base de datos DWH<a class="headerlink" href="#guardar-en-base-de-datos-dwh" title="Permanent link">&para;</a></h3>
<p>Se guarda cada tabla del diccionario <code>df_structure</code> en la base de datos DWH, utilizando los nombres definidos en <code>dim_names</code>. Si las tablas ya existen en la base de datos, se reemplazan con los nuevos datos. El tiempo total de almacenamiento se registra en el log.</p>
<div class="highlight"><pre><span></span><code><span class="n">guardar_en_dwh</span><span class="p">(</span><span class="n">df_structure</span><span class="p">,</span> <span class="n">dim_names</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-23 15:06:02,668 - INFO - Intentando conexión a la base DWH...
2024-10-23 15:06:02,670 - INFO - Conexión a la base DWH establecida con éxito.
2024-10-23 15:06:02,962 - INFO - Almacenando tabla subvi02 en DWH como BD_Dim_Subvi_Postulacion
2024-10-23 15:06:04,064 - INFO - Tabla subvi02 almacenada correctamente como BD_Dim_Subvi_Postulacion.
2024-10-23 15:06:04,066 - INFO - Almacenando tabla subvi03 en DWH como BD_Dim_Subvi_Postulacion_Detalle
2024-10-23 15:06:04,954 - INFO - Tabla subvi03 almacenada correctamente como BD_Dim_Subvi_Postulacion_Detalle.
2024-10-23 15:06:04,955 - INFO - Almacenando tabla subvi04 en DWH como BD_Fact_Subvi_Beneficiario
2024-10-23 15:06:05,906 - INFO - Tabla subvi04 almacenada correctamente como BD_Fact_Subvi_Beneficiario.
2024-10-23 15:06:05,907 - INFO - Almacenando tabla subvi05 en DWH como BD_Fact_Subvi_Financiero
2024-10-23 15:06:06,578 - INFO - Tabla subvi05 almacenada correctamente como BD_Fact_Subvi_Financiero.
2024-10-23 15:06:06,579 - INFO - Almacenando tabla subvi06 en DWH como BD_Fact_Subvi_Resultado_Solicitud
2024-10-23 15:06:07,249 - INFO - Tabla subvi06 almacenada correctamente como BD_Fact_Subvi_Resultado_Solicitud.
2024-10-23 15:06:07,313 - INFO - ALMACENAMIENTO ---  --- 4.65 seconds ---
2024-10-23 15:06:07,314 - INFO - Finalizando proceso de almacenamiento en DWH.
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;FINAL ETL --- </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> seconds ---&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>2024-10-23 15:06:07,324 - INFO - FINAL ETL --- 5.86 seconds ---
</code></pre></div>

<div class="highlight"><pre><span></span><code>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="../../js/init_mermaid.js"></script>
      
    
  </body>
</html>